<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Xem K·∫øt Qu·∫£ EPA</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #007bff; color: white; }
    .highlight { font-weight: bold; color: #007bff; }
    .assessment-entry { margin-bottom: 10px; }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .btn {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
    }
    .btn:hover {
      background-color: #0056b3;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <div class="top-bar">
    <h2>üîç K·∫øt Qu·∫£ ƒê√°nh Gi√° EPA</h2>
    <div>
      <button class="btn" onclick="location.href='/employees'">üè† Trang ch√≠nh</button>
      <button class="btn" onclick="exportToPDF()">üìÑ Xu·∫•t file PDF</button>
    </div>
  </div>

  <p><strong>T√†i kho·∫£n:</strong> <span id="ten_tk_display"></span></p>
  <label>NƒÉm:
    <select id="year" onchange="loadMonthsForYear()"></select>
  </label>
  <label>Th√°ng:
    <select id="month"></select>
  </label>
  <button class="btn" onclick="triggerReload()">Xem K·∫øt Qu·∫£</button>

  <div id="content-to-export">
    <div id="last-assessment" style="margin-top: 20px;"></div>

    <h3>T·ªïng ƒêi·ªÉm</h3>
    <table>
      <thead>
        <tr>
          <th>NƒÉm</th><th>Th√°ng</th><th>Ng∆∞·ªùi D√πng</th><th>T·ªï Tr∆∞·ªüng</th><th>Hi·ªáu Tr∆∞·ªüng</th><th>Nh·∫≠n X√©t</th>
        </tr>
      </thead>
      <tbody id="total-score-table-body">
        <tr><td colspan="6">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    let ten_tk = "";

    document.addEventListener("DOMContentLoaded", async () => {
      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth() + 1;

      const urlParams = new URLSearchParams(window.location.search);
      const yearParam = parseInt(urlParams.get("year")) || currentYear;
      const monthParam = parseInt(urlParams.get("month")) || currentMonth;
      ten_tk = urlParams.get("ten_tk") || "";

      document.getElementById("ten_tk_display").innerText = ten_tk;

      await loadYears(yearParam);
      await loadMonthsForYear(yearParam, monthParam);

      if (ten_tk) {
        loadEPA(yearParam, monthParam, ten_tk);
      } else {
        alert("Kh√¥ng c√≥ t√™n t√†i kho·∫£n trong URL!");
      }
    });

    async function loadYears(selectedYear = null) {
      const res = await fetch('/api/epa-available-years');
      const data = await res.json();
      const yearSelect = document.getElementById("year");
      yearSelect.innerHTML = "";

      data.years.forEach(y => {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        if (parseInt(y) === parseInt(selectedYear)) opt.selected = true;
        yearSelect.appendChild(opt);
      });
    }

    async function loadMonthsForYear(year = null, selectedMonth = null) {
      year = year || document.getElementById("year").value;
      const res = await fetch(`/api/epa-available-months?year=${year}`);
      const data = await res.json();
      const monthSelect = document.getElementById("month");
      monthSelect.innerHTML = "";

      data.months.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        if (parseInt(m) === parseInt(selectedMonth)) opt.selected = true;
        monthSelect.appendChild(opt);
      });
    }

    function triggerReload() {
      const year = document.getElementById("year").value;
      const month = document.getElementById("month").value;
      if (!ten_tk) {
        alert("Kh√¥ng c√≥ t√™n t√†i kho·∫£n!");
        return;
      }
      loadEPA(year, month, ten_tk);
    }

    async function loadEPA(year, month, ten_tk) {
      try {
        const response = await fetch(`/api/last-assessment?year=${year}&month=${month}&ten_tk=${ten_tk}`);
        const data = await response.json();

        const assessmentDiv = document.getElementById('last-assessment');
        const totalScoreTableBody = document.getElementById('total-score-table-body');

        if (data.assessments && data.assessments.length > 0) {
          assessmentDiv.innerHTML = data.assessments.map(a => `
            <div class="assessment-entry">
              <p class="highlight">NƒÉm: ${a.year}, Th√°ng: ${a.month}</p>
              <p><strong>C√¢u h·ªèi:</strong> ${a.translate}</p>
              <p><strong>ƒêi·ªÉm t·ª± ch·∫•m:</strong> ${a.user_score || 'N/A'}</p>
              <p><strong>ƒêi·ªÉm t·ªï tr∆∞·ªüng:</strong> ${a.sup_score || 'Ch∆∞a ch·∫•m'}</p>
              <p><strong>√ù ki·∫øn c√° nh√¢n:</strong> ${a.user_comment || 'Kh√¥ng c√≥ √Ω ki·∫øn'}</p>
              <p><strong>√ù ki·∫øn t·ªï tr∆∞·ªüng:</strong> ${a.sup_comment || 'Kh√¥ng c√≥ √Ω ki·∫øn'}</p>
            </div>
          `).join('<hr>');
        } else {
          assessmentDiv.innerHTML = '<p style="color:red;">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë√°nh gi√°!</p>';
        }

        if (data.total_score) {
          const s = data.total_score;
          totalScoreTableBody.innerHTML = `
            <tr>
              <td>${s.year}</td>
              <td>${s.month}</td>
              <td>${s.user_total_score || 0}</td>
              <td>${s.sup_total_score || 0}</td>
              <td>${s.pri_total_score || 'Ch∆∞a c√≥'}</td>
              <td>${s.pri_comment || 'Ch∆∞a c√≥'}</td>
            </tr>
          `;
        } else {
          totalScoreTableBody.innerHTML = '<tr><td colspan="6">Kh√¥ng t√¨m th·∫•y t·ªïng ƒëi·ªÉm.</td></tr>';
        }
      } catch (err) {
        console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", err);
        document.getElementById('last-assessment').innerHTML = '<p class="error">H√£y ho√†n th√†nh b·∫£ng ƒë√°nh gi√° th√°ng.</p>';
        document.getElementById('total-score-table-body').innerHTML = '<tr><td colspan="6">L·ªói khi t·∫£i t·ªïng ƒëi·ªÉm.</td></tr>';
      }
    }

    function exportToPDF() {
      const element = document.getElementById("content-to-export");
      const opt = {
        margin: 0.5,
        filename: `epa_danhgia_${ten_tk}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(element).save();
    }
  </script>
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const urlParams = new URLSearchParams(window.location.search);
    const ten_tk = urlParams.get("ten_tk");
    const year = urlParams.get("year");
    const month = urlParams.get("month");

    if (ten_tk && year && month) {
      fetch(`/api/last-assessment?ten_tk=${ten_tk}&year=${year}&month=${month}`)
        .then(res => res.json())
        .then(data => {
          // X·ª≠ l√Ω hi·ªÉn th·ªã d·ªØ li·ªáu ƒë√°nh gi√° ·ªü ƒë√¢y
          console.log(data);
          document.getElementById("ten_tk_display").textContent = ten_tk;
          document.getElementById("month_display").textContent = `${month}/${year}`;
          // v·∫Ω b·∫£ng chi ti·∫øt t·ª´ d·ªØ li·ªáu `data`
        });
    }
  });
</script>
</body>
</html>
