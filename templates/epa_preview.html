<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="utf-8"/>
<title>Xem K·∫øt Qu·∫£ EPA</title>
<link href="{{ url_for('static_files', filename='css/styles.css') }}?v=20250716" rel="stylesheet"/>

<style>
.assessment-entry {
  border: 1px solid #ddd;
  padding: 15px;
  margin: 10px 0;
  border-radius: 8px;
  background-color: #f9f9f9;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.question-content {
  background-color: white;
  padding: 15px;
  border-left: 4px solid #0066cc;
  margin-bottom: 15px;
  border-radius: 4px;
  font-size: 14px;
  line-height: 1.5;
}

.score-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-bottom: 15px;
}

.comment-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

.score-item {
  padding: 10px;
  border-radius: 6px;
  text-align: center;
}

.self-score {
  background-color: #d4edda;
  border: 1px solid #c3e6cb;
}

.sup-score {
  background-color: #fff3cd;
  border: 1px solid #ffeaa7;
}

.comment-item {
  padding: 15px;
  border-radius: 6px;
  font-size: 15px;
  line-height: 1.6;
}

.self-comment {
  background-color: #e8f5e8;
  border: 1px solid #c3e6cb;
}

.sup-comment {
  background-color: #fff3cd;
  border: 1px solid #ffeaa7;
}

@media (max-width: 768px) {
  .score-grid, .comment-grid {
    grid-template-columns: 1fr;
  }
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body><div class="container-fluid mt-4"><div class="card"><div class="card-body">
<div class="top-bar">
<h2>üîç K·∫øt Qu·∫£ ƒê√°nh Gi√° EPA</h2>
<div>
<button class="btn" onclick="location.href='/employees'">üè† Trang ch√≠nh</button>
<button class="btn" onclick="exportToPDF()">üìÑ Xu·∫•t file PDF</button>
</div>
</div>
<p><strong>T√†i kho·∫£n:</strong> <span id="ten_tk_display"></span></p>
<label>NƒÉm:
    <select id="year" onchange="loadMonthsForYear()"></select>
</label>
<label>Th√°ng:
    <select id="month"></select>
</label>
<button class="btn" onclick="triggerReload()">Xem K·∫øt Qu·∫£</button>
<div id="content-to-export">
<div id="last-assessment" style="margin-top: 20px;"></div>
<h3>T·ªïng ƒêi·ªÉm</h3>
<table>
<thead>
<tr>
<th>NƒÉm</th><th>Th√°ng</th><th>Ng∆∞·ªùi D√πng</th><th>T·ªï Tr∆∞·ªüng</th><th>Hi·ªáu Tr∆∞·ªüng</th><th>Nh·∫≠n X√©t</th>
</tr>
</thead>
<tbody id="total-score-table-body">
<tr><td colspan="6">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
</tbody>
</table>
</div>
<script>
    let ten_tk = "";

    document.addEventListener("DOMContentLoaded", async () => {
      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth() + 1;

      const urlParams = new URLSearchParams(window.location.search);
      const yearParam = parseInt(urlParams.get("year")) || currentYear;
      const monthParam = parseInt(urlParams.get("month")) || currentMonth;
      ten_tk = urlParams.get("ten_tk") || "";

      document.getElementById("ten_tk_display").innerText = ten_tk;

      await loadYears(yearParam);
      await loadMonthsForYear(yearParam, monthParam);

      if (ten_tk) {
        loadEPA(yearParam, monthParam, ten_tk);
      } else {
        alert("Kh√¥ng c√≥ t√™n t√†i kho·∫£n trong URL!");
      }
    });

    async function loadYears(selectedYear = null) {
      const res = await fetch('/api/epa-available-years');
      const data = await res.json();
      const yearSelect = document.getElementById("year");
      yearSelect.innerHTML = "";

      data.years.forEach(y => {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        if (parseInt(y) === parseInt(selectedYear)) opt.selected = true;
        yearSelect.appendChild(opt);
      });
    }

    async function loadMonthsForYear(year = null, selectedMonth = null) {
      year = year || document.getElementById("year").value;
      const res = await fetch(`/api/epa-available-months?year=${year}`);
      const data = await res.json();
      const monthSelect = document.getElementById("month");
      monthSelect.innerHTML = "";

      data.months.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        if (parseInt(m) === parseInt(selectedMonth)) opt.selected = true;
        monthSelect.appendChild(opt);
      });
    }

    function triggerReload() {
      const year = document.getElementById("year").value;
      const month = document.getElementById("month").value;
      if (!ten_tk) {
        alert("Kh√¥ng c√≥ t√™n t√†i kho·∫£n!");
        return;
      }
      loadEPA(year, month, ten_tk);
    }

    async function loadEPA(year, month, ten_tk) {
      try {
        const response = await fetch(`/api/last-assessment?year=${year}&month=${month}&ten_tk=${ten_tk}`);
        const data = await response.json();

        const assessmentDiv = document.getElementById('last-assessment');
        const totalScoreTableBody = document.getElementById('total-score-table-body');

        if (data.assessments && data.assessments.length > 0) {
          assessmentDiv.innerHTML = `
            <h3>Chi Ti·∫øt ƒê√°nh Gi√°</h3>
            <p class="highlight">NƒÉm: ${data.assessments[0].year}, Th√°ng: ${data.assessments[0].month}</p>
            ${data.assessments.map((a, index) => `
              <div class="assessment-entry">
                <div style="font-weight: bold; color: #0066cc; margin-bottom: 10px; font-size: 16px;">
                  üìã C√¢u ${index + 1}
                </div>
                <div class="question-content">
                  <strong>N·ªôi dung c√¢u h·ªèi:</strong><br>
                  ${a.question || a.translate || 'Kh√¥ng c√≥ n·ªôi dung c√¢u h·ªèi'}
                </div>
                <div class="score-grid">
                  <div class="score-item self-score">
                    <strong>ƒêi·ªÉm t·ª± ch·∫•m</strong><br>
                    <span style="font-size: 24px; font-weight: bold; color: #28a745;">${a.user_score || 'N/A'}</span>
                  </div>
                  <div class="score-item sup-score">
                    <strong>ƒêi·ªÉm t·ªï tr∆∞·ªüng</strong><br>
                    <span style="font-size: 24px; font-weight: bold; color: #856404;">${a.sup_score || 'Ch∆∞a ch·∫•m'}</span>
                  </div>
                </div>
                <div class="comment-grid">
                  <div class="comment-item self-comment">
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px; color: #155724;">
                      üí≠ √ù ki·∫øn c√° nh√¢n:
                    </div>
                    <div style="font-size: 15px; line-height: 1.6;">
                      ${a.user_comment || 'Kh√¥ng c√≥ √Ω ki·∫øn'}
                    </div>
                  </div>
                  <div class="comment-item sup-comment">
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px; color: #856404;">
                      üë• √ù ki·∫øn t·ªï tr∆∞·ªüng:
                    </div>
                    <div style="font-size: 15px; line-height: 1.6;">
                      ${a.sup_comment || 'Kh√¥ng c√≥ √Ω ki·∫øn'}
                    </div>
                  </div>
                </div>
              </div>
            `).join('')}
          `;
        } else {
          assessmentDiv.innerHTML = '<p style="color:red;">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë√°nh gi√°!</p>';
        }

        if (data.total_score) {
          const s = data.total_score;
          totalScoreTableBody.innerHTML = `
            <tr>
              <td>${s.year}</td>
              <td>${s.month}</td>
              <td>${s.user_total_score || 0}</td>
              <td>${s.sup_total_score || 0}</td>
              <td>${s.pri_total_score || 'Ch∆∞a c√≥'}</td>
              <td>${s.pri_comment || 'Ch∆∞a c√≥'}</td>
            </tr>
          `;
        } else {
          totalScoreTableBody.innerHTML = '<tr><td colspan="6">Kh√¥ng t√¨m th·∫•y t·ªïng ƒëi·ªÉm.</td></tr>';
        }
      } catch (err) {
        console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", err);
        document.getElementById('last-assessment').innerHTML = '<p class="error">H√£y ho√†n th√†nh b·∫£ng ƒë√°nh gi√° th√°ng.</p>';
        document.getElementById('total-score-table-body').innerHTML = '<tr><td colspan="6">L·ªói khi t·∫£i t·ªïng ƒëi·ªÉm.</td></tr>';
      }
    }

    function exportToPDF() {
      const element = document.getElementById("content-to-export");
      const opt = {
        margin: 0.5,
        filename: `epa_danhgia_${ten_tk}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(element).save();
    }
  </script>
</div></div></div></body>
</html>
