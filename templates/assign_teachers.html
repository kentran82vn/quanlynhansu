<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>G√°n Gi√°o Vi√™n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static_files', filename='css/styles.css') }}?v=20250707">
</head>
<body>
<div class="container-fluid py-5">
  <div class="card shadow animate__animated animate__fadeIn">
    <div class="card-header bg-warning d-flex justify-content-between align-items-center">
      <h5 class="mb-0 text-dark"><i class="bi bi-person-lines-fill me-2"></i>G√°n Gi√°o Vi√™n Cho L·ªõp</h5>
      <span class="badge bg-dark text-warning">#GiangDay</span>
    </div>
    <div class="card-body">
      <form id="assign-teacher-form" class="row g-3 align-items-center">
        <div class="col-md-4">
          <label class="form-label fw-semibold">Ch·ªçn Gi√°o Vi√™n</label>
          <select id="ma_gv" class="form-select"></select>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold">Ch·ªçn L·ªõp</label>
          <select id="ma_lop" class="form-select"></select>
        </div>
        <div class="col-md-3">
          <label class="form-label fw-semibold">Vai Tr√≤</label>
          <select id="vai_tro" class="form-select">
            <option value="GVCN">GVCN</option>
            <option value="B·ªô m√¥n">B·ªô m√¥n</option>
            <option value="B·∫£o m·∫´u">B·∫£o m·∫´u</option>
          </select>
        </div>
        <div class="col-md-1 d-grid pt-4">
          <button type="submit" class="btn btn-warning"><i class="bi bi-person-plus-fill"></i></button>
        </div>
      </form>
    </div>
  </div>
  <!-- ‚úÖ B·∫£ng danh s√°ch gi√°o vi√™n ƒë√£ g√°n -->
  <div class="mt-5">
    <h5 class="mb-3 text-primary">üìã Danh s√°ch gi√°o vi√™n ƒë√£ g√°n</h5>
    <div class="table-responsive">
      <table class="table table-bordered table-striped text-center">
        <thead class="table-warning">
          <tr>
            <th>STT</th>
            <th onclick="sortTable('ma_gv')">M√£ GV</th>
            <th onclick="sortTable('ho_va_ten')">H·ªç v√† T√™n</th>
            <th onclick="sortTable('chuc_vu')">Ch·ª©c V·ª•</th>
            <th onclick="sortTable('ten_lop')">T√™n L·ªõp</th>
            <th onclick="sortTable('vai_tro')">Vai Tr√≤</th>
            <th>H√†nh ƒê·ªông</th>
          </tr>
        </thead>
        <tbody id="assignmentsTable"></tbody>
      </table>
    </div>
  </div>
</div>
<script>
window.onload = async () => {
  const gv = await (await fetch('/api/teachers')).json();
  const lop = await (await fetch('/api/classes')).json();
  gv.forEach(g => {
    ma_gv.innerHTML += `<option value="${g.ma_gv}">${g.ho_va_ten}</option>`;
  });
  lop.forEach(l => {
    ma_lop.innerHTML += `<option value="${l.ma_lop}">${l.ten_lop}</option>`;
  });
};
document.getElementById('assign-teacher-form').onsubmit = async function(e) {
  e.preventDefault();
  const res = await fetch('/api/assign-teacher', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      ma_lop: ma_lop.value,
      ma_gv: ma_gv.value,
      vai_tro: vai_tro.value
    })
  });
  if (res.ok) alert("üéâ G√°n gi√°o vi√™n th√†nh c√¥ng!");
};
</script>
<script>
  let sortState = { field: null, asc: true };

  function sortTable(field) {
    if (sortState.field === field) {
      sortState.asc = !sortState.asc;
    } else {
      sortState.field = field;
      sortState.asc = true;
    }
    loadAssignments(); // G·ªçi l·∫°i b·∫£ng ƒë√£ sort
  }
  const assignmentsTable = document.getElementById('assignmentsTable');
  let classOptions = [];

  async function loadAssignments() {
    const res = await fetch('/api/assigned-teachers');  // backend tr·∫£ v·ªÅ danh s√°ch ƒë√£ g√°n
    const data = await res.json();
    assignmentsTable.innerHTML = '';
    // S·∫Øp x·∫øp tr∆∞·ªõc khi render
    if (sortState.field) {
      data.sort((a, b) => {
        const valA = (a[sortState.field] || "").toString().toLowerCase();
        const valB = (b[sortState.field] || "").toString().toLowerCase();
        if (valA < valB) return sortState.asc ? -1 : 1;
        if (valA > valB) return sortState.asc ? 1 : -1;
        return 0;
      });
    }
    data.forEach((item, index) => {
      assignmentsTable.innerHTML += `
        <tr>
          <td>${index + 1}</td>
          <td>${item.ma_gv}</td>
          <td>${item.ho_va_ten}</td>
          <td>${item.chuc_vu}</td>
          <td>
            <select onchange="updateField('${item.ma_gv}', 'ma_lop', this.value)">
              ${classOptions.map(c => `<option value="${c.ma_lop}" ${c.ten_lop === item.ten_lop ? 'selected' : ''}>${c.ten_lop}</option>`).join('')}
            </select>
          </td>
          <td>
            <select onchange="updateField('${item.ma_gv}', 'vai_tro', this.value)">
              ${['GVCN','B·ªô m√¥n','B·∫£o m·∫´u'].map(v => `<option ${v === item.vai_tro ? 'selected' : ''}>${v}</option>`).join('')}
            </select>
          </td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="deleteAssignment('${item.ma_gv}', '${item.ma_lop}')">üóëÔ∏è X√≥a</button>
          </td>
        </tr>
      `;
    });
  }

  async function updateField(ma_gv, field, value) {
    if (!confirm("X√°c nh·∫≠n thay ƒë·ªïi th√¥ng tin?")) return;
    await fetch('/api/update-assignment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ma_gv, field, value })
    });
    loadAssignments();
  }

  async function deleteAssignment(ma_gv, ma_lop) {
    if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° ph√¢n c√¥ng n√†y?")) return;
    await fetch('/api/delete-assignment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ma_gv, ma_lop })
    });
    loadAssignments();
  }

  // C·∫≠p nh·∫≠t window.onload ƒë·ªÉ ƒë·ªìng b·ªô classOptions
  window.onload = async () => {
    const gv = await (await fetch('/api/teachers')).json();
    const lop = await (await fetch('/api/classes')).json();
    classOptions = lop;
    gv.forEach(g => {
      ma_gv.innerHTML += `<option value="${g.ma_gv}">${g.ho_va_ten}</option>`;
    });
    lop.forEach(l => {
      ma_lop.innerHTML += `<option value="${l.ma_lop}">${l.ten_lop}</option>`;
    });
    loadAssignments();  // ‚úÖ load b·∫£ng ngay sau khi trang t·∫£i
  };
</script>
</body>
</html>