<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Ph√¢n L·ªõp H·ªçc Sinh</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static_files', filename='css/styles.css') }}?v=20250707">
</head>
<body>
  <div class="container mt-4">
    <div class="header">
      <h4><i class="bi bi-list-ul"></i> Danh s√°ch h·ªçc sinh theo l·ªõp</h4>
    </div>

    <!-- Dropdown ch·ªçn M√£ L·ªõp -->
    <div class="mb-4">
      <label for="selectClass" class="form-label fw-semibold">Ch·ªçn M√£ L·ªõp</label>
      <select id="selectClass" class="form-select w-50" onchange="filterByClass()">
        <option value="All">-- T·∫•t c·∫£ h·ªçc sinh --</option>
      </select>
    </div>

    <!-- B·∫£ng th√¥ng tin h·ªçc sinh -->
    <div class="table-responsive">
      <table class="table table-bordered table-striped">
        <thead class="table-light text-center">
          <tr>
            <th>STT</th>
            <th onclick="sortBy('ma_hs')">M√£ HS</th>
            <th onclick="sortBy('ho_va_ten')">H·ªç v√† T√™n</th>
            <th onclick="sortBy('ma_lop')">M√£ L·ªõp</th>
            <th onclick="sortBy('ten_lop')">T√™n L·ªõp</th>
            <th onclick="sortBy('ngay_sinh')">Ng√†y Sinh</th>
            <th onclick="sortBy('gioi_tinh')">Gi·ªõi T√≠nh</th>
            <th onclick="sortBy('ma_dinh_danh')">M√£ ƒê·ªãnh Danh</th>
          </tr>
        </thead>
        <tbody id="studentTableBody">
          <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript -->
        </tbody>
      </table>
    </div>
  </div>
  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let allStudents = [];
    let classList = [];
    let currentSort = {
      key: null,
      direction: 'asc' // or 'desc'
    };

    function sortBy(columnKey) {
      if (currentSort.key === columnKey) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.key = columnKey;
        currentSort.direction = 'asc';
      }

      const sorted = [...allStudents].sort((a, b) => {
        let valA = a[columnKey] || "";
        let valB = b[columnKey] || "";

        // Chuy·ªÉn ng√†y th√†nh Date ƒë·ªÉ so s√°nh n·∫øu l√† 'ngay_sinh'
        if (columnKey === 'ngay_sinh') {
          valA = new Date(valA);
          valB = new Date(valB);
        } else {
          valA = valA.toString().toLowerCase();
          valB = valB.toString().toLowerCase();
        }

        if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
        if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
      });

      renderStudents(sorted);
    }
    function populateClassDropdown() {
      const select = document.getElementById("selectClass");
      classList.forEach(cls => {
        const option = document.createElement("option");
        option.value = cls.ma_lop;
        option.textContent = cls.ma_lop;
        select.appendChild(option);
      });
    }

    function filterByClass() {
      const selectedMaLop = document.getElementById("selectClass").value;
      if (selectedMaLop === "All") {
        renderStudents(allStudents);
      } else {
        const filtered = allStudents.filter(s => s.ma_lop === selectedMaLop);
        renderStudents(filtered);
      }
    }

    function renderStudents(data) {
      const tbody = document.getElementById("studentTableBody");
      tbody.innerHTML = data.map((s, index) => {
        const options = classList.map(c => `
          <option value="${c.ma_lop}" ${s.ma_lop === c.ma_lop ? "selected" : ""}>${c.ma_lop}</option>
        `).join("");

        return `
          <tr data-ma-hs="${s.ma_hs}">
            <td>${index + 1}</td>
            <td>${s.ma_hs}</td>
            <td>${s.ho_va_ten}</td>
            <td>
              <select class="form-select form-select-sm editable-ma-lop" onchange="updateStudentClass(this)">
                ${options}
              </select>
            </td>
            <td class="ten-lop-cell">${s.ten_lop || ""}</td>
            <td>${s.ngay_sinh || ""}</td>
            <td>${s.gioi_tinh || ""}</td>
            <td>${s.ma_dinh_danh || ""}</td>
          </tr>
        `;
      }).join("");
    }

    async function updateStudentClass(selectEl) {
      const newMaLop = selectEl.value;
      const row = selectEl.closest("tr");
      const ma_hs = row.dataset.maHs;

      const lop = classList.find(c => c.ma_lop === newMaLop);
      if (!lop) {
        alert("‚ùå M√£ l·ªõp kh√¥ng h·ª£p l·ªá!");
        return;
      }

      const confirmChange = confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën ƒë·ªïi m√£ l·ªõp c·ªßa h·ªçc sinh ${ma_hs} th√†nh ${newMaLop} kh√¥ng?`);
      if (!confirmChange) {
        return;
      }

      const res = await fetch("/api/update-student-class", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ma_hs, ma_lop: newMaLop })
      });

      if (res.ok) {
        alert(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t l·ªõp cho ${ma_hs} th√†nh c√¥ng`);
        await loadData(); // üîÅ L√†m m·ªõi l·∫°i to√†n b·ªô d·ªØ li·ªáu hi·ªÉn th·ªã
        // Gi·ªØ filter n·∫øu ƒëang ch·ªçn m√£ l·ªõp
        filterByClass();
      } else {
        alert("‚ùå Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t v√†o c∆° s·ªü d·ªØ li·ªáu.");
      }
    }

    async function loadData() {
      const [studentsRes, classesRes] = await Promise.all([
        fetch("/api/students"),
        fetch("/api/classes")
      ]);
      allStudents = await studentsRes.json();
      classList = await classesRes.json();
      
      // L√†m m·ªõi dropdown m√£ l·ªõp
      const select = document.getElementById("selectClass");
      const currentSelected = select.value || "All";
      select.innerHTML = `<option value="All">-- T·∫•t c·∫£ h·ªçc sinh --</option>`;
      classList.forEach(cls => {
        const opt = document.createElement("option");
        opt.value = cls.ma_lop;
        opt.textContent = cls.ma_lop;
        if (cls.ma_lop === currentSelected) opt.selected = true;
        select.appendChild(opt);
      });

      filterByClass();
    }


    window.onload = loadData;
  </script>

</body>
</html>
