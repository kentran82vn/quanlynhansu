<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìä T·ªïng H·ª£p K·∫øt Qu·∫£ ƒê√°nh Gi√° EPA - Tr∆∞·ªùng M·∫ßm Non Hoa H∆∞·ªõng D∆∞∆°ng</title>
  
  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  
  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  
  <!-- Custom CSS -->
  <link href="{{ url_for('static_files', filename='css/modern.css') }}" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Inter', var(--font-family-sans);
      background: var(--bg-secondary);
    }
    
    .page-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: white;
      padding: var(--spacing-xl);
      border-radius: var(--border-radius-lg);
      margin-bottom: var(--spacing-lg);
      text-align: center;
    }
    
    .page-title {
      font-size: var(--text-3xl);
      font-weight: var(--font-bold);
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
    }
    
    .page-subtitle {
      font-size: var(--text-base);
      opacity: 0.9;
      margin-top: var(--spacing-sm);
    }
    
    .chart-card {
      background: var(--bg-primary);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-lg);
    }
    
    .chart-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-sm);
      border-bottom: 2px solid var(--gray-200);
    }
    
    .chart-controls {
      background: var(--bg-tertiary);
      padding: var(--spacing-lg);
      border-radius: var(--border-radius);
      margin-bottom: var(--spacing-lg);
    }
    
    .chart-container {
      position: relative;
      height: 400px;
      margin-top: var(--spacing-lg);
    }
    
    .summary-chart-container {
      position: relative;
      height: 250px;
      margin-bottom: var(--spacing-lg);
    }
    
    .summary-month-title {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--primary-color);
      margin-bottom: var(--spacing-md);
      padding: var(--spacing-sm);
      background: var(--bg-accent);
      border-radius: var(--border-radius);
    }
    
    .form-controls-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
    }
    
    .control-label {
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }
    
    .chart-btn {
      width: 100%;
      padding: var(--spacing-sm) var(--spacing-md);
      font-weight: var(--font-medium);
      border-radius: var(--border-radius);
      border: none;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-xs);
    }
    
    .chart-btn-primary {
      background: var(--primary-color);
      color: white;
    }
    
    .chart-btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    .chart-btn-secondary {
      background: var(--info-color);
      color: white;
    }
    
    .chart-btn-secondary:hover {
      background: #0e7490;
      transform: translateY(-1px);
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .page-title {
        font-size: var(--text-2xl);
        flex-direction: column;
        text-align: center;
      }
      
      .chart-container {
        height: 300px;
      }
      
      .summary-chart-container {
        height: 200px;
      }
      
      .form-controls-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <h1 class="page-title">
        <i class="fas fa-chart-line"></i>
        T·ªïng H·ª£p K·∫øt Qu·∫£ ƒê√°nh Gi√° EPA
      </h1>
      <p class="page-subtitle">Ph√¢n t√≠ch v√† th·ªëng k√™ k·∫øt qu·∫£ ƒë√°nh gi√° nh√¢n vi√™n theo th·ªùi gian</p>
    </div>
    <!-- Charts Grid -->
    <div class="row">
      <!-- Individual Assessment Chart -->
      <div class="col-md-6">
        <div class="chart-card">
          <div class="chart-header">
            <i class="fas fa-user-chart"></i>
            ƒêi·ªÉm ƒê√°nh Gi√° C√° Nh√¢n Theo NƒÉm
          </div>
          
          <div class="chart-controls">
            <form class="form-controls-row" onsubmit="event.preventDefault(); loadChart();">
              <div class="control-group">
                <label class="control-label" for="ten_tk">
                  <i class="fas fa-user"></i>
                  T√™n t√†i kho·∫£n
                </label>
                <select class="form-control" id="ten_tk" required>
                  <option value="">-- Ch·ªçn t√†i kho·∫£n --</option>
                </select>
              </div>
              
              <div class="control-group">
                <label class="control-label" for="year">
                  <i class="fas fa-calendar-alt"></i>
                  NƒÉm
                </label>
                <input class="form-control" id="year" type="number" value="2025" required>
              </div>
              
              <div class="control-group">
                <label class="control-label">&nbsp;</label>
                <button class="chart-btn chart-btn-primary" onclick="loadChart()" type="button">
                  <i class="fas fa-chart-bar"></i>
                  Hi·ªÉn Th·ªã Bi·ªÉu ƒê·ªì
                </button>
              </div>
            </form>
          </div>
          
          <div class="chart-container">
            <canvas id="epaChart"></canvas>
          </div>
        </div>
      </div>
      
      <!-- Summary Assessment Chart -->
      <div class="col-md-6">
        <div class="chart-card">
          <div class="chart-header">
            <i class="fas fa-chart-line"></i>
            ƒêi·ªÉm ƒê√°nh Gi√° T·ªïng H·ª£p C√°c Th√°ng
          </div>
          
          <div class="chart-controls">
            <form class="form-controls-row" onsubmit="event.preventDefault(); loadSummary();">
              <div class="control-group">
                <label class="control-label" for="summaryYear">
                  <i class="fas fa-calendar-alt"></i>
                  NƒÉm
                </label>
                <input class="form-control" id="summaryYear" type="number" value="2025" required>
              </div>
              
              <div class="control-group">
                <label class="control-label" for="summaryMonth">
                  <i class="fas fa-calendar-day"></i>
                  Th√°ng
                </label>
                <select class="form-control" id="summaryMonth">
                  <option value="All">T·∫•t c·∫£</option>
                  <option value="1">Th√°ng 1</option>
                  <option value="2">Th√°ng 2</option>
                  <option value="3">Th√°ng 3</option>
                  <option value="4">Th√°ng 4</option>
                  <option value="5">Th√°ng 5</option>
                  <option value="6">Th√°ng 6</option>
                  <option value="7">Th√°ng 7</option>
                  <option value="8">Th√°ng 8</option>
                  <option value="9">Th√°ng 9</option>
                  <option value="10">Th√°ng 10</option>
                  <option value="11">Th√°ng 11</option>
                  <option value="12">Th√°ng 12</option>
                </select>
              </div>
              
              <div class="control-group">
                <label class="control-label">&nbsp;</label>
                <button class="chart-btn chart-btn-secondary" onclick="loadSummary()" type="button">
                  <i class="fas fa-chart-area"></i>
                  Hi·ªÉn Th·ªã T·ªïng H·ª£p
                </button>
              </div>
            </form>
          </div>
          
          <div id="summaryCharts"></div>
        </div>
      </div>
    </div>
  </div>
<script>
let chart;

async function loadTenTKList() {
  const res = await fetch("/api/list_ten_tk");
  const list = await res.json();
  const select = document.getElementById("ten_tk");
  const excludeAccounts = ["admin", "kimnhung"];
  const filteredList = list.filter(name => !excludeAccounts.includes(name));
  filteredList.forEach(ten_tk => {
    const option = document.createElement("option");
    option.value = ten_tk;
    option.textContent = ten_tk;
    select.appendChild(option);
  });
}
loadTenTKList();

async function loadChart() {
  const ten_tk = document.getElementById('ten_tk').value.trim();
  const year = document.getElementById('year').value.trim();
  if (!ten_tk) {
    alert("Vui l√≤ng ch·ªçn t√†i kho·∫£n ƒë·ªÉ xem bi·ªÉu ƒë·ªì c√° nh√¢n.");
    return;
  }

  const res = await fetch(`/api/epa_summary?ten_tk=${ten_tk}&year=${year}`);
  const data = await res.json();

  const ctx = document.getElementById('epaChart').getContext('2d');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.map(d => `Th√°ng ${d.month}`),
      datasets: [{
        label: 'T·ªïng ƒëi·ªÉm',
        data: data.map(d => d.pri_total_score),
        backgroundColor: data.map(d => getRankLabel(d.pri_total_score).color)
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        title: { display: true, text: `Bi·ªÉu ƒê·ªì C√° Nh√¢n: ${ten_tk} - ${year}` },
        datalabels: {
          anchor: 'end', align: 'start', font: { size: 9, weight: 'bold' },
          formatter: (value) => getRankLabel(value).label,
          color: (ctx) => getRankLabel(ctx.dataset.data[ctx.dataIndex]).color
        }
      },
      scales: { y: { beginAtZero: true, max: 310 } }
    },
    plugins: [ChartDataLabels]
  });
}

function getRankLabel(score) {
  if (score >= 286) return { label: "A (Gi·ªèi)", color: "green" };
  if (score >= 271) return { label: "B (T·ªët)", color: "gold" };
  if (score >= 251) return { label: "C (Kh√°)", color: "orange" };
  if (score >= 200) return { label: "D (ƒê·∫°t)", color: "red" };
  return { label: "F", color: "gray" };
}

async function loadSummary() {
  document.getElementById("summaryCharts").innerHTML = "";
  const year = document.getElementById("summaryYear").value;
  const monthFilter = document.getElementById("summaryMonth").value;

  const res = await fetch(`/api/epa_monthly_all?year=${year}`);
  const data = await res.json();
  const container = document.getElementById("summaryCharts");

  Object.keys(data).sort((a, b) => a - b).forEach((month, index) => {
    if (monthFilter !== "All" && month !== monthFilter) return;

    const monthData = data[month];
    const labels = monthData.map(d => d.ten_tk);
    const scores = monthData.map(d => d.score);
    const bgColors = scores.map(s => getRankLabel(s).color);

    const canvasId = `chart_${index}`;
    const chartBox = document.createElement("div");
    chartBox.classList.add("summary-chart-container");
    chartBox.innerHTML = `
      <div class="summary-month-title">
        <i class="fas fa-calendar-alt"></i>
        Th√°ng ${month}
      </div>
      <canvas id="${canvasId}"></canvas>
    `;
    container.appendChild(chartBox);

    const ctx = document.getElementById(canvasId).getContext("2d");
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{ label: "T·ªïng ƒëi·ªÉm", data: scores, backgroundColor: bgColors }]
      },
      options: {
        indexAxis: 'x',
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (context) => `ƒêi·ªÉm: ${context.parsed.y} - ${getRankLabel(context.parsed.y).label}`
            }
          },
          datalabels: {
            anchor: 'end', align: 'start', font: { size: 9, weight: 'bold' },
            formatter: (value) => getRankLabel(value).label,
            color: (ctx) => getRankLabel(ctx.dataset.data[ctx.dataIndex]).color
          }
        },
        scales: { y: { beginAtZero: true, max: 310 } }
      },
      plugins: [ChartDataLabels]
    });
  });
}
</script>
</div></div></div></body>
</html>
