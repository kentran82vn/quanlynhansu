<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>📝 Tự Đánh Giá EPA - Trường Mầm Non Hoa Hướng Dương</title>
  
  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link href="{{ url_for('static_files', filename='css/modern.css') }}" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Inter', var(--font-family-sans);
      background: var(--bg-secondary);
      padding: var(--spacing-lg);
    }
    
    .page-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: white;
      padding: var(--spacing-xl);
      border-radius: var(--border-radius-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-lg);
    }
    
    .page-title {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      margin: 0 0 var(--spacing-sm) 0;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .page-subtitle {
      font-size: var(--text-sm);
      opacity: 0.9;
      margin: 0;
    }
    
    .content-card {
      background: var(--bg-primary);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200);
    }
    
    .section-title {
      font-size: var(--text-xl);
      font-weight: var(--font-semibold);
      color: var(--text-primary);
      margin: 0 0 var(--spacing-lg) 0;
      padding-bottom: var(--spacing-sm);
      border-bottom: 2px solid var(--gray-200);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .status-message {
      padding: var(--spacing-md);
      border-radius: var(--border-radius-md);
      margin-bottom: var(--spacing-lg);
      font-weight: var(--font-medium);
    }
    
    .status-message.success {
      background: var(--success-light);
      border: 1px solid var(--success-color);
      color: var(--success-dark);
    }
    
    .status-message.warning {
      background: var(--warning-light);
      border: 1px solid var(--warning-color);
      color: var(--warning-dark);
    }
    
    .status-message.error {
      background: var(--error-light);
      border: 1px solid var(--error-color);
      color: var(--error-dark);
    }
    
    .total-score-display {
      background: var(--primary-light);
      border: 1px solid var(--primary-color);
      color: var(--primary-dark);
      padding: var(--spacing-md);
      border-radius: var(--border-radius-md);
      font-weight: var(--font-semibold);
      margin-bottom: var(--spacing-lg);
      text-align: center;
    }
    
    .btn-primary-modern {
      background: var(--primary-color);
      border: 1px solid var(--primary-color);
      color: white;
      padding: var(--spacing-md) var(--spacing-xl);
      border-radius: var(--border-radius-md);
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      transition: all var(--transition-normal);
      cursor: pointer;
    }
    
    .btn-primary-modern:hover:not(:disabled) {
      background: var(--primary-dark);
      border-color: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .btn-primary-modern:disabled {
      background: var(--gray-400);
      border-color: var(--gray-400);
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .modern-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: var(--border-radius-md);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--spacing-lg);
    }
    
    .modern-table th {
      background: var(--gray-50);
      color: var(--text-primary);
      font-weight: var(--font-semibold);
      padding: var(--spacing-md);
      text-align: left;
      border-bottom: 1px solid var(--gray-200);
    }
    
    .modern-table td {
      padding: var(--spacing-md);
      border-bottom: 1px solid var(--gray-100);
      color: var(--text-secondary);
    }
    
    .modern-table tr:hover {
      background: var(--gray-25);
    }
    
    .question {
      background: var(--bg-primary);
      border: 1px solid var(--gray-200);
      border-radius: var(--border-radius-md);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }
    
    .question p {
      margin: 0 0 var(--spacing-md) 0;
      font-weight: var(--font-semibold);
      color: var(--text-primary);
    }
    
    .score-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }
    
    .score-inputs > div {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }
    
    .score-inputs label {
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--text-secondary);
    }
    
    .score-inputs input {
      padding: var(--spacing-sm);
      border: 1px solid var(--gray-300);
      border-radius: var(--border-radius);
      font-size: var(--text-sm);
      transition: all var(--transition-fast);
    }
    
    .score-inputs input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .score-inputs input:disabled {
      background: var(--gray-100);
      color: var(--text-muted);
      cursor: not-allowed;
    }
    
    .comment-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md);
    }
    
    .comment-inputs > div {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }
    
    .comment-inputs label {
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--text-secondary);
    }
    
    .comment-inputs textarea {
      padding: var(--spacing-sm);
      border: 1px solid var(--gray-300);
      border-radius: var(--border-radius);
      font-size: var(--text-sm);
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
      transition: all var(--transition-fast);
    }
    
    .comment-inputs textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .comment-inputs textarea:disabled {
      background: var(--gray-100);
      color: var(--text-muted);
      cursor: not-allowed;
    }
    
    @media (max-width: 768px) {
      .score-inputs,
      .comment-inputs {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="page-header">
    <div class="page-title">
      <i class="fas fa-clipboard-check"></i>
      Tự Đánh Giá EPA
    </div>
    <div class="page-subtitle">
      Hệ thống đánh giá hiệu suất nhân viên - {{ user }} ({{ role }})
    </div>
  </div>

  <div class="content-card">
    <div class="section-title">
      <i class="fas fa-clock"></i>
      Thời Gian Đánh Giá
    </div>
    <div id="period-message"></div>
  </div>

  <div class="content-card">
    <div class="section-title">
      <i class="fas fa-history"></i>
      Kết Quả Tự Đánh Giá Trước Đây
    </div>
    <div id="last-assessment"></div>
  </div>

  <div class="content-card">
    <div class="section-title">
      <i class="fas fa-chart-bar"></i>
      Tổng Điểm Đánh Giá
    </div>
    <table id="total-score-table" class="modern-table">
      <thead>
        <tr>
          <th>Năm</th>
          <th>Tháng</th>
          <th>Tổng điểm tự đánh giá</th>
          <th>Tổng điểm giám sát</th>
          <th>Điểm cấp trên</th>
          <th>Nhận xét cấp trên</th>
        </tr>
      </thead>
      <tbody id="total-score-table-body"></tbody>
    </table>
  </div>

  <div class="content-card">
    <div class="section-title">
      <i class="fas fa-edit"></i>
      Gửi Đánh Giá EPA Mới
    </div>
    <div class="total-score-display" id="total-score-display">
      Tổng điểm tự đánh giá: 0 | Tổng điểm giám sát: 0
    </div>
    <div id="assessment-form"></div>
    <button disabled="" id="submit-btn" class="btn-primary-modern">
      <i class="fas fa-paper-plane"></i> Gửi Đánh Giá
    </button>
    <div id="form-message"></div>
  </div>
<script>
        const API_BASE_URL = '/api';
        const tenTk = '{{ user }}';
        const userRole = '{{ role }}';

        function debugLog(message, data = null) {
            console.log(`[DEBUG] ${message}`, data || '');
        }

        async function checkAssessmentPeriod() {
            try {
                const response = await fetch(`${API_BASE_URL}/assessment-period`);
                const data = await response.json();

                const monthYear = `${data.month}/${data.year}`;
                const currentPhase = data.current_phase || 0;
                const phaseName = data.phase_name || 'Không xác định';
                
                // Phase-specific display
                let phaseDisplay = '';
                let startDay = 'N/A';
                let closeDay = 'N/A';
                
                if (data.phase1) {
                    startDay = data.phase1.start;
                    closeDay = data.phase1.end;
                    phaseDisplay = `Giai đoạn 1 (Tự đánh giá): ${startDay}/${monthYear} → ${closeDay}/${monthYear}`;
                }

                let msg = `<p><strong>Giai đoạn hiện tại:</strong> ${phaseName}</p>`;
                msg += `<p>${phaseDisplay}</p>`;

                // Status based on current phase and user permissions
                if (data.isOpen === false || data.can_assess === false) {
                    if (currentPhase === 3) {
                        msg += `<div class="status-message error">⛔ Đã kết thúc thời gian tự đánh giá. Hiện tại là giai đoạn HT/PHT đánh giá.</div>`;
                    } else if (currentPhase === 2) {
                        msg += `<div class="status-message warning">⏳ Đã kết thúc thời gian tự đánh giá. Hiện tại là giai đoạn TGV đánh giá.</div>`;
                    } else if (currentPhase === 1) {
                        msg += `<div class="status-message warning">⏳ Đang trong giai đoạn tự đánh giá nhưng bạn không có quyền.</div>`;
                    } else {
                        msg += `<div class="status-message error">⛔ Ngoài thời gian đánh giá EPA</div>`;
                    }
                    document.getElementById('submit-btn').disabled = true;
                } else {
                    msg += `<div class="status-message success">✅ Thời gian ${phaseName} đang mở</div>`;
                    document.getElementById('submit-btn').disabled = false;
                }

                document.getElementById('period-message').innerHTML = msg;

                return data.isOpen;

            } catch (error) {
                console.error('Lỗi kiểm tra thời gian:', error);
                document.getElementById('period-message').innerHTML =
                    '<div class="status-message error">Lỗi khi kiểm tra thời gian.</div>';
                return false;
            }
        }

        async function loadQuestions() {
            try {
                const response = await fetch(`${API_BASE_URL}/epa-questions`);
                const data = await response.json();
                debugLog('Danh sách câu hỏi:', data);
                if (!response.ok) throw new Error(data.message || 'Lỗi khi tải câu hỏi');
                const formDiv = document.getElementById('assessment-form');
                const isSupervisorOrAdmin = userRole === 'supervisor' || userRole === 'admin';
                formDiv.innerHTML = data.questions.slice(0, 10).map((q, index) => `
                    <div class="question">
                        <p><strong>${index + 1}. ${q.question}</strong></p>
                        <p style="font-size: 14px; color: #6b7280; margin: 5px 0;">
                            <i class="fas fa-star"></i> Điểm tối đa: <strong>${q.max_score || 30}</strong>
                        </p>
                        <!-- nếu bạn vẫn muốn hiển thị English, có thể thêm dòng sau: -->
                        <!-- <p class="text-muted"><em>(${q.translate || ''})</em></p> -->
                        <div class="score-inputs">
                            <div>
                                <label>Điểm tự chấm:</label>
                                <input type="number" min="0" max="${q.max_score || 30}" id="score-${q.id}" placeholder="Nhập điểm (0-${q.max_score || 30})">
                            </div>
                            <div>
                                <label>Điểm từ Supervisor:</label>
                                <input type="number" min="0" max="${q.max_score || 30}" id="sup-score-${q.id}" placeholder="Nhập điểm (0-${q.max_score || 30})" ${isSupervisorOrAdmin ? '' : 'disabled'}>
                            </div>
                        </div>
                        <div class="comment-inputs">
                            <div>
                                <label>Ý kiến tự đánh giá:</label>
                                <textarea id="user-comment-${q.id}" placeholder="Nhập ý kiến của bạn cho câu hỏi này..."></textarea>
                            </div>
                            <div>
                                <label>Ý kiến từ Supervisor:</label>
                                <textarea id="sup-comment-${q.id}" placeholder="Nhập ý kiến đánh giá (Supervisor)" ${isSupervisorOrAdmin ? '' : 'disabled'}></textarea>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Add event listeners for real-time total score update
                const scoreInputs = document.querySelectorAll('input[type="number"][id^="score-"]');
                const supScoreInputs = document.querySelectorAll('input[type="number"][id^="sup-score-"]');
                scoreInputs.forEach(input => input.addEventListener('input', updateTotalScore));
                supScoreInputs.forEach(input => input.addEventListener('input', updateTotalScore));
                updateTotalScore();
            } catch (error) {
                debugLog('Lỗi tải câu hỏi:', error);
                document.getElementById('assessment-form').innerHTML = '<div class="status-message error">Không thể tải câu hỏi.</div>';
            }
        }

        function updateTotalScore() {
            const scoreInputs = document.querySelectorAll('input[type="number"][id^="score-"]');
            const supScoreInputs = document.querySelectorAll('input[type="number"][id^="sup-score-"]');
            let userTotal = 0;
            let supTotal = 0;
            scoreInputs.forEach(input => {
                const value = parseInt(input.value) || 0;
                if (value >= 0 && value <= 30) userTotal += value;
            });
            supScoreInputs.forEach(input => {
                const value = parseInt(input.value) || 0;
                if (value >= 0 && value <= 30) supTotal += value;
            });
            document.getElementById('total-score-display').textContent = `Tổng điểm tự đánh giá: ${userTotal} | Tổng điểm giám sát: ${supTotal}`;
        }

        async function loadLastAssessment() {
            try {
                const response = await fetch(`${API_BASE_URL}/last-assessment`);
                const data = await response.json();
                debugLog('Kết quả đánh giá trước:', data);
                if (!response.ok) throw new Error(data.message || 'Lỗi khi tải đánh giá');
                const assessmentDiv = document.getElementById('last-assessment');
                const totalScoreTableBody = document.getElementById('total-score-table-body');

                // Load individual assessments
                if (data.assessments && data.assessments.length === 0) {
                    assessmentDiv.innerHTML = '<div class="status-message warning">Không tìm thấy kết quả đánh giá trước đây.</div>';
                } else {
                    assessmentDiv.innerHTML = (data.assessments || data).map(a => `
                        <div class="assessment-entry">
                            <p class="highlight">Năm: ${a.year}, Tháng: ${a.month}</p>
                            <p><strong>Câu hỏi:</strong> ${a.question}</p>
                            <p><strong>Điểm tự chấm:</strong> ${a.user_score || 'N/A'}</p>
                            <p><strong>Điểm từ Supervisor:</strong> ${a.sup_score || 'Chưa chấm'}</p>
                            <p><strong>Ý kiến tự đánh giá:</strong> ${a.user_comment || 'Không có ý kiến'}</p>
                            <p><strong>Ý kiến từ Supervisor:</strong> ${a.sup_comment || 'Không có ý kiến'}</p>
                        </div>
                    `).join('<hr>');
                }

                // Load total scores
                if (data.total_score) {
                    totalScoreTableBody.innerHTML = `
                        <tr>
                            <td>${data.total_score.year}</td>
                            <td>${data.total_score.month}</td>
                            <td>${data.total_score.user_total_score || 0}</td>
                            <td>${data.total_score.sup_total_score || 0}</td>
                            <td>${data.total_score.pri_total_score || 'Chưa có'}</td>
                            <td>${data.total_score.pri_comment || 'Chưa có'}</td>
                        </tr>
                    `;
                } else {
                    totalScoreTableBody.innerHTML = '<tr><td colspan="6">Không tìm thấy tổng điểm.</td></tr>';
                }
            } catch (error) {
                debugLog('Lỗi tải đánh giá trước:', error);
                document.getElementById('last-assessment').innerHTML = '<div class="status-message warning">Không thể tải kết quả đánh giá trước đây. Có thể bạn chưa thực hiện đánh giá hoặc có lỗi kết nối.</div>';
                document.getElementById('total-score-table-body').innerHTML = '<tr><td colspan="6">Không thể tải tổng điểm. Vui lòng thử lại sau.</td></tr>';
            }
        }

        async function submitAssessment() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const scores = [];
            const questionInputs = document.querySelectorAll('#assessment-form .question');
            let userTotalScore = 0;
            let supTotalScore = 0;

            questionInputs.forEach(inputGroup => {
                const questionId = inputGroup.querySelector('input[type="number"]').id.split('-')[1];
                const user_score = parseInt(inputGroup.querySelector(`#score-${questionId}`).value);
                const supScoreInput = inputGroup.querySelector(`#sup-score-${questionId}`);
                const sup_score = supScoreInput.disabled ? null : parseInt(supScoreInput.value);
                const user_comment = inputGroup.querySelector(`#user-comment-${questionId}`).value.trim();
                const supCommentInput = inputGroup.querySelector(`#sup-comment-${questionId}`);
                const sup_comment = supCommentInput.disabled ? '' : supCommentInput.value.trim();
                if (!isNaN(user_score)) {
                    scores.push({ 
                        questionId, 
                        score: user_score, 
                        sup_score: isNaN(sup_score) ? null : sup_score,
                        user_comment,
                        sup_comment
                    });
                    // Validation với điểm tối đa động từ database
                    const maxScore = question.max_score || 30;
                    if (user_score >= 0 && user_score <= maxScore) {
                        userTotalScore += user_score;
                    } else if (user_score > maxScore) {
                        document.getElementById('form-message').innerHTML = `<div class="status-message error">Câu ${question.id}: Điểm tối đa chỉ được ${maxScore}, không thể nhập ${user_score}</div>`;
                        return;
                    }
                    
                    if (sup_score >= 0 && sup_score <= maxScore) {
                        supTotalScore += sup_score;
                    } else if (sup_score > maxScore) {
                        document.getElementById('form-message').innerHTML = `<div class="status-message error">Câu ${question.id}: Điểm TGV tối đa chỉ được ${maxScore}, không thể nhập ${sup_score}</div>`;
                        return;
                    }
                }
            });
            debugLog('Gửi dữ liệu:', { ten_tk: tenTk, year, month, scores, user_total_score: userTotalScore, sup_total_score: supTotalScore });
            if (scores.length === 0) {
                document.getElementById('form-message').innerHTML = '<div class="status-message error">Vui lòng nhập ít nhất một điểm số.</div>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/submit-assessment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        ten_tk: tenTk, 
                        year, 
                        month, 
                        scores,
                        user_total_score: userTotalScore,
                        sup_total_score: supTotalScore
                    })
                });
                const data = await response.json();
                debugLog('Kết quả gửi:', data);
                if (!response.ok) throw new Error(data.message || 'Lỗi khi gửi đánh giá');
                document.getElementById('form-message').innerHTML = '<div class="status-message success">Đánh giá đã được gửi thành công!</div>';
                questionInputs.forEach(inputGroup => {
                    const questionId = inputGroup.querySelector('input[type="number"]').id.split('-')[1];
                    inputGroup.querySelector(`#score-${questionId}`).value = '';
                    inputGroup.querySelector(`#sup-score-${questionId}`).value = '';
                    inputGroup.querySelector(`#user-comment-${questionId}`).value = '';
                    const supCommentInput = inputGroup.querySelector(`#sup-comment-${questionId}`);
                    if (!supCommentInput.disabled) supCommentInput.value = '';
                });
                updateTotalScore();
                loadLastAssessment();
            } catch (error) {
                debugLog('Lỗi gửi đánh giá:', error);
                document.getElementById('form-message').innerHTML = '<div class="status-message error">Không thể gửi đánh giá.</div>';
            }
        }

        async function init() {
            debugLog('Khởi tạo trang');
            const isOpen = await checkAssessmentPeriod();
            if (isOpen) {
                await loadQuestions();
            }
            await loadLastAssessment();
            document.getElementById('submit-btn').addEventListener('click', submitAssessment);
        }
        window.onload = init;
    </script>
</div></div></div></body>
</html>