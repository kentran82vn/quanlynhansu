<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Tự Đánh Giá EPA</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        colors: {
          primary: '#0d6efd',
          secondary: '#6c757d'
        }
      }
    }
  }
</script>

</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-300">
<div class="max-w-6xl mx-auto p-6">
<div class="mb-6">
  <h1 id="epa-title" class="text-3xl font-bold text-gray-900 dark:text-white text-center">Tự Đánh Giá EPA</h1>
</div>
<!-- Period Check -->
<div id="period-message" class="mb-6 p-4 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800"></div>
<!-- Last Assessment -->
<div class="mb-8">
  <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">Kết Quả Tự Đánh Giá Trước Đây</h2>
  <div id="last-assessment" class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4"></div>
</div>
<!-- Total Score Table -->
<div class="mb-8">
  <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">Tổng Điểm Đánh Giá</h2>
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
    <table id="total-score-table" class="w-full">
      <thead class="bg-gray-50 dark:bg-gray-700">
        <tr>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-900 dark:text-gray-300">Năm</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-900 dark:text-gray-300">Tháng</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-900 dark:text-gray-300">Tổng điểm tự đánh giá</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-900 dark:text-gray-300">Tổng điểm giám sát</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-900 dark:text-gray-300">Điểm cấp trên</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-900 dark:text-gray-300">Nhận xét cấp trên</th>
        </tr>
      </thead>
      <tbody id="total-score-table-body" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
    </table>
  </div>
</div>
<!-- Assessment Form -->
<div class="mb-8">
  <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">Gửi Đánh Giá EPA Mới</h2>
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
    <div id="total-score-display" class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 text-blue-800 dark:text-blue-200 rounded-lg font-semibold text-center">
      Tổng điểm tự đánh giá: 0 | Tổng điểm giám sát: 0
    </div>
    <div id="assessment-form" class="space-y-6"></div>
    <div class="mt-6">
      <button disabled id="submit-btn" class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-medium rounded-lg transition-colors">
        Gửi
      </button>
    </div>
    <div id="form-message" class="mt-4"></div>
  </div>
</div>
</div>
<script>
        const API_BASE_URL = '/api';
        const tenTk = '{{ user }}';
        const userRole = '{{ role }}';

        function debugLog(message, data = null) {
            console.log(`[DEBUG] ${message}`, data || '');
        }

        async function checkAssessmentPeriod() {
            try {
                const response = await fetch(`${API_BASE_URL}/assessment-period`);
                const data = await response.json();

                const monthYear = `${data.month}/${data.year}`;
                const startDay = data.start_day ?? 'N/A';
                const closeDay = data.close_day ?? 'N/A';

                let msg = `<p>Thời gian đánh giá EPA: ${startDay}/${monthYear} → ${closeDay}/${monthYear}</p>`;

                const now = new Date().getDate();

                if (!startDay || !closeDay || startDay === 0 || closeDay === 0) {
                    msg += `<p class="text-danger">⛔ Chưa thiết lập thời gian đánh giá EPA</p>`;
                    document.getElementById('submit-btn').disabled = true;
                } else if (now < startDay) {
                    msg += `<p class="text-warning">⏳ Chưa đến thời gian đánh giá EPA</p>`;
                    document.getElementById('submit-btn').disabled = true;
                } else if (now > closeDay) {
                    msg += `<p class="text-danger">⛔ Đã quá thời hạn đánh giá EPA</p>`;
                    document.getElementById('submit-btn').disabled = true;
                } else {
                    msg += `<p class="text-success">✅ Thời gian đánh giá đang mở</p>`;
                    document.getElementById('submit-btn').disabled = false;
                }

                document.getElementById('period-message').innerHTML = msg;

                return data.isOpen;

            } catch (error) {
                console.error('Lỗi kiểm tra thời gian:', error);
                document.getElementById('period-message').innerHTML =
                    '<p class="text-danger">Lỗi khi kiểm tra thời gian.</p>';
                return false;
            }
        }

        async function loadQuestions() {
            try {
                const response = await fetch(`${API_BASE_URL}/epa-questions`);
                const data = await response.json();
                debugLog('Danh sách câu hỏi:', data);
                if (!response.ok) throw new Error(data.message || 'Lỗi khi tải câu hỏi');
                const formDiv = document.getElementById('assessment-form');
                const isSupervisorOrAdmin = userRole === 'supervisor' || userRole === 'admin';
                formDiv.innerHTML = data.questions.slice(0, 10).map((q, index) => `
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 border border-gray-200 dark:border-gray-600">
                        <p class="text-lg font-semibold text-gray-900 dark:text-white mb-4">${index + 1}. ${q.question}</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Điểm tự chấm:</label>
                                <input type="number" min="0" max="30" id="score-${q.id}" 
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-600 dark:text-white"
                                       placeholder="Nhập điểm (0-30)">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Điểm từ Supervisor:</label>
                                <input type="number" min="0" max="30" id="sup-score-${q.id}" 
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-600 dark:text-white disabled:bg-gray-100 dark:disabled:bg-gray-800 disabled:cursor-not-allowed"
                                       placeholder="Nhập điểm (0-30)" ${isSupervisorOrAdmin ? '' : 'disabled'}>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ý kiến tự đánh giá:</label>
                                <textarea id="user-comment-${q.id}" rows="3"
                                          class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-600 dark:text-white resize-none"
                                          placeholder="Nhập ý kiến của bạn cho câu hỏi này..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ý kiến từ Supervisor:</label>
                                <textarea id="sup-comment-${q.id}" rows="3"
                                          class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-600 dark:text-white disabled:bg-gray-100 dark:disabled:bg-gray-800 disabled:cursor-not-allowed resize-none"
                                          placeholder="Nhập ý kiến đánh giá (Supervisor)" ${isSupervisorOrAdmin ? '' : 'disabled'}></textarea>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Add event listeners for real-time total score update
                const scoreInputs = document.querySelectorAll('input[type="number"][id^="score-"]');
                const supScoreInputs = document.querySelectorAll('input[type="number"][id^="sup-score-"]');
                scoreInputs.forEach(input => input.addEventListener('input', updateTotalScore));
                supScoreInputs.forEach(input => input.addEventListener('input', updateTotalScore));
                updateTotalScore();
            } catch (error) {
                debugLog('Lỗi tải câu hỏi:', error);
                document.getElementById('assessment-form').innerHTML = '<p class="text-red-600 dark:text-red-400 text-center p-4">Không thể tải câu hỏi.</p>';
            }
        }

        function updateTotalScore() {
            const scoreInputs = document.querySelectorAll('input[type="number"][id^="score-"]');
            const supScoreInputs = document.querySelectorAll('input[type="number"][id^="sup-score-"]');
            let userTotal = 0;
            let supTotal = 0;
            scoreInputs.forEach(input => {
                const value = parseInt(input.value) || 0;
                if (value >= 0 && value <= 30) userTotal += value;
            });
            supScoreInputs.forEach(input => {
                const value = parseInt(input.value) || 0;
                if (value >= 0 && value <= 30) supTotal += value;
            });
            document.getElementById('total-score-display').textContent = `Tổng điểm tự đánh giá: ${userTotal} | Tổng điểm giám sát: ${supTotal}`;
        }

        async function loadLastAssessment() {
            try {
                const response = await fetch(`${API_BASE_URL}/last-assessment`);
                const data = await response.json();
                debugLog('Kết quả đánh giá trước:', data);
                if (!response.ok) throw new Error(data.message || 'Lỗi khi tải đánh giá');
                const assessmentDiv = document.getElementById('last-assessment');
                const totalScoreTableBody = document.getElementById('total-score-table-body');

                // Load individual assessments
                if (data.assessments && data.assessments.length === 0) {
                    assessmentDiv.innerHTML = '<p class="text-gray-600 dark:text-gray-400 text-center italic">Không tìm thấy kết quả đánh giá trước đây.</p>';
                } else {
                    assessmentDiv.innerHTML = (data.assessments || data).map(a => `
                        <div class="p-4 border border-gray-200 dark:border-gray-600 rounded-lg mb-4">
                            <p class="text-blue-600 dark:text-blue-400 font-semibold mb-2">Năm: ${a.year}, Tháng: ${a.month}</p>
                            <div class="space-y-2 text-sm">
                                <p class="text-gray-700 dark:text-gray-300"><strong>Câu hỏi:</strong> ${a.question}</p>
                                <p class="text-gray-700 dark:text-gray-300"><strong>Điểm tự chấm:</strong> <span class="text-green-600 dark:text-green-400">${a.user_score || 'N/A'}</span></p>
                                <p class="text-gray-700 dark:text-gray-300"><strong>Điểm từ Supervisor:</strong> <span class="text-blue-600 dark:text-blue-400">${a.sup_score || 'Chưa chấm'}</span></p>
                                <p class="text-gray-700 dark:text-gray-300"><strong>Ý kiến tự đánh giá:</strong> ${a.user_comment || 'Không có ý kiến'}</p>
                                <p class="text-gray-700 dark:text-gray-300"><strong>Ý kiến từ Supervisor:</strong> ${a.sup_comment || 'Không có ý kiến'}</p>
                            </div>
                        </div>
                    `).join('');
                }

                // Load total scores
                if (data.total_score) {
                    totalScoreTableBody.innerHTML = `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-300">${data.total_score.year}</td>
                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-300">${data.total_score.month}</td>
                            <td class="px-4 py-3 text-sm text-green-600 dark:text-green-400 font-semibold">${data.total_score.user_total_score || 0}</td>
                            <td class="px-4 py-3 text-sm text-blue-600 dark:text-blue-400 font-semibold">${data.total_score.sup_total_score || 0}</td>
                            <td class="px-4 py-3 text-sm text-purple-600 dark:text-purple-400 font-semibold">${data.total_score.pri_total_score || 'Chưa có'}</td>
                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-300">${data.total_score.pri_comment || 'Chưa có'}</td>
                        </tr>
                    `;
                } else {
                    totalScoreTableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400 italic">Không tìm thấy tổng điểm.</td></tr>';
                }
            } catch (error) {
                debugLog('Lỗi tải đánh giá trước:', error);
                document.getElementById('last-assessment').innerHTML = '<p class="text-red-600 dark:text-red-400 text-center p-4">Hãy hoàn thành bảng đánh giá tháng.</p>';
                document.getElementById('total-score-table-body').innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-red-500 dark:text-red-400">Lỗi khi tải tổng điểm.</td></tr>';
            }
        }

        async function submitAssessment() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const scores = [];
            const questionInputs = document.querySelectorAll('#assessment-form .question');
            let userTotalScore = 0;
            let supTotalScore = 0;

            questionInputs.forEach(inputGroup => {
                const questionId = inputGroup.querySelector('input[type="number"]').id.split('-')[1];
                const user_score = parseInt(inputGroup.querySelector(`#score-${questionId}`).value);
                const supScoreInput = inputGroup.querySelector(`#sup-score-${questionId}`);
                const sup_score = supScoreInput.disabled ? null : parseInt(supScoreInput.value);
                const user_comment = inputGroup.querySelector(`#user-comment-${questionId}`).value.trim();
                const supCommentInput = inputGroup.querySelector(`#sup-comment-${questionId}`);
                const sup_comment = supCommentInput.disabled ? '' : supCommentInput.value.trim();
                if (!isNaN(user_score)) {
                    scores.push({ 
                        questionId, 
                        score: user_score, 
                        sup_score: isNaN(sup_score) ? null : sup_score,
                        user_comment,
                        sup_comment
                    });
                    if (user_score >= 0 && user_score <= 30) userTotalScore += user_score;
                    if (sup_score >= 0 && sup_score <= 30) supTotalScore += sup_score;
                }
            });
            debugLog('Gửi dữ liệu:', { ten_tk: tenTk, year, month, scores, user_total_score: userTotalScore, sup_total_score: supTotalScore });
            if (scores.length === 0) {
                document.getElementById('form-message').innerHTML = '<p class="text-red-600 dark:text-red-400 text-center p-3 bg-red-50 dark:bg-red-900/20 rounded-lg">Vui lòng nhập ít nhất một điểm số.</p>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/submit-assessment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        ten_tk: tenTk, 
                        year, 
                        month, 
                        scores,
                        user_total_score: userTotalScore,
                        sup_total_score: supTotalScore
                    })
                });
                const data = await response.json();
                debugLog('Kết quả gửi:', data);
                if (!response.ok) throw new Error(data.message || 'Lỗi khi gửi đánh giá');
                document.getElementById('form-message').innerHTML = '<p class="text-green-600 dark:text-green-400 text-center p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">Đánh giá đã được gửi thành công!</p>';
                questionInputs.forEach(inputGroup => {
                    const questionId = inputGroup.querySelector('input[type="number"]').id.split('-')[1];
                    inputGroup.querySelector(`#score-${questionId}`).value = '';
                    inputGroup.querySelector(`#sup-score-${questionId}`).value = '';
                    inputGroup.querySelector(`#user-comment-${questionId}`).value = '';
                    const supCommentInput = inputGroup.querySelector(`#sup-comment-${questionId}`);
                    if (!supCommentInput.disabled) supCommentInput.value = '';
                });
                updateTotalScore();
                loadLastAssessment();
            } catch (error) {
                debugLog('Lỗi gửi đánh giá:', error);
                document.getElementById('form-message').innerHTML = '<p class="text-red-600 dark:text-red-400 text-center p-3 bg-red-50 dark:bg-red-900/20 rounded-lg">Không thể gửi đánh giá.</p>';
            }
        }

        async function init() {
            debugLog('Khởi tạo trang');
            
            // Listen for dark mode messages from parent
            window.addEventListener('message', (event) => {
                if (event.data.type === 'darkModeToggle') {
                    if (event.data.isDark) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                }
            });
            
            // Initialize dark mode based on localStorage
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
            }
            
            const isOpen = await checkAssessmentPeriod();
            if (isOpen) {
                await loadQuestions();
            }
            await loadLastAssessment();
            document.getElementById('submit-btn').addEventListener('click', submitAssessment);
        }
        const now = new Date();
        const monthDisplay = `${now.getMonth() + 1}/${now.getFullYear()}`;
        document.getElementById("epa-title").innerText = `Tự Đánh Giá EPA - ${monthDisplay} - ${tenTk}`;
        window.onload = init;
    </script>
</div></body>
</html>