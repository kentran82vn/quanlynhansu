<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√¥ng Tin Nh√¢n S·ª±</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Lo·∫°i b·ªè l·ªÅ v√† padding ƒë·ªÉ canh tr√°i to√†n trang */
        body {
            margin: 2;
            padding: 2;
        }
        .no-padding {
            padding-left: 2 !important;
            padding-right: 2 !important;
        }
        /* ƒê·∫£m b·∫£o b·∫£ng full width v√† cu·ªôn ngang n·∫øu c·∫ßn */
        .table-responsive {
            width: 100%;
            margin: 4;
            padding: 4;
            overflow-x: auto;
        }
        .table-bordered {
            width: 100%;
            border-collapse: collapse;
        }
        /* T·ªëi ∆∞u kh√¥ng gian b·∫£ng */
        .table-bordered th, .table-bordered td {
            padding: 8px; /* Gi·∫£m padding ƒë·ªÉ hi·ªÉn th·ªã nhi·ªÅu n·ªôi dung h∆°n */
            font-size: 14px; /* Font nh·ªè h∆°n ƒë·ªÉ ti·∫øt ki·ªám kh√¥ng gian */
        }
        /* TƒÉng kho·∫£ng c√°ch gi·ªØa c√°c ph·∫ßn t·ª≠ ƒë·ªÉ tho√°ng h∆°n */
        .form-group, .card, .table-responsive {
            margin-bottom: 20px;
        }
        /* M√†u n·ªÅn v√† ch·ªØ cho thead */
        .table-bordered thead {
            background-color: #007bff; /* M√†u xanh d∆∞∆°ng */
            color: white; /* Ch·ªØ tr·∫Øng */
        }
        /* Canh gi·ªØa n·ªôi dung cho th v√† td */
        .table-bordered th, .table-bordered td {
            text-align: center;
            vertical-align: middle;
            padding: 8px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container-fluid no-padding"> <!-- container-fluid ƒë·ªÉ full width, no-padding ƒë·ªÉ canh tr√°i -->
        <div class="row no-gutters"> <!-- no-gutters ƒë·ªÉ b·ªè padding tr√°i/ph·∫£i -->
            <div class="col-12">
                <div class="card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0 d-flex align-items-center gap-3">
                            üìã - TH√îNG TIN NH√ÇN S·ª∞ -
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col">
                              <a href="/user-epa-score" class="btn btn-primary btn-sm">
                                üìù ƒê√°nh gi√° EPA
                              </a>
                              {% if role == "supervisor" %}
                              <a href="/sup-epa-score" class="btn btn-primary btn-sm">
                                üìù ƒê√°nh gi√° EPA t·ªï vi√™n
                              </a>
                              {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row no-gutters">
            <div class="col-12">
                <div class="form-group d-flex align-items-end">
                    <div class="mr-3">
                        <label for="deptSelect">B·ªô Ph·∫≠n</label>
                        <select name="deptSelect" id="deptSelect" class="form-control form-control-sm" onchange="switchDept()">
                            <option value="">-- Ch·ªçn B·ªô Ph·∫≠n --</option>
                            <option value="HS">HS</option>
                            <option value="GV">GV</option>
                        </select>
                    </div>
                    <div>
                        <label for="searchInput" class="sr-only">T√¨m ki·∫øm</label>
                        <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="üîç T√¨m ki·∫øm..." style="width: 250px;">
                    </div>
                </div>
                <div id="dynamicInputRow"></div>
                <div class="table-responsive">
                    <div id="table_hs" style="display: none;">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>M√£ HS</th>
                                    <th>M√£ GV</th>
                                    <th>M√£ L·ªõp</th>
                                    <th>H·ªç v√† T√™n</th>
                                    <th>Ng√†y Sinh</th>
                                    <th>Gi·ªõi T√≠nh</th>
                                    <th>D√¢n T·ªôc</th>
                                    <th>M√£ ƒê·ªãnh Danh</th>
                                    <th>T√™n B·ªë</th>
                                    <th>Ngh·ªÅ B·ªë</th>
                                    <th>T√™n M·∫π</th>
                                    <th>Ngh·ªÅ M·∫π</th>
                                    <th>H·ªô Kh·∫©u</th>
                                    <th>CCCD B·ªë/M·∫π</th>
                                    <th>SƒêT B·ªë/M·∫π</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="table_gv" style="display: none;">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>M√£ GV</th>
                                    <th>H·ªç v√† T√™n</th>
                                    <th>T√™n TK</th>
                                    <th>Ch·ª©c V·ª•</th>
                                    <th>Ng√†y Sinh</th>
                                    <th>Qu√™ Qu√°n</th>
                                    <th>CCCD</th>
                                    <th>Ng√†y C·∫•p CCCD</th>
                                    <th>M√£ S·ªë Thu·∫ø</th>
                                    <th>CMND</th>
                                    <th>S·ªë B·∫£o Hi·ªÉm</th>
                                    <th>S·ªë ƒêi·ªán Tho·∫°i</th>
                                    <th>T√†i Kho·∫£n NH</th>
                                    <th>Email</th>
                                    <th>Nh√≥m M√°u</th>
                                    <th>ƒê·ªãa Ch·ªâ</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
<script>
  let maGVList = [];
  let maLopList = [];

  async function fetchMaLists() {
    const res = await fetch("/api/danh-sach-ma");
    const data = await res.json();
    maGVList = data.maGVList;
    maLopList = data.maLopList;
  }

  // G·ªçi h√†m n√†y tr∆∞·ªõc khi render b·∫£ng h·ªçc sinh
  fetchMaLists();
</script>
<script>
let schemaByDept = {};
const currentUser = "{{ user|lower }}";
const userRole = "{{ role }}";

async function fetchSchema() {
  try {
    const res = await fetch("/api/table-schema", { credentials: "include" });
    if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}, StatusText: ${res.statusText}`);
    const schema = await res.json();
    if (!schema || typeof schema !== "object") {
      throw new Error("Invalid schema format: " + JSON.stringify(schema));
    }
    // Map backend column names to frontend field names
    schemaByDept = {
      HS: schema.HS ? schema.HS.map(field => ({
        ma_hs: "ma_hs",
        ma_gv: "ma_gv",
        ma_lop: "ma_lop",
        ho_va_ten: "full_name",
        ngay_sinh: "birth_date",
        gioi_tinh: "gender",
        dan_toc: "ethnicity",
        ma_dinh_danh: "identifier_code",
        ho_ten_bo: "father_name",
        nghe_nghiep_bo: "father_job",
        ho_ten_me: "mother_name",
        nghe_nghiep_me: "mother_job",
        ho_khau: "household_address",
        cccd_bo_me: "parent_id_card",
        sdt: "parent_phone"
      }[field] || field)) : [],
      GV: schema.GV ? schema.GV.map(field => ({
        ma_gv: "staff_id",
        ho_va_ten: "full_name",
        ten_tk: "nick_name",
        chuc_vu: "team",
        ngay_sinh: "birth_date",
        que_quan: "hometown",
        cccd: "cccd",
        ngay_cap: "cccd_issued_date",
        mst: "tax_code",
        cmnd: "cmnd",
        so_bh: "insurance_number",
        sdt: "phone_number",
        tk_nh: "bank_account",
        email: "email",
        nhom_mau: "blood_type",
        dia_chi: "address"
      }[field] || field)) : []
    };
    console.log("DEBUG: Schema fetched successfully", schemaByDept);
    await switchDept();
  } catch (err) {
    console.error("‚ùå Failed to fetch schema:", err.message);
    //alert("Kh√¥ng th·ªÉ t·∫£i schema. Vui l√≤ng th·ª≠ l·∫°i. L·ªói: " + err.message);
  }
}

async function switchDept() {
  console.log("DEBUG: switchDept b·∫Øt ƒë·∫ßu");

  // Ki·ªÉm tra DOM
  const deptSelect = document.getElementById("deptSelect");
  const container = document.getElementById("dynamicInputRow");
  const tableHS = document.getElementById("table_hs");
  const tableGV = document.getElementById("table_gv");

  if (!deptSelect || !container || !tableHS || !tableGV) {
    console.error("‚ùå Thi·∫øu deptSelect, dynamicInputRow, table_hs, ho·∫∑c table_gv trong DOM");
    //alert("L·ªói: Kh√¥ng t√¨m th·∫•y c√°c ph·∫ßn t·ª≠ giao di·ªán c·∫ßn thi·∫øt. Vui l√≤ng th·ª≠ l·∫°i.");
    return;
  }

  const dept = deptSelect.value;
  console.log(`DEBUG: B·ªô ph·∫≠n ƒë∆∞·ª£c ch·ªçn: ${dept}`);
  // Hi·ªÉn th·ªã spinner
  container.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="sr-only">ƒêang t·∫£i...</span></div></div>';
  // ·∫®n/hi·ªán b·∫£ng
  tableHS.style.display = dept === "HS" ? "block" : "none";
  tableGV.style.display = dept === "GV" ? "block" : "none";
  console.log(`DEBUG: Tr·∫°ng th√°i hi·ªÉn th·ªã - table_hs: ${tableHS.style.display}, table_gv: ${tableGV.style.display}`);
  // Ki·ªÉm tra dept v√† schema
  if (!dept) {
    console.log("DEBUG: Ch∆∞a ch·ªçn b·ªô ph·∫≠n");
    //alert("Vui l√≤ng ch·ªçn m·ªôt b·ªô ph·∫≠n (HS ho·∫∑c GV).");
    container.innerHTML = "";
    return;
  }
  if (!schemaByDept[dept]) {
    console.log(`DEBUG: Kh√¥ng t√¨m th·∫•y schema cho ${dept}`);
    alert(`L·ªói: Kh√¥ng c√≥ schema cho b·ªô ph·∫≠n ${dept}. Vui l√≤ng th·ª≠ l·∫°i.`);
    container.innerHTML = "";
    return;
  }
  // T·∫°o tr∆∞·ªùng nh·∫≠p li·ªáu ƒë·ªông v√† n√∫t Th√™m ch·ªâ khi "kimnhung", role l√† Supervisor ho·∫∑c Administrator
  container.innerHTML = "";
  if (currentUser === "kimnhung" || userRole === "supervisor" || userRole === "Administrator") {
    let rowDiv = document.createElement("div");
    rowDiv.className = "row g-2 mb-2 w-100 d-flex";

    schemaByDept[dept].forEach((field, index) => {
      const label = field.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
      console.log(`DEBUG: T·∫°o input cho field: ${field}, label: ${label}`);
      let inputType = "text";
      if (field.includes("date")) inputType = "date";
      else if (field.includes("phone")) inputType = "tel";
      else if (field.includes("email")) inputType = "email";
      else if (field === "gender") inputType = "select";

      const colDiv = document.createElement("div");
      colDiv.className = "col-auto input-dynamic";
      if (inputType === "select") {
        colDiv.innerHTML = `
          <label class="form-label fw-bold w-100">${label}</label>
          <select id="${field}" class="form-control form-control-sm">
            <option value="">Ch·ªçn ${label}</option>
            <option value="Nam">Nam</option>
            <option value="N·ªØ">N·ªØ</option>
          </select>
        `;
      } else {
        colDiv.innerHTML = `
          <label class="form-label fw-bold w-100">${label}</label>
          <input type="${inputType}" id="${field}" class="form-control form-control-sm" 
                placeholder="${label}" 
                ${field === "ma_hs" || field === "full_name" || field === "staff_id" ? "required" : ""}
                ${inputType === "tel" ? 'pattern="[0-9]{10,11}" title="S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10-11 ch·ªØ s·ªë"' : ""}
                ${inputType === "email" ? 'pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,}$" title="Email kh√¥ng h·ª£p l·ªá"' : ""}>
        `;
      }
      rowDiv.appendChild(colDiv);
      if ((index + 1) % 5 === 0) {
        container.appendChild(rowDiv);
        rowDiv = document.createElement("div");
        rowDiv.className = "row g-2 mb-2 w-100 d-flex";
      }
    });

    if (rowDiv.childElementCount > 0) {
      container.appendChild(rowDiv);
      console.log(`DEBUG: ƒê√£ th√™m h√†ng cu·ªëi v·ªõi ${rowDiv.childElementCount} input`);
    }

    // Th√™m n√∫t Add
    const buttonRow = document.createElement("div");
    buttonRow.className = "row g-2 mt-2 w-100 input-dynamic";
    buttonRow.innerHTML = `
      <div class="col-auto d-grid">
        <button class="btn btn-success btn-sm" onclick="addEmployee()">‚ûï Th√™m</button>
      </div>
    `;
    container.appendChild(buttonRow);
    console.log("DEBUG: ƒê√£ th√™m n√∫t Th√™m");
  }

  // T·∫£i d·ªØ li·ªáu
  try {
    await fetchAndRenderDept(dept);
    console.log("DEBUG: switchDept ho√†n t·∫•t");
  } catch (err) {
    console.error(`‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu cho ${dept}:`, err);
    alert(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu cho ${dept}. Vui l√≤ng th·ª≠ l·∫°i.`);
    container.innerHTML += '<div class="text-center text-danger mt-2">L·ªói t·∫£i d·ªØ li·ªáu.</div>';
  }
}

async function fetchAndRenderDept(dept) {
  console.log(`DEBUG: fetchAndRenderDept b·∫Øt ƒë·∫ßu cho ${dept}`);
  try {
    const res = await fetch(`/api/employees?dept=${dept}`, { credentials: "include" });
    if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
    const result = await res.json();
    if (result.error) throw new Error(result.error);
    const rows = result.rows.map(row => ({
      // Map backend columns to frontend fields
      ma_hs: row.ma_hs,
      ma_gv: row.ma_gv,
      ma_lop: row.ma_lop,
      full_name: row.ho_va_ten,
      birth_date: row.ngay_sinh,
      gender: row.gioi_tinh,
      ethnicity: row.dan_toc,
      identifier_code: row.ma_dinh_danh,
      father_name: row.ho_ten_bo,
      father_job: row.nghe_nghiep_bo,
      mother_name: row.ho_ten_me,
      mother_job: row.nghe_nghiep_me,
      household_address: row.ho_khau,
      parent_id_card: row.cccd_bo_me,
      parent_phone: row.sdt,
      staff_id: row.ma_gv,
      nick_name: row.ten_tk,
      team: row.chuc_vu,
      hometown: row.que_quan,
      cccd: row.cccd,
      cccd_issued_date: row.ngay_cap,
      tax_code: row.mst,
      cmnd: row.cmnd,
      insurance_number: row.so_bh,
      phone_number: row.sdt,
      bank_account: row.tk_nh,
      email: row.email,
      blood_type: row.nhom_mau,
      address: row.dia_chi
    }));
    console.log(`DEBUG: ƒê√£ l·∫•y ${rows.length} h√†ng cho ${dept}`);
    renderTable(`table_${dept.toLowerCase()}`, rows);
  } catch (err) {
    console.error(`‚ùå L·ªói khi l·∫•y d·ªØ li·ªáu cho ${dept}:`, err);
    throw err;
  }
}

function renderTable(tableId, rows) {
  console.log(`DEBUG: renderTable b·∫Øt ƒë·∫ßu cho ${tableId}, s·ªë h√†ng: ${rows.length}`);
  const table = document.getElementById(tableId)?.querySelector("tbody");
  if (!table) {
    console.error(`‚ùå Kh√¥ng t√¨m th·∫•y tbody trong ${tableId}`);
    alert(`L·ªói: Kh√¥ng t√¨m th·∫•y b·∫£ng ${tableId}.`);
    return;
  }
  table.innerHTML = "";
  rows.forEach((row, idx) => {
    const tr = document.createElement("tr");
    tr.setAttribute("data-id", row.ma_hs || row.staff_id || idx);
    tr.innerHTML = generateRowHtml(tableId, row, idx + 1);
    table.appendChild(tr);
  });
  console.log(`DEBUG: renderTable ho√†n t·∫•t cho ${tableId}`);
}

function generateRowHtml(tableId, row, index) {
  console.log(`DEBUG: generateRowHtml cho ${tableId}, h√†ng ${index}`);

  if (tableId === "table_hs") {
    console.log(`DEBUG: T·∫°o h√†ng HS v·ªõi d·ªØ li·ªáu: ${JSON.stringify(row)}`);

    const deleteButton = (currentUser === "kimnhung" || userRole === "administrator")
      ? `<td><button class="btn btn-sm btn-danger" onclick="deleteRowHS('${row.ma_hs || index}')">X√≥a</button></td>`
      : `<td></td>`;

    return `
      <td>${index}</td>
      <td>${row.ma_hs || ""}</td>
      <td>${row.ma_gv || ""}</td>
      <td>${row.ma_lop || ""}</td>
      <td>${row.full_name || ""}</td>
      <td>${formatDate(row.birth_date)}</td>
      <td>${row.gender || ""}</td>
      <td>${row.ethnicity || ""}</td>
      <td>${row.identifier_code || ""}</td>
      <td>${row.father_name || ""}</td>
      <td>${row.father_job || ""}</td>
      <td>${row.mother_name || ""}</td>
      <td>${row.mother_job || ""}</td>
      <td>${row.household_address || ""}</td>
      <td>${row.parent_id_card || ""}</td>
      <td>${row.parent_phone || ""}</td>
      ${deleteButton}
    `;
  }

  if (tableId === "table_gv") {
    console.log(`DEBUG: T·∫°o h√†ng GV v·ªõi d·ªØ li·ªáu: ${JSON.stringify(row)}`);

    const deleteButton = (currentUser === "kimnhung" || userRole === "administrator")
      ? `<td><button class="btn btn-sm btn-danger" onclick="deleteRowGV('${row.staff_id || index}')">X√≥a</button></td>`
      : `<td></td>`;

    return `
      <td>${index}</td>
      <td>${row.staff_id || ""}</td>
      <td>${row.full_name || ""}</td>
      <td>${row.nick_name || ""}</td>
      <td>${row.team || ""}</td>
      <td>${formatDate(row.birth_date)}</td>
      <td>${row.hometown || ""}</td>
      <td>${row.cccd || ""}</td>
      <td>${formatDate(row.cccd_issued_date)}</td>
      <td>${row.tax_code || ""}</td>
      <td>${row.cmnd || ""}</td>
      <td>${row.insurance_number || ""}</td>
      <td>${row.phone_number || ""}</td>
      <td>${row.bank_account || ""}</td>
      <td>${row.email || ""}</td>
      <td>${row.blood_type || ""}</td>
      <td>${row.address || ""}</td>
      ${deleteButton}
    `;
  }
  console.log(`DEBUG: Kh√¥ng kh·ªõp tableId: ${tableId}`);
  return "";
}

function formatDate(dateStr) {
  if (!dateStr || isNaN(new Date(dateStr))) return "";
  const d = new Date(dateStr);
  return d.getDate().toString().padStart(2, '0') + "/" +
         (d.getMonth() + 1).toString().padStart(2, '0') + "/" +
         d.getFullYear();
}
async function addEmployee() {
    const dept = document.getElementById("deptSelect").value;
    if (!dept || !schemaByDept[dept]) {
        alert("Please select a department.");
        return;
    }
    const data = { "Dept": dept };
    schemaByDept[dept].forEach(field => {
        data[field] = document.getElementById(field)?.value.trim() || "";
    });
    if (dept === "GV" && (!data["staff_id"] || !data["full_name"])) {
        alert("Staff ID and Full Name are required.");
        return;
    } else if (dept === "HS" && (!data["ma_hs"] || !data["ho_va_ten"])) {
        alert("M√£ HS v√† H·ªç v√† T√™n l√† b·∫Øt bu·ªôc.");
        return;
    }
    try {
        const res = await fetch("/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.status === "ok") {
            window.location.href = "/employees";
        } else {
            alert("‚ùå Failed to add employee: " + (result.message || ""));
        }
    } catch (err) {
        alert("‚ùå Error adding employee: " + err.message);
    }
}

window.addEventListener("DOMContentLoaded", async () => {
    await fetchSchema();
    const lastFile = localStorage.getItem('lastImportedFile');
    if (lastFile) {
        document.getElementById("deptSelect").value = lastFile.includes("hocsinh") ? "HS" : "GV";
        await switchDept();
        localStorage.removeItem('lastImportedFile');
    } else {
        document.getElementById("deptSelect").value = "HS"; // Default to HS
        await switchDept();
    }
});
</script>
