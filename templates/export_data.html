<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Xu·∫•t D·ªØ Li·ªáu</title>
<link href="{{ url_for('static_files', filename='css/styles.css') }}?v=20250716" rel="stylesheet"/>
</head>
<body><div class="container-fluid mt-4"><div class="card"><div class="card-body">
<div class="container-fluid">
<div class="header">
<h1>üì§ Xu·∫•t D·ªØ Li·ªáu</h1>
<div class="nav">
<a href="#" onclick="exportToPDF()">üìÑ Xu·∫•t file PDF</a>
</div>
</div>
<div class="form-group">
<label for="deptSelect">Ch·ªçn Th√¥ng Tin:</label>
<select id="deptSelect" onchange="switchDept()">
<option value="">-- Ch·ªçn --</option>
<option value="HS">H·ªçc Sinh</option>
<option value="GV">Gi√°o Vi√™n</option>
</select>
</div>
<div class="button-group">
<button onclick="exportData()">üì§ Xu·∫•t File - CSV</button>
<button onclick="printData()">In D·ªØ Li·ªáu</button>
<button onclick="closePreview()">ƒê√≥ng</button>
</div>
<div id="preview">
<h2>Xem Tr∆∞·ªõc D·ªØ Li·ªáu</h2>
<div class="table-wrapper">
<table class="table" id="table_hs" style="display: none;">
<thead>
<tr>
<th>STT</th>
<th>H·ªç v√† T√™n</th>
<th>Ng√†y Sinh</th>
<th>Gi·ªõi T√≠nh</th>
<th>D√¢n T·ªôc</th>
<th>M√£ ƒê·ªãnh Danh</th>
<th>H·ªç T√™n Cha</th>
<th>Ng√†nh Ngh·ªÅ Cha</th>
<th>H·ªç T√™n M·∫π</th>
<th>Ng√†nh Ngh·ªÅ M·∫π</th>
<th>ƒê·ªãa Ch·ªâ</th>
<th>S·ªë CMND Cha M·∫π</th>
<th>S·ªë ƒêi·ªán Tho·∫°i Cha M·∫π</th>
</tr>
</thead>
<tbody>
<tr>
<td colspan="13">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
</tr>
</tbody>
</table>
</div>
<div class="table-wrapper">
<table class="table" id="table_gv" style="display: none;">
<thead>
<tr>
<th>STT</th>
<th>M√£ Gi√°o Vi√™n</th>
<th>H·ªç v√† T√™n</th>
<th>T√™n G·ªçi</th>
<th>ƒê·ªôi</th>
<th>Ng√†y Sinh</th>
<th>Qu√™ Qu√°n</th>
<th>CCCD</th>
<th>Ng√†y C·∫•p CCCD</th>
<th>M√£ S·ªë Thu·∫ø</th>
<th>S·ªë CMND</th>
<th>S·ªë BHXH</th>
<th>S·ªë ƒêi·ªán Tho·∫°i</th>
<th>S·ªë T√†i Kho·∫£n</th>
<th>Email</th>
<th>Nh√≥m M√°u</th>
<th>ƒê·ªãa Ch·ªâ</th>
</tr>
</thead>
<tbody>
<tr>
<td colspan="17">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="pdf-export" style="display:none; font-family: 'Times New Roman', Times, serif; font-size: 11px; padding: 20px;">
<h6 style="text-align:left; padding-left:40px;">UBND HUY·ªÜN L√ÇM H√Ä</h6>
<h6 style="text-align:left; font-weight:bold; padding-left:10px;">TR∆Ø·ªúNG M·∫¶M NON HOA H∆Ø·ªöNG D∆Ø∆†NG</h6>
<h3 style="text-align:center; font-weight:bold;">B·∫¢NG K·∫æT QU·∫¢ D·ªÆ LI·ªÜU</h3>
<br/>
<table style="width:100%; border-collapse: collapse; text-align: center; font-size: 10px;">
<thead style="background-color: #cfe2ff;">
<tr id="pdf-header-row"></tr>
</thead>
<tbody id="pdf-body"></tbody>
</table>
<div style="margin-top:40px; text-align:right; font-size:12px; padding-right:40px;">
<p>L√¢m H√†, Ng√†y .... th√°ng .... nƒÉm 20....</p>
<p style="margin-top:5px;"><b>Ng∆∞·ªùi Xu·∫•t D·ªØ Li·ªáu</b></p>
<p style="margin-top:50px;">.................................</p>
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
        async function switchDept() {
            const dept = document.getElementById("deptSelect").value;
            const containerHS = document.getElementById("table_hs");
            const containerGV = document.getElementById("table_gv");
            containerHS.style.display = (dept === "HS") ? "block" : "none";
            containerGV.style.display = (dept === "GV") ? "block" : "none";
            await fetchAndRenderDept(dept);
            }

        async function fetchAndRenderDept(dept) {
            try {
                const res = await fetch(`/api/employees?dept=${dept}`);
                const result = await res.json();
                console.log(result); // Debug API response
                const rows = result.rows || [];
                if (dept === "HS") {
                    renderTable("table_hs", rows);
                } else if (dept === "GV") {
                    renderTable("table_gv", rows);
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                const tableId = dept === "HS" ? "table_hs" : "table_gv";
                const table = document.getElementById(tableId).querySelector("tbody");
                table.innerHTML = `<tr><td colspan="${dept === "HS" ? 13 : 17}">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>`;
            }
        }

        function renderTable(tableId, rows) {
            const table = document.getElementById(tableId).querySelector("tbody");
            table.innerHTML = "";
            if (rows.length === 0) {
                table.innerHTML = `<tr><td colspan="${tableId === "table_hs" ? 13 : 17}">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>`;
                return;
            }
            rows.forEach((row, idx) => {
                const tr = document.createElement("tr");
                tr.innerHTML = generateRowHtml(tableId, row, idx + 1);
                table.appendChild(tr);
            });
        }

        function generateRowHtml(tableId, row, index) {
            if (tableId === "table_hs") {
                return `
                <td>${index}</td>
                <td>${row.ho_va_ten || ""}</td>
                <td>${formatDate(row.ngay_sinh)}</td>
                <td>${row.gioi_tinh || ""}</td>
                <td>${row.dan_toc || ""}</td>
                <td>${row.ma_dinh_danh || ""}</td>
                <td>${row.ho_ten_bo || ""}</td>
                <td>${row.nghe_nghiep_bo || ""}</td>
                <td>${row.ho_ten_me || ""}</td>
                <td>${row.nghe_nghiep_me || ""}</td>
                <td>${row.ho_khau || ""}</td>
                <td>${row.cccd_bo_me || ""}</td>
                <td>${row.sdt || ""}</td>
                `;
            }
            if (tableId === "table_gv") {
                return `
                <td>${index}</td>
                <td>${row.ma_gv || ""}</td>
                <td>${row.ho_va_ten || ""}</td>
                <td>${row.ten_tk || ""}</td>
                <td>${row.chuc_vu || ""}</td>
                <td>${formatDate(row.ngay_sinh)}</td>
                <td>${row.que_quan || ""}</td>
                <td>${row.cccd || ""}</td>
                <td>${formatDate(row.ngay_cap)}</td>
                <td>${row.mst || ""}</td>
                <td>${row.cmnd || ""}</td>
                <td>${row.so_bh || ""}</td>
                <td>${row.sdt || ""}</td>
                <td>${row.tk_nh || ""}</td>
                <td>${row.email || ""}</td>
                <td>${row.nhom_mau || ""}</td>
                <td>${row.dia_chi || ""}</td>
                `;
            }
            return "";
        }

        function formatDate(dateStr) {
            if (!dateStr || isNaN(new Date(dateStr))) return "";
            const d = new Date(dateStr);
            return d.getDate().toString().padStart(2, '0') + "/" +
                   (d.getMonth() + 1).toString().padStart(2, '0') + "/" +
                   d.getFullYear();
        }

        function exportToPDF() {
            const dept = document.getElementById("deptSelect").value;
            if (!dept) {
                alert("Vui l√≤ng ch·ªçn lo·∫°i d·ªØ li·ªáu.");
                return;
            }

            const sourceTableId = dept === "HS" ? "table_hs" : "table_gv";
            const sourceTable = document.getElementById(sourceTableId);
            const rows = sourceTable.querySelectorAll("tbody tr");

            const pdfBody = document.getElementById("pdf-body");
            const pdfHeaderRow = document.getElementById("pdf-header-row");

            // Xo√° n·ªôi dung c≈©
            pdfBody.innerHTML = "";
            pdfHeaderRow.innerHTML = "";

            // Ch√©p header
            const sourceHeader = sourceTable.querySelector("thead tr");
            sourceHeader.querySelectorAll("th").forEach((th, index) => {
                if (dept === "GV" && (index === 1 || index === 3 || index === 4)) return; // ‚ùå B·ªè "M√£ GV" v√† "T√™n G·ªçi"
                const newTh = document.createElement("th");
                newTh.textContent = th.textContent;
                newTh.style.border = "1px solid #000";
                pdfHeaderRow.appendChild(newTh);
            });

            // Ch√©p d·ªØ li·ªáu
            rows.forEach(row => {
                const newRow = document.createElement("tr");
                newRow.style.border = "1px solid #000";
                row.querySelectorAll("td").forEach((cell, index) => {
                    if (dept === "GV" && (index === 1 || index === 3 || index === 4)) return; // ‚ùå B·ªè "M√£ GV" v√† "T√™n G·ªçi"
                    const td = document.createElement("td");
                    td.textContent = cell.textContent;
                    td.style.border = "1px solid #000";
                    //td.style.whiteSpace = "nowrap";
                    //td.style.overflow = "hidden";
                    //td.style.textOverflow = "ellipsis";
                    newRow.appendChild(td)
                });
                pdfBody.appendChild(newRow);
            });

            // Hi·ªÉn th·ªã ƒë·ªÉ export
            const exportDiv = document.getElementById("pdf-export");
            exportDiv.style.display = "block";
            // üîΩ Gi·∫£m font n·∫øu l√† b·∫£ng Gi√°o Vi√™n
            exportDiv.style.fontSize = dept === "GV" ? "8px" : "10px";

            const opt = {
                margin: 0, // ‚ùó KH√îNG C√ì L·ªÄ
                filename: dept === "HS" ? "hoc_sinh.pdf" : "giao_vien.pdf",
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
            };

            html2pdf().from(exportDiv).set(opt).save().then(() => {
                exportDiv.style.display = "none";
            });
        }

        function printData() {
            const dept = document.getElementById("deptSelect").value;
            const table = dept === "HS" ? document.getElementById("table_hs") : document.getElementById("table_gv");

            if (!dept || table.style.display === "none") {
                alert("Vui l√≤ng ch·ªçn lo·∫°i d·ªØ li·ªáu c·∫ßn in.");
                return;
            }

            const printWindow = window.open('', '_blank');
            const style = `
            <style>
                table {
                width: 100%;
                border-collapse: collapse;
                font-family: Arial, sans-serif;
                }
                th, td {
                border: 1px solid #ccc;
                padding: 8px;
                font-size: 10px;
                }
                th {
                background-color: #007bff;
                color: #fff;
                text-align: center;
                }
                tr:nth-child(even) {
                background-color: #f9f9f9;
                }
            </style>
            `;
            printWindow.document.write(`
            <html>
                <head>
                <title>In D·ªØ Li·ªáu</title>
                ${style}
                </head>
                <body>
                <h2>D·ªØ Li·ªáu ${dept === "HS" ? "H·ªçc Sinh" : "Gi√°o Vi√™n"}</h2>
                ${table.outerHTML}
                </body>
            </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }


        function exportData() {
            const dataType = document.getElementById('deptSelect').value;
            let csvContent = '';
            let filename = '';
            let rows = [];
            // Get data from the visible table
            const tableId = dataType === 'HS' ? 'table_hs' : 'table_gv';
            const table = document.getElementById(tableId).querySelector('tbody');
            const tableRows = table.querySelectorAll('tr');
            if (dataType === 'HS') {
                filename = 'student_data.csv';
                csvContent = [
                    'STT,H·ªç v√† T√™n,Ng√†y Sinh,Gi·ªõi T√≠nh,D√¢n T·ªôc,M√£ ƒê·ªãnh Danh,H·ªç T√™n Cha,Ng√†nh Ngh·ªÅ Cha,H·ªç T√™n M·∫π,Ng√†nh Ngh·ªÅ M·∫π,ƒê·ªãa Ch·ªâ,S·ªë CMND Cha M·∫π,S·ªë ƒêi·ªán Tho·∫°i Cha M·∫π',
                    ...Array.from(tableRows).map((row, idx) => {
                        const cells = row.querySelectorAll('td');
                        return [
                            cells[0].textContent,
                            `"${cells[1].textContent}"`,
                            cells[2].textContent,
                            cells[3].textContent,
                            cells[4].textContent,
                            cells[5].textContent,
                            `"${cells[6].textContent}"`,
                            `"${cells[7].textContent}"`,
                            `"${cells[8].textContent}"`,
                            `"${cells[9].textContent}"`,
                            `"${cells[10].textContent}"`,
                            cells[11].textContent,
                            cells[12].textContent
                        ].join(',');
                    })
                ].join('\n');
            } else if (dataType === 'GV') {
                filename = 'teacher_data.csv';
                csvContent = [
                    'STT,M√£ Gi√°o Vi√™n,H·ªç v√† T√™n,T√™n G·ªçi,ƒê·ªôi,Ng√†y Sinh,Qu√™ Qu√°n,CCCD,Ng√†y C·∫•p CCCD,M√£ S·ªë Thu·∫ø,S·ªë CMND,S·ªë BHXH,S·ªë ƒêi·ªán Tho·∫°i,S·ªë T√†i Kho·∫£n,Email,Nh√≥m M√°u,ƒê·ªãa Ch·ªâ',
                    ...Array.from(tableRows).map((row, idx) => {
                        const cells = row.querySelectorAll('td');
                        return [
                            cells[0].textContent,
                            cells[1].textContent,
                            `"${cells[2].textContent}"`,
                            `"${cells[3].textContent}"`,
                            `"${cells[4].textContent}"`,
                            cells[5].textContent,
                            `"${cells[6].textContent}"`,
                            cells[7].textContent,
                            cells[8].textContent,
                            cells[9].textContent,
                            cells[10].textContent,
                            cells[11].textContent,
                            cells[12].textContent,
                            cells[13].textContent,
                            cells[14].textContent,
                            cells[15].textContent,
                            `"${cells[16].textContent}"`
                        ].join(',');
                    })
                ].join('\n');
            }
            if (csvContent && dataType) {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                URL.revokeObjectURL(link.href);
            } else {
                alert('Vui l√≤ng ch·ªçn lo·∫°i d·ªØ li·ªáu tr∆∞·ªõc khi xu·∫•t.');
            }
        }

        function closePreview() {
            document.getElementById('preview').style.display = 'none';
            document.getElementById('data-type').value = '';
            document.getElementById('table_hs').style.display = 'none';
            document.getElementById('table_gv').style.display = 'none';
        }
    </script>
</div></div></div></body>
</html>