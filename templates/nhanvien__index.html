
<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <title>- QU·∫¢N L√ù NH√ÇN S·ª∞ -</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    #last-assessment, #total-score-table-body {
        display: block;
    }
    .hidden {
        display: none;
    }
    .input-row .form-control-sm {
      min-width: 140px;
      max-width: 180px;
    }
    .input-dynamic {
      margin-bottom: 5px;
    }
    @media (max-width: 1200px) {
      .input-row .form-control-sm {
        min-width: 120px;
        max-width: 100%;
      }
    }
    #staff_id {
      max-width: 120px;
    }
    #nick_name, #team {
      max-width: 150px;
    }
    .input-row .col-auto:last-child button {
      white-space: nowrap;
    }
    .input-row {
      flex-wrap: wrap;
      gap: 8px;
    }
    .table-responsive {
      overflow-x: auto;
    }
    .table-sm td, .table-sm th {
      font-size: 13px;
      padding: 4px 6px;
    }
    .table-responsive {
    overflow-x: auto;
    width: 100%;
    }
    .table-responsive table {
      min-width: 1200px; /* √©p chi·ªÅu ngang t·ªëi thi·ªÉu cho scroll */
    }

    .table-sm td, .table-sm th {
      font-size: 13px;
      padding: 6px 8px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 160px;
    }
    .table-sm th {
      background-color: #343a40;
      color: white;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .table-sm td {
      vertical-align: middle;
    }
    .table-sm td:last-child {
      max-width: 200px; /* TƒÉng chi·ªÅu r·ªông ƒë·ªÉ ch·ª©a c·∫£ hai n√∫t */
      overflow: visible; /* NgƒÉn ·∫©n n·ªôi dung */
    }
    .btn-sm {
      padding: 2px 6px; /* Gi·∫£m padding */
      margin-right: 4px; /* Gi·∫£m kho·∫£ng c√°ch */
    }
    .inline-edit {
        border: none;
        background: transparent;
        width: 100%;
        padding: 0;
        font-size: inherit;
        line-height: inherit;
    }
    .inline-edit:focus {
        border: 1px solid #ccc;
        background: #fff;
        padding: 2px;
    }
    /* Style b·ªï sung ƒë·ªÉ l√†m ƒë·∫πp b·∫£ng */
    .table-sm tr:nth-child(even) {
        background-color: #f8f9fa; /* M√†u n·ªÅn xen k·∫Ω cho h√†ng ch·∫µn */
    }

    .table-sm tr:hover {
        background-color: #e9ecef; /* Hi·ªáu ·ª©ng hover cho h√†ng */
    }

    .table-sm td, .table-sm th {
        border: 1px solid #dee2e6; /* ƒê∆∞·ªùng vi·ªÅn cho √¥ */
    }

    .table-sm th {
        background-color: #007bff; /* M√†u n·ªÅn ti√™u ƒë·ªÅ xanh d∆∞∆°ng */
        color: white;
        text-align: center;
    }

    .table-sm td {
        text-align: center; /* CƒÉn gi·ªØa n·ªôi dung */
    }

    .table-sm td:last-child {
        max-width: 100px; /* ƒê·∫£m b·∫£o c·ªôt H√†nh ƒê·ªông kh√¥ng qu√° r·ªông */
    }

    .btn-sm {
        background-color: #007bff; /* M√†u xanh d∆∞∆°ng cho n√∫t */
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
    }

    .btn-sm:hover {
        background-color: #0056b3; /* M√†u xanh ƒë·∫≠m h∆°n khi hover */
    }

    /* ƒê·∫£m b·∫£o dropdown ƒë·∫πp h∆°n */
    .form-control-sm {
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #ced4da;
        background-color: #fff;
        cursor: pointer;
    }

    .form-control-sm:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
    }
  </style>
  
</head>
<body class="p-4">
  <div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="mb-0 d-flex align-items-center gap-3">
        üìã - QU·∫¢N L√ù NH√ÇN S·ª∞ -
      </h1>
      <div class="d-flex align-items-center gap-2">
        <span class="text-muted" data-bs-toggle="tooltip" title="Username: {{ user }}&#10;Role: {{ role }}&#10;Password Expiry: {{ password_expiry }}">
          üë§ {{ user }} ({{ role }})
        </span>
        <button class="btn btn-outline-secondary btn-sm" onclick="openChangePassModal('{{ user }}')">
          üîê Change Pass
        </button>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="btn-group flex-wrap">
        {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
        <div class="d-flex flex-wrap align-items-center gap-2 mb-3" style="max-width: 100%; overflow-x: auto; padding: 5px 0;">
          <a href="/users" class="btn btn-outline-secondary">üë• T√†i Kho·∫£n</a>
          <a href="/data_epa" class="btn btn-outline-primary">üìù B·∫£ng ƒê√°nh Gi√°</a>
          <a href="/epa_summary" class="btn btn-outline-info">üìä Bi·ªÉu ƒë·ªì x·∫øp h·∫°ng</a>
          <a href="/export-data" class="btn btn-outline-success">üì§ Xu·∫•t D·ªØ Li·ªáu</a>
          <a href="/stats" class="btn btn-outline-secondary">üìä Th√¥ng tin</a>
          <a href="/logs" class="btn btn-outline-secondary">üìú Nh·∫≠t K√Ω</a>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-primary" onclick="document.getElementById('excelFileInput').click()">
              üì• Nh·∫≠p D·ªØ Li·ªáu T·ª´ T·ªáp Excel
            </button>
            <input type="file" id="excelFileInput" accept=".xlsx" hidden onchange="importExcel()">
          </div>
          {% if session['role'] == 'admin' %}
          <button class="btn btn-outline-primary" onclick="updateDataBase()"> C·∫≠p Nh·∫≠t D·ªØ Li·ªáu</button> 
          <div id="dbStructureResult" class="mt-3 table-responsive"></div>  
          <button class="btn btn-warning" onclick="removeDeptData()">üóë X√≥a B·∫£ng D·ªØ Li·ªáu</button>
          {% endif %}
          <a href="/admin/questions" class="btn btn-warning">üìù C√¢u H·ªèi ƒê√°nh Gi√°</a>
          <a href="/thoigianmoepa" class="btn btn-warning">üìù ƒê·∫∑t Th·ªùi Gian Ch·∫•m EPA</a>
        </div>
        {% endif %}
        {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
        <!-- Dept select ri√™ng d√≤ng -->
        <div class="row g-2 mb-2">
          <div class="col-auto">
            <label for="deptSelect" class="form-label fw-bold w-100">Dept</label>
            <select id="deptSelect" class="form-select form-select-sm" onchange="switchDept()">
              <option value="">-- Select Dept --</option>
              <option value="HS">HS</option>
              <option value="GV">GV</option>
            </select>
          </div>
          <div>
              <label for="searchInput" class="sr-only">T√¨m ki·∫øm</label>
              <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="üîç T√¨m ki·∫øm..." style="width: 250px;">
          </div>
        </div>
        <!-- C√°c input field s·∫Ω ƒë∆∞·ª£c render ƒë·ªông t·∫°i ƒë√¢y -->
        <div class="row g-2 mb-3 input-row text-center small" id="dynamicInputRow"></div>
        {% endif %}
    <!-- Hi·ªÉn th·ªã n·ªôi dung b·∫£ng dept l√† HS -->
    <div class="table-responsive" id="table_hs" style="overflow-x: auto; display: none;">
      <table class="table table-bordered table-hover text-center align-middle table-sm" style="min-width: 1200px;">
        <thead class="table-dark">
          <tr>
            <th>STT</th>
            <th>M√£ HS</th>
            <th>H·ªç v√† T√™n</th>
            <th>Ng√†y Sinh</th>
            <th>Gi·ªõi T√≠nh</th>
            <th>D√¢n T·ªôc</th>
            <th>M√£ ƒê·ªãnh Danh</th>
            <th>H·ªç T√™n B·ªë</th>
            <th>Ngh·ªÅ Nghi·ªáp B·ªë</th>
            <th>H·ªç T√™n M·∫π</th>
            <th>Ngh·ªÅ Nghi·ªáp M·∫π</th>
            <th>H·ªô Kh·∫©u</th>
            <th>CCCD B·ªë/M·∫π</th>
            <th>SƒêT</th>
            {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
            <th>Action</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for row in data_hs %}
          <tr>
              <td>{{ loop.index }}</td>
              <td>{{ row['ma_hs'] }}</td> <!-- M√£ HS kh√¥ng cho ch·ªânh s·ª≠a -->
              <td>
                  {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
                      <input type="text" class="form-control inline-edit" value="{{ row['ho_va_ten'] }}" onkeypress="saveEdit(event, this, 'Ho Va Ten', '{{ row['ma_hs'] }}', 'HS')">
                  {% else %}
                      {{ row['ho_va_ten'] }}
                  {% endif %}
              </td>
              <td>
                  {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
                      <input type="text" class="form-control inline-edit" value="{{ row['ngay_sinh'].strftime('%d/%m/%Y') if row['ngay_sinh'] else '' }}" onkeypress="saveEdit(event, this, 'Ngay Sinh', '{{ row['ma_hs'] }}', 'HS')">
                  {% else %}
                      {{ row['ngay_sinh'].strftime('%d/%m/%Y') if row['ngay_sinh'] else '' }}
                  {% endif %}
              </td>
              <td>
                  {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
                      <input type="text" class="form-control inline-edit" value="{{ row['gioi_tinh'] }}" onkeypress="saveEdit(event, this, 'Gioi Tinh', '{{ row['ma_hs'] }}', 'HS')">
                  {% else %}
                      {{ row['gioi_tinh'] }}
                  {% endif %}
              </td>
              <td>
                  {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
                      <input type="text" class="form-control inline-edit" value="{{ row['dan_toc'] }}" onkeypress="saveEdit(event, this, 'Dan Toc', '{{ row['ma_hs'] }}', 'HS')">
                  {% else %}
                      {{ row['dan_toc'] }}
                  {% endif %}
              </td>
              <td>
                  {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
                      <input type="text" class="form-control inline-edit" value="{{ row['ma_dinh_danh'] }}" onkeypress="saveEdit(event, this, 'Ma Dinh Danh', '{{ row['ma_hs'] }}', 'HS')">
                  {% else %}
                      {{ row['ma_dinh_danh'] }}
                  {% endif %}
              </td>
              <td>
                  {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
                      <input type="text" class="form-control inline-edit" value="{{ row['ho_ten_bo'] }}" onkeypress="saveEdit(event, this, 'Ho Ten Bo', '{{ row['ma_hs'] }}', 'HS')">
                  {% else %}
                      {{ row['ho_ten_bo'] }}
                  {% endif %}
              </td>
              <td>
                  {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
                      <input type="text" class="form-control inline-edit" value="{{ row['nghe_nghiep_bo'] }}" onkeypress="saveEdit(event, this, 'Nghe Nghiep Bo', '{{ row['ma_hs'] }}', 'HS')">
                  {% else %}
                      {{ row['nghe_nghiep_bo'] }}
                  {% endif %}
              </td>
              <td>
                  {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
                      <input type="text" class="form-control inline-edit" value="{{ row['ho_ten_me'] }}" onkeypress="saveEdit(event, this, 'Ho Ten Me', '{{ row['ma_hs'] }}', 'HS')">
                  {% else %}
                      {{ row['ho_ten_me'] }}
                  {% endif %}
              </td>
              <td>
                  {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
                      <input type="text" class="form-control inline-edit" value="{{ row['nghe_nghiep_me'] }}" onkeypress="saveEdit(event, this, 'Nghe Nghiep Me', '{{ row['ma_hs'] }}', 'HS')">
                  {% else %}
                      {{ row['nghe_nghiep_me'] }}
                  {% endif %}
              </td>
              <td>
                  {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
                      <input type="text" class="form-control inline-edit" value="{{ row['ho_khau'] }}" onkeypress="saveEdit(event, this, 'Ho Khau', '{{ row['ma_hs'] }}', 'HS')">
                  {% else %}
                      {{ row['ho_khau'] }}
                  {% endif %}
              </td>
              <td>
                  {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
                      <input type="text" class="form-control inline-edit" value="{{ row['cccd_bo_me'] }}" onkeypress="saveEdit(event, this, 'Cccd Bo Me', '{{ row['ma_hs'] }}', 'HS')">
                  {% else %}
                      {{ row['cccd_bo_me'] }}
                  {% endif %}
              </td>
              <td>
                  {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
                      <input type="text" class="form-control inline-edit" value="{{ row['sdt'] }}" onkeypress="saveEdit(event, this, 'Sdt', '{{ row['ma_hs'] }}', 'HS')">
                  {% else %}
                      {{ row['sdt'] }}
                  {% endif %}
              </td>
              {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
              <td>
                  <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editModalHS" onclick="populateModalHS('{{ row['ma_hs'] }}', '{{ row['ho_va_ten'] }}', '{{ row['ngay_sinh'].strftime('%d/%m/%Y') if row['ngay_sinh'] else '' }}', '{{ row['gioi_tinh'] }}')">Edit</button>
                  <button class="btn btn-sm btn-danger" onclick="deleteRow('HS', '{{ row['ma_hs'] }}')">Delete</button>
              </td>
              {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <!-- Hi·ªÉn th·ªã n·ªôi dung b·∫£ng dept l√† GV -->
    <div class="table-responsive" id="table_gv" style="overflow-x: auto; display: none;">
      <table class="table table-bordered table-hover text-center align-middle table-sm" style="min-width: 1200px;">
        <thead class="table-dark">
          <tr>
            <th>STT</th>
            <th>M√£ GV</th>
            <th>H·ªç v√† T√™n</th>
            <th>T√™n TK</th>
            <th>Ch·ª©c v·ª•</th>
            <th>Ng√†y Sinh</th>
            <th>Qu√™ Qu√°n</th>
            <th>CCCD</th>
            <th>Ng√†y C·∫•p</th>
            <th>MST</th>
            <th>CMND</th>
            <th>S·ªë BH</th>
            <th>SƒêT</th>
            <th>S·ªë TK</th>
            <th>Email</th>
            <th>Nh√≥m M√°u</th>
            <th>ƒê·ªãa Ch·ªâ</th>
            {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
            <th>Action</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for row in data_gv %}
          <tr data-staff-id="{{ row['ma_gv'] }}">
            <td>{{ loop.index }}</td>
            <td>{{ row['ma_gv'] }}</td>
            <td>{{ row['ho_va_ten'] }}</td>
            <td>{{ row['ten_tk'] }}</td>
            <td>{{ row['chuc_vu'] }}</td>
            <td>{{ row['ngay_sinh'].strftime('%d/%m/%Y') if row['ngay_sinh'] else '' }}</td>
            <td>{{ row['que_quan'] }}</td>
            <td>{{ row['cccd'] }}</td>
            <td>{{ row['ngay_cap'].strftime('%d/%m/%Y') if row['ngay_cap'] else '' }}</td>
            <td>{{ row['mst'] }}</td>
            <td>{{ row['cmnd'] }}</td>
            <td>{{ row['so_bh'] }}</td>
            <td>{{ row['sdt'] }}</td>
            <td>{{ row['tk_nh'] }}</td>
            <td>{{ row['email'] }}</td>
            <td>{{ row['nhom_mau'] }}</td>
            <td>{{ row['dia_chi'] }}</td>
            {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
            <td>
              <button class="btn btn-sm btn-danger" onclick="deleteRowGV('{{ row['ma_gv'] }}')">Delete</button>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <!-- Modal cho HS -->
    <div class="modal" id="editModalHS">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">S·ª≠a th√¥ng tin HS</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="editFormHS">
                        <div class="form-group">
                            <label for="ma_hs">M√£ HS</label>
                            <input type="text" class="form-control" id="ma_hs" name="ma_hs" readonly>
                        </div>
                        <div class="form-group">
                            <label for="ho_va_ten_hs">H·ªç v√† T√™n</label>
                            <input type="text" class="form-control" id="ho_va_ten_hs" name="Ho Va Ten">
                        </div>
                        <div class="form-group">
                            <label for="ngay_sinh_hs">Ng√†y Sinh (dd/mm/yyyy)</label>
                            <input type="text" class="form-control" id="ngay_sinh_hs" name="Ngay Sinh">
                        </div>
                        <div class="form-group">
                            <label for="gioi_tinh_hs">Gi·ªõi T√≠nh</label>
                            <input type="text" class="form-control" id="gioi_tinh_hs" name="Gioi Tinh">
                        </div>
                        <!-- Th√™m c√°c tr∆∞·ªùng kh√°c nh∆∞ ma_gv, dan_toc, v.v. n·∫øu c·∫ßn -->
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="saveEdit('HS')">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal cho GV -->
    <div class="modal" id="editModalGV">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">S·ª≠a th√¥ng tin GV</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="editFormGV">
                        <div class="form-group">
                            <label for="ma_gv">M√£ GV</label>
                            <input type="text" class="form-control" id="ma_gv" name="ma_gv" readonly>
                        </div>
                        <div class="form-group">
                            <label for="ho_va_ten_gv">H·ªç v√† T√™n</label>
                            <input type="text" class="form-control" id="ho_va_ten_gv" name="Ho Va Ten">
                        </div>
                        <div class="form-group">
                            <label for="ngay_sinh_gv">Ng√†y Sinh (dd/mm/yyyy)</label>
                            <input type="text" class="form-control" id="ngay_sinh_gv" name="Ngay Sinh">
                        </div>
                        <div class="form-group">
                            <label for="chuc_vu_gv">Ch·ª©c V·ª•</label>
                            <input type="text" class="form-control" id="chuc_vu_gv" name="Chuc Vu">
                        </div>
                        <!-- Th√™m c√°c tr∆∞·ªùng kh√°c nh∆∞ que_quan, cccd, v.v. n·∫øu c·∫ßn -->
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="saveEdit('GV')">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // H√†m 1: Ch·ªânh s·ª≠a th√¥ng tin nh√¢n s·ª±
    function saveEdit(dept) {
        // Ki·ªÉm tra dept h·ª£p l·ªá
        if (!['HS', 'GV'].includes(dept)) {
            alert('Ph√≤ng ban kh√¥ng h·ª£p l·ªá!');
            return;
        }
        // X√°c ƒë·ªãnh bi·ªÉu m·∫´u
        const formId = dept === 'HS' ? 'editFormHS' : 'editFormGV';
        const form = document.getElementById(formId);
        if (!form) {
            alert('Kh√¥ng t√¨m th·∫•y bi·ªÉu m·∫´u!');
            return;
        }
        // Thu th·∫≠p d·ªØ li·ªáu
        const data = {};
        for (let input of form.elements) {
            if (input.name && input.name !== 'ma_hs' && input.name !== 'ma_gv') {
                if (input.value.trim() === '' && input.required) {
                    alert(`Vui l√≤ng ƒëi·ªÅn ${input.name}!`);
                    return;
                }
                data[input.name] = input.value.trim();
            }
        }
        // Ki·ªÉm tra ID
        const idField = dept === 'HS' ? 'ma_hs' : 'ma_gv';
        const id = document.getElementById(idField)?.value;
        if (!id) {
            alert('Kh√¥ng t√¨m th·∫•y ID!');
            return;
        }
        // Ki·ªÉm tra ƒë·ªãnh d·∫°ng ng√†y sinh (n·∫øu c√≥)
        if (data['Ngay Sinh'] && !/^\d{2}\/\d{2}\/\d{4}$/.test(data['Ngay Sinh'])) {
            alert('Ng√†y sinh ph·∫£i c√≥ ƒë·ªãnh d·∫°ng dd/mm/yyyy!');
            return;
        }
        // T·∫°o payload
        const updateData = {
            Dept: dept,
            id: id,
            data: data
        };
        // G·ª≠i y√™u c·∫ßu
        fetch('/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(result => {
            if (result.status === 'ok') {
                alert('C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng');
                location.reload();
            } else {
                alert('C·∫≠p nh·∫≠t th·∫•t b·∫°i: ' + result.reason);
            }
        })
        .catch(error => {
            alert('L·ªói khi g·ª≠i y√™u c·∫ßu: ' + error.message);
        });
    }
    // H√†m ƒëi·ªÅn d·ªØ li·ªáu v√†o modal HS
    function populateModalHS(ma_hs, ho_va_ten, ngay_sinh, gioi_tinh) {
        document.getElementById('ma_hs').value = ma_hs;
        document.getElementById('ho_va_ten_hs').value = ho_va_ten;
        document.getElementById('ngay_sinh_hs').value = ngay_sinh;
        document.getElementById('gioi_tinh_hs').value = gioi_tinh;
    }
    // H√†m ƒëi·ªÅn d·ªØ li·ªáu v√†o modal GV
    function populateModalGV(ma_gv, ho_va_ten, chuc_vu, ngay_sinh) {
        document.getElementById('ma_gv').value = ma_gv;
        document.getElementById('ho_va_ten_gv').value = ho_va_ten;
        document.getElementById('chuc_vu_gv').value = chuc_vu;
        document.getElementById('ngay_sinh_gv').value = ngay_sinh;
    }
    // G·∫Øn h√†m v√†o window
    window.saveEdit = saveEdit;
    window.populateModalHS = populateModalHS;
    window.populateModalGV = populateModalGV;
});
document.addEventListener('DOMContentLoaded', async () => {
    const section = document.getElementById('non-admin-epa-section');
    console.log('[DEBUG] non-admin-epa-section exists:', !!section);
    if (section) {
        await loadYears();
        document.getElementById('year_epa').addEventListener('change', loadEPATable);
    }
});
</script>
<!-- üîß Modal ch·ªânh s·ª≠a gi√°o vi√™n -->
<div class="modal fade" id="editGVModal" tabindex="-1" aria-labelledby="editGVModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ch·ªânh s·ª≠a th√¥ng tin gi√°o vi√™n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editGVForm">
          <input type="hidden" id="edit_ten_tk">
          <div class="row g-3">
            <div class="col-md-6">
              <label>M√£ GV</label>
              <input class="form-control" id="edit_ma_gv">
            </div>
            <div class="col-md-6">
              <label>H·ªç v√† t√™n</label>
              <input class="form-control" id="edit_ho_va_ten">
            </div>
            <div class="col-md-6">
              <label>Ch·ª©c v·ª•</label>
              <input class="form-control" id="edit_chuc_vu">
            </div>
            <div class="col-md-6">
              <label>Ng√†y sinh</label>
              <input type="date" class="form-control" id="edit_ngay_sinh">
            </div>
            <div class="col-md-6">
              <label>Qu√™ qu√°n</label>
              <input class="form-control" id="edit_que_quan">
            </div>
            <div class="col-md-6">
              <label>CCCD</label>
              <input class="form-control" id="edit_cccd">
            </div>
            <div class="col-md-6">
              <label>Ng√†y c·∫•p</label>
              <input type="date" class="form-control" id="edit_ngay_cap">
            </div>
            <div class="col-md-6">
              <label>MST</label>
              <input class="form-control" id="edit_mst">
            </div>
            <div class="col-md-6">
              <label>CMND</label>
              <input class="form-control" id="edit_cmnd">
            </div>
            <div class="col-md-6">
              <label>S·ªï BH</label>
              <input class="form-control" id="edit_so_bh">
            </div>
            <div class="col-md-6">
              <label>SƒêT</label>
              <input class="form-control" id="edit_sdt">
            </div>
            <div class="col-md-6">
              <label>T√†i kho·∫£n NH</label>
              <input class="form-control" id="edit_tk_nh">
            </div>
            <div class="col-md-6">
              <label>Email</label>
              <input class="form-control" id="edit_email">
            </div>
            <div class="col-md-6">
              <label>Nh√≥m m√°u</label>
              <input class="form-control" id="edit_nhom_mau">
            </div>
            <div class="col-md-6">
              <label>ƒê·ªãa ch·ªâ</label>
              <input class="form-control" id="edit_dia_chi">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        <button class="btn btn-primary" onclick="submitGVUpdate()">L∆∞u thay ƒë·ªïi</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="editHSModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Ch·ªânh s·ª≠a th√¥ng tin h·ªçc sinh</h5></div>
      <div class="modal-body">
        <form>
          <input type="hidden" id="edit_ma_hs">
          <div class="row g-3">
            <div class="col-md-6"><label>H·ªç v√† t√™n</label><input class="form-control" id="edit_ho_va_ten_hs"></div>
            <div class="col-md-6"><label>Ng√†y sinh</label><input type="date" class="form-control" id="edit_ngay_sinh"></div>
            <div class="col-md-6"><label>Gi·ªõi t√≠nh</label><input class="form-control" id="edit_gioi_tinh"></div>
            <div class="col-md-6"><label>D√¢n t·ªôc</label><input class="form-control" id="edit_dan_toc"></div>
            <div class="col-md-6"><label>M√£ ƒë·ªãnh danh</label><input class="form-control" id="edit_ma_dinh_danh"></div>
            <div class="col-md-6"><label>H·ªç t√™n b·ªë</label><input class="form-control" id="edit_ho_ten_bo"></div>
            <div class="col-md-6"><label>Ngh·ªÅ b·ªë</label><input class="form-control" id="edit_nghe_nghiep_bo"></div>
            <div class="col-md-6"><label>H·ªç t√™n m·∫π</label><input class="form-control" id="edit_ho_ten_me"></div>
            <div class="col-md-6"><label>Ngh·ªÅ m·∫π</label><input class="form-control" id="edit_nghe_nghiep_me"></div>
            <div class="col-md-6"><label>H·ªô kh·∫©u</label><input class="form-control" id="edit_ho_khau"></div>
            <div class="col-md-6"><label>CCCD b·ªë/m·∫π</label><input class="form-control" id="edit_cccd_bo_me"></div>
            <div class="col-md-6"><label>S·ªë ƒëi·ªán tho·∫°i</label><input class="form-control" id="edit_sdt_hs"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        <button class="btn btn-primary" onclick="submitHSUpdate()">L∆∞u thay ƒë·ªïi</button>
      </div>
    </div>
  </div>
</div>
</body>
</html>
<script>
  async function fetchTeacherOptions() {
    const res = await fetch("/api/teachers");
    const data = await res.json();
    return data; // [{ ma_gv: "...", ho_va_ten: "..." }, ...]
    }
function getInputValues() {
  const dept = document.getElementById("deptSelect").value;
  if (dept === "GV") {
    return {
      "Dept": "GV",
      "Staff ID": document.getElementById("staff_id")?.value.trim(),
      "Full Name": document.getElementById("full_name")?.value.trim(),
      "Nick Name": document.getElementById("nick_name")?.value.trim(),
      "Team": document.getElementById("team")?.value.trim(),
      "Birth Date": document.getElementById("birth_date")?.value,
      "Hometown": document.getElementById("hometown")?.value.trim(),
      "Cccd": document.getElementById("cccd")?.value.trim(),
      "Cccd Issued Date": document.getElementById("cccd_issued_date")?.value,
      "Tax Code": document.getElementById("tax_code")?.value.trim(),
      "Cmnd": document.getElementById("cmnd")?.value.trim(),
      "Insurance Number": document.getElementById("insurance_number")?.value.trim(),
      "Phone Number": document.getElementById("phone_number")?.value.trim(),
      "Bank Account": document.getElementById("bank_account")?.value.trim(),
      "Email": document.getElementById("email")?.value.trim(),
      "Blood Type": document.getElementById("blood_type")?.value.trim(),
      "Address": document.getElementById("address")?.value.trim()
    };
  }
  return {};
}
let schemaByDept = {};

async function fetchSchema() {
  const res = await fetch("/api/table-schema");
  schemaByDept = await res.json();
  switchDept();  // render l·∫ßn ƒë·∫ßu
}

async function switchDept() {
  console.log("DEBUG: switchDept started");
  const dept = document.getElementById("deptSelect").value;
  const container = document.getElementById("dynamicInputRow");
  console.log(`DEBUG: Selected dept: ${dept}`);
  // Reset content
  container.innerHTML = "";
  console.log("DEBUG: Container content reset");
  // Toggle b·∫£ng
  document.getElementById("table_hs").style.display = (dept === "HS") ? "block" : "none";
  document.getElementById("table_gv").style.display = (dept === "GV") ? "block" : "none";
  console.log(`DEBUG: Table HS display: ${document.getElementById("table_hs").style.display}, Table GV display: ${document.getElementById("table_gv").style.display}`);
  // N·∫øu kh√¥ng ch·ªçn ho·∫∑c schema kh√¥ng c√≥ th√¨ d·ª´ng
  if (!dept || !schemaByDept[dept]) {
    console.log(`DEBUG: Invalid dept or schema not found for ${dept}, exiting`);
    return;
  }
  // Render input ƒë·ªông
  console.log(`DEBUG: Rendering inputs for schema: ${schemaByDept[dept]}`);
  let rowDiv = document.createElement("div");
  rowDiv.className = "row g-2 mb-2 w-100 d-flex";
  const teachers = dept === "HS" ? await fetchTeacherOptions() : [];

  for (let index = 0; index < schemaByDept[dept].length; index++) {
    const field = schemaByDept[dept][index];
    const label = field.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
    const colDiv = document.createElement("div");
    colDiv.className = "col-3 col-sm-2 col-md-1 input-dynamic";

    if (field.toLowerCase() === "ma_gv" && dept === "HS") {
      const options = teachers.map(t => `<option value="${t.ma_gv}">${t.ma_gv} - ${t.ho_va_ten}</option>`).join("");
      colDiv.innerHTML = `
        <label class="form-label fw-bold w-100">${label}</label>
        <select id="${field}" class="form-control form-control-sm">
          <option value="">-- Ch·ªçn m√£ GV --</option>
          ${options}
        </select>
      `;
    } else {
      colDiv.innerHTML = `
        <label class="form-label fw-bold w-100">${label}</label>
        <input type="text" id="${field}" class="form-control form-control-sm" placeholder="${label}">
      `;
    }

    rowDiv.appendChild(colDiv);

    if ((index + 1) % 8 === 0) {
      container.appendChild(rowDiv);
      rowDiv = document.createElement("div");
      rowDiv.className = "row g-2 mb-2 w-100 d-flex";
    }
  }

  if (rowDiv.childElementCount > 0) {
    container.appendChild(rowDiv);
  }
  if (dept === "GV") {
    await fetchAndSetNextMaGV();  // ‚úÖ ƒêi·ªÅn m√£ GV g·ª£i √Ω
  }

  // ‚úÖ B∆Ø·ªöC C: G·ªçi API ƒë·ªÉ hi·ªÉn th·ªã m√£ HS t·ª± t·∫°o v√†o input
  if (dept === "HS") {
    try {
      const res = await fetch("/api/next-ma-hs?prefix=HS");
      const result = await res.json();
      if (result.next_ma_hs) {
        const input = document.getElementById("ma_hs");
        if (input && !input.value) {
          input.value = result.next_ma_hs;
          console.log(`DEBUG: Auto-filled ma_hs = ${result.next_ma_hs}`);
        }
      }
    } catch (err) {
      console.error("‚ùå L·ªói khi fetch m√£ HS t·ª± sinh:", err);
    }
  }

  // N√∫t Add
  const buttonRow = document.createElement("div");
  buttonRow.className = "row g-2 mt-2 w-100 input-dynamic";
  buttonRow.innerHTML = `
    <div class="col-auto d-grid">
      <button class="btn btn-success btn-sm" onclick="addEmployee()">‚ûï Add</button>
    </div>
  `;
  container.appendChild(buttonRow);
  console.log("DEBUG: Added 'Add' button row");

  // Fetch l·∫°i b·∫£ng d·ªØ li·ªáu ƒë√∫ng Dept v·ª´a ch·ªçn
  console.log(`DEBUG: Fetching data for dept: ${dept}`);
  await fetchAndRenderDept(dept);
  console.log("DEBUG: switchDept completed");
}

//T·ª∞ ƒêI·ªÄN ma_gv KHI CH·ªåN "GV"
async function fetchAndSetNextMaGV(prefix = "GV") {
  try {
    const res = await fetch(`/api/next-ma-gv?prefix=${prefix}`);
    const result = await res.json();
    if (result.next_ma_gv) {
      const input = document.getElementById("ma_gv");
      if (input && !input.value) {
        input.value = result.next_ma_gv;
        console.log(`DEBUG: Auto-filled ma_gv = ${result.next_ma_gv}`);
      }
    }
  } catch (err) {
    console.error("‚ùå L·ªói khi fetch m√£ GV t·ª± sinh:", err);
  }
}

async function fetchAndRenderDept(dept) {
  console.log(`DEBUG: fetchAndRenderDept started for dept: ${dept}`);
  try {
    const res = await fetch(`/api/employees?dept=${dept}`);
    console.log(`DEBUG: Fetch response status: ${res.status}`);
    const result = await res.json();
    const rows = result.rows || [];
    console.log(`DEBUG: Fetched ${rows.length} rows for dept: ${dept}`);
    if (dept === "HS") {
      console.log("DEBUG: Rendering HS table");
      renderTable("table_hs", rows);
    } else if (dept === "HS") {
      console.log("DEBUG: Rendering GV table");
      renderTable("table_gv", rows);
    }
  } catch (err) {
    console.error(`‚ùå DEBUG: Fetch failed for dept ${dept}:`, err);
  }
  console.log("DEBUG: fetchAndRenderDept completed");
}
function renderTable(tableId, rows) {
  console.log(`DEBUG: renderTable started for table: ${tableId}, rows: ${rows.length}`);
  const table = document.getElementById(tableId).querySelector("tbody");
  table.innerHTML = "";
  console.log(`DEBUG: Cleared tbody for table: ${tableId}`);
  rows.forEach((row, idx) => {
    console.log(`DEBUG: Generating row ${idx + 1} for table: ${tableId}`);
    const tr = document.createElement("tr");
    tr.innerHTML = generateRowHtml(tableId, row, idx + 1);
    table.appendChild(tr);
  });
  console.log(`DEBUG: renderTable completed for table: ${tableId}`);
}
function generateRowHtml(tableId, row, index) {
  console.log(`DEBUG: generateRowHtml for table: ${tableId}, row index: ${index}`);
  if (tableId === "table_hs") {
    console.log(`DEBUG: Generating HS row with data: ${JSON.stringify(row)}`);
    return `
      <td>${index}</td>
      <td>${row.full_name || ""}</td>
      <td>${formatDate(row.birth_date)}</td>
      <td>${row.gender || ""}</td>
      <td>${row.ethnicity || ""}</td>
      <td>${row.identifier_code || ""}</td>
      <td>${row.father_name || ""}</td>
      <td>${row.father_job || ""}</td>
      <td>${row.mother_name || ""}</td>
      <td>${row.mother_job || ""}</td>
      <td>${row.household_address || ""}</td>
      <td>${row.parent_id_card || ""}</td>
      <td>${row.parent_phone || ""}</td>
    `;
  }
  if (tableId === "table_gv") {
    console.log(`DEBUG: Generating GV row with data: ${JSON.stringify(row)}`);
    return `
      <td>${index}</td>
      <td>${row.staff_id || ""}</td>
      <td>${row.full_name || ""}</td>
      <td>${row.nick_name || ""}</td>
      <td>${row.team || ""}</td>
      <td>${formatDate(row.birth_date)}</td>
      <td>${row.hometown || ""}</td>
      <td>${row.cccd || ""}</td>
      <td>${formatDate(row.cccd_issued_date)}</td>
      <td>${row.tax_code || ""}</td>
      <td>${row.cmnd || ""}</td>
      <td>${row.insurance_number || ""}</td>
      <td>${row.phone_number || ""}</td>
      <td>${row.bank_account || ""}</td>
      <td>${row.email || ""}</td>
      <td>${row.blood_type || ""}</td>
      <td>${row.address || ""}</td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteRowGV('${row.staff_id}')">Delete</button></td>
    `;
  }
  console.log(`DEBUG: No matching tableId: ${tableId}, returning empty string`);
  return "";
}
function formatDate(dateStr) {
  if (!dateStr || isNaN(new Date(dateStr))) return "";
  const d = new Date(dateStr);
  return d.getDate().toString().padStart(2, '0') + "/" +
         (d.getMonth() + 1).toString().padStart(2, '0') + "/" +
         d.getFullYear();
}

// H√†m chu·∫©n h√≥a m√£ b·∫•t k·ª≥ v·ªÅ d·∫°ng XY00000
function normalizeCode(raw) {
  if (!raw) return "";
  raw = raw.trim().toUpperCase();
  const match = raw.match(/^([A-Z√Ä-·ª¥]{2})(\d{1,5})$/);
  if (!match) return raw;
  const prefix = match[1];
  const number = match[2].padStart(5, "0");
  return prefix + number;
}

// L·∫•y m√£ HS ti·∫øp theo
async function getNextMaHS(prefix = "HS") {
  const res = await fetch(`/api/last-ma-hs-prefix?prefix=${prefix}`);
  const result = await res.json();
  const next = result.next_num;
  return result.prefix + next.toString().padStart(5, "0");
}

// L·∫•y m√£ GV ti·∫øp theo
async function getNextMaGV(prefix = "GV") {
  const res = await fetch(`/api/next-ma-gv?prefix=${prefix}`);
  const result = await res.json();
  const next = result.next_num;
  return result.prefix + next.toString().padStart(5, "0");
}

// T·ª± ƒëi·ªÅn m√£ HS
async function fetchAndSetNextMaHS(prefix = "HS") {
  try {
    const res = await fetch(`/api/next-ma-hs?prefix=${prefix}`);
    const result = await res.json();
    if (result.next_ma_hs) {
      const input = document.getElementById("ma_hs");
      if (input && !input.value) {
        input.value = result.next_ma_hs;
      }
    }
  } catch (err) {
    console.error("‚ùå L·ªói khi l·∫•y m√£ HS t·ª± ƒë·ªông:", err);
  }
}

// T·ª± ƒëi·ªÅn m√£ GV
async function fetchAndSetNextMaGV(prefix = "GV") {
  try {
    const res = await fetch(`/api/next-ma-gv?prefix=${prefix}`);
    const result = await res.json();
    if (result.next_ma_gv) {
      const input = document.getElementById("ma_gv");
      if (input && !input.value) {
        input.value = result.next_ma_gv;
      }
    }
  } catch (err) {
    console.error("‚ùå L·ªói khi l·∫•y m√£ GV t·ª± ƒë·ªông:", err);
  }
}

async function addEmployee() {
  const dept = document.getElementById("deptSelect").value;
  if (!dept || !schemaByDept[dept]) {
    alert("Please select a department.");
    return;
  }
  const data = { "Dept": dept };  // ‚úÖ b√°o backend
  schemaByDept[dept].forEach(field => {
    const key = field.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
    let value = document.getElementById(field)?.value?.trim() || "";
    if (dept === "HS" && field === "ma_hs") {
      if (!value) {
        value = "HS";  // m·∫∑c ƒë·ªãnh
      }
      const match = value.match(/^([A-Z√Ä-·ª¥]{2})(\d{0,5})$/);
      if (match) {
        const prefix = match[1];
        const num = match[2];

        if (!num) {
          // G·ªçi API ƒë·ªÉ l·∫•y s·ªë ti·∫øp theo
          getNextMaHS(prefix).then(autoCode => {
            const confirmed = confirm(`B·∫°n ch∆∞a nh·∫≠p m√£ HS ho·∫∑c nh·∫≠p thi·∫øu. H·ªá th·ªëng g·ª£i √Ω: ${autoCode}. B·∫°n c√≥ mu·ªën d√πng kh√¥ng?`);
            if (confirmed) {
              document.getElementById(field).value = autoCode;
              data[key] = autoCode;
            }
          });
        } else {
          const normalized = prefix + num.padStart(5, "0");
          if (normalized !== value) {
            const confirmed = confirm(`B·∫°n nh·∫≠p "${value}", c√≥ mu·ªën d√πng "${normalized}" kh√¥ng?`);
            if (!confirmed) return;
            value = normalized;
            document.getElementById(field).value = normalized;
          }
        }
      }
    }
    data[key] = value;
  });

  if (dept === "HS" && (!data["Ma Hs"] || !data["Ho Va Ten"])) {
    alert("M√£ HS v√† H·ªç v√† T√™n l√† b·∫Øt bu·ªôc.");
    return;
  }
  const res = await fetch("/add", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
  const result = await res.json();
  if (result.status === "ok") {
    window.location.href = "/employees";
  } else {
    alert("‚ùå Failed to add employee: " + (result.message || ""));
  }
}
window.addEventListener("DOMContentLoaded", async () => {
  await fetchSchema();
  const lastFile = localStorage.getItem('lastImportedFile');
  if (lastFile) {
    if (lastFile.includes("hocsinh")) {
      document.getElementById("deptSelect").value = "HS";
    } else if (lastFile.includes("giaovien")) {
      document.getElementById("deptSelect").value = "GV";
    }
    await switchDept();
    localStorage.removeItem('lastImportedFile');
  }
});

function editCell(td, column) {
  const original = td.innerText.trim();
  const index = td.parentElement.getAttribute("data-index");
  const dept = document.getElementById("deptSelect").value;
  td.innerHTML = `
    <input type='text' class='form-control form-control-sm'
      value='${original}'
      onkeydown='saveEdit(event, this, "${column}", ${index}, "${dept}")'
      onblur='saveOnBlur(this, "${column}", ${index}, "${original}", "${dept}")'>
  `;
  td.querySelector("input").focus();
}
async function saveOnBlur(input, column, index, original, dept) {
  const value = input.value.trim();
  if (value === original) return;
  const res = await fetch("/update", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ [column]: value, index: index, Dept: dept })
  });
  const result = await res.json();
  if (result.status === "ok") {
    location.reload();
  } else {
    alert("Update failed");
  }
}
async function saveEdit(e, input, column, index, dept) {
  if (e.key === "Enter") {
    const value = input.value.trim();
    const data = { [column]: value, index: index, Dept: dept };
    const res = await fetch("/update", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    const result = await res.json();
    if (result.status === "ok") {
      location.reload();
    } else {
      alert("Update failed");
    }
  } else if (e.key === "Escape") {
    location.reload();
  }
}
async function deleteRow(btn) {
  if (!confirm("Are you sure you want to delete this employee?")) return;
  const staffId = btn.closest("tr").getAttribute("data-staff-id");
  const dept = document.getElementById("deptSelect").value;
  const res = await fetch("/delete", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ staff_id: staffId, dept: dept })  // ‚úÖ G·ª≠i th√™m dept
  });
  const result = await res.json();
  if (result.status === "ok") {
    btn.closest("tr").remove();
  } else {
    alert("‚ùå Delete failed: " + (result.reason || ""));
  }
}
async function importExcel() {
  console.log("importExcel() called");   // üí• Th√™m d√≤ng n√†y ƒë·ªÉ debug xem ƒë√£ g·ªçi ch∆∞a
  const dept = document.getElementById("deptSelect").value;
  const input = document.getElementById('excelFileInput');
  const file = input.files[0];
  if (!file) {
    console.log("‚ö†Ô∏è No file selected");
    return;
  }
  if (!dept) {
    alert("‚ö†Ô∏è B·∫°n ch∆∞a ch·ªçn Dept.");
    return;
  }
  const formData = new FormData();
  formData.append('file', file);
  let endpoint = "";
  switch (dept) {
    case "HS":
      endpoint = "/import_hs";
      break;
    case "GV":
      endpoint = "/import_gv";  // ‚úÖ Th√™m d√≤ng n√†y
      break;
    default:
      alert(`‚ö†Ô∏è Dept ${dept} ch∆∞a h·ªó tr·ª£ import.`);
      return;
  }
  console.log(`Uploading file to: ${endpoint}`);  // üí• Th√™m d√≤ng n√†y n·ªØa ƒë·ªÉ confirm endpoint
  try {
    const res = await fetch(endpoint, {
      method: "POST",
      body: formData
    });
    const result = await res.json();
    if (result.status === "success") {
      alert("‚úÖ Import th√†nh c√¥ng!");
      window.location.reload();
    } else {
      alert("‚ùå Import l·ªói: " + (result.error || ""));
    }
  } catch (err) {
    console.error(err);
    alert("‚ùå C√≥ l·ªói x·∫£y ra khi upload file.");
  }
}
function loadDataForDept(dept) {
  fetch(`/api/employees?dept=${dept}`)
    .then(res => res.json())
    .then(data => {
      if (!data.rows) {
        alert("‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.");
        return;
      }
      const tableId = `table_${dept.toLowerCase()}`;
      const table = document.getElementById(tableId);
      if (!table) {
        alert(`‚ùå Kh√¥ng t√¨m th·∫•y b·∫£ng v·ªõi id ${tableId}`);
        return;
      }
      const tbody = table.querySelector("tbody");
      const thead = table.querySelector("thead");
      if (!tbody || !thead) {
        alert("‚ùå B·∫£ng kh√¥ng c√≥ thead ho·∫∑c tbody.");
        return;
      }
      // Clear n·ªôi dung c≈©
      tbody.innerHTML = "";
      if (data.rows.length === 0) {
        tbody.innerHTML = "<tr><td colspan='99' class='text-center text-danger'>Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>";
        return;
      }
      for (const row of data.rows) {
        const headers = Object.keys(row);
        const tr = document.createElement("tr");
        tr.innerHTML = headers.map(h => `<td>${row[h] ?? ""}</td>`).join("");
        tbody.appendChild(tr);
      }
    })
    .catch(err => {
      alert("‚ùå L·ªói khi load d·ªØ li·ªáu: " + err);
    });
}
async function importFile(dept, file) {
  const formData = new FormData();
  formData.append('file', file);
  const endpointMap = {
    HS: "/import_hs",
    GV: "/import_gv"
  };
  const endpoint = endpointMap[dept];
  if (!endpoint) {
    alert(`Dept kh√¥ng h·ªó tr·ª£ import: ${dept}`);
    return;
  }
  try {
    const res = await fetch(endpoint, {
      method: "POST",
      body: formData
    });
    const result = await res.json();
    if (result.status === "success") {
      alert("‚úÖ Import th√†nh c√¥ng!");
      await fetchAndRenderDept(dept);
    } else {
      alert("‚ùå L·ªói import: " + (result.error || ""));
    }
  } catch (err) {
    console.error(err);
    alert("‚ùå C√≥ l·ªói x·∫£y ra khi upload file.");
  }
}
async function fetchAndRenderDept(dept) {
  try {
    const res = await fetch(`/api/employees?dept=${dept}`);
    const result = await res.json();
    const rows = result.rows || [];
    if (dept === "HS") {
      renderHS(rows);
    } else if (dept === "GV") {
      renderGV(rows);  // ‚úÖ Th√™m d√≤ng n√†y ƒë·ªÉ h·ªó tr·ª£ gi√°o vi√™n
    }
  } catch (err) {
    console.error("‚ùå Fetch th·∫•t b·∫°i:", err);
  }
}
// Render b·∫£ng h·ªçc sinh
function renderHS(rows) {
  console.log(`DEBUG: renderHS started, rows: ${rows.length}`);
  const tbody = document.querySelector("#table_hs tbody");
  tbody.innerHTML = "";
  rows.forEach((row, index) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${row.ma_hs || ""}</td>
      <td>${row.ho_va_ten || ""}</td>
      <td>${formatDate(row.ngay_sinh)}</td>
      <td>${row.gioi_tinh || ""}</td>
      <td>${row.dan_toc || ""}</td>
      <td>${row.ma_dinh_danh || ""}</td>
      <td>${row.ho_ten_bo || ""}</td>
      <td>${row.nghe_nghiep_bo || ""}</td>
      <td>${row.ho_ten_me || ""}</td>
      <td>${row.nghe_nghiep_me || ""}</td>
      <td>${row.ho_khau || ""}</td>
      <td>${row.cccd_bo_me || ""}</td>
      <td>${row.sdt || ""}</td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteRowHS('${row.ma_hs}')">Delete</button></td>
    `;
    tbody.appendChild(tr);
    tr.ondblclick = () => openEditHSModal(row); // üëà G·∫Øn double-click
  });
}
// Render b·∫£ng gi√°o vi√™n
function renderGV(rows) {
  console.log(`DEBUG: renderGV started, rows: ${rows.length}`);
  const tbody = document.querySelector("#table_gv tbody");
  tbody.innerHTML = "";
  console.log("DEBUG: Cleared GV table tbody");
  rows.forEach((row, index) => {
    console.log(`DEBUG: Rendering GV row ${index + 1}: ${JSON.stringify(row)}`);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${row.ma_gv || ""}</td>
      <td>${row.ho_va_ten || ""}</td>
      <td>${row.ten_tk || ""}</td>
      <td>${row.chuc_vu || ""}</td>
      <td>${formatDate(row.ngay_sinh)}</td>
      <td>${row.que_quan || ""}</td>
      <td>${row.cccd || ""}</td>
      <td>${formatDate(row.ngay_cap)}</td>
      <td>${row.mst || ""}</td>
      <td>${row.cmnd || ""}</td>
      <td>${row.so_bh || ""}</td>
      <td>${row.sdt || ""}</td>
      <td>${row.tk_nh || ""}</td>
      <td>${row.email || ""}</td>
      <td>${row.nhom_mau || ""}</td>
      <td>${row.dia_chi || ""}</td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteRowGV('${row.ma_gv}')">Delete</button></td>
    `;
    tbody.appendChild(tr);
    tr.ondblclick = () => openEditGVModal(row);
  });
  console.log("DEBUG: renderGV completed");
}
async function deleteRowHS(identifier_code) {
  if (!confirm(`X√≥a h·ªçc sinh M√£ ƒê·ªãnh Danh: ${identifier_code}?`)) return;
  await deleteRow("HS", identifier_code);
}
async function deleteRowGV(staff_id) {
  if (!confirm(`X√≥a gi√°o vi√™n Staff ID: ${staff_id}?`)) return;
  await deleteRow("GV", staff_id);
}
async function deleteRow(dept, id) {
  const res = await fetch("/delete", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ staff_id: id, dept: dept })  // ‚úÖ TH√äM dept v√†o ƒë√¢y
  });
  const result = await res.json();
  if (result.status === "ok") {
    alert("‚úÖ X√≥a th√†nh c√¥ng!");
    await fetchAndRenderDept(dept);
  } else {
    alert("‚ùå X√≥a th·∫•t b·∫°i: " + (result.reason || ""));
  }
}
function removeDeptData() {
    const dept = document.getElementById("deptSelect").value;
    if (!dept) return alert("Please select a Dept first.");
    if (!confirm(`Are you sure to remove all data from ${dept}?`)) return;
    fetch(`/remove-dept-data`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ dept }),
    })
    .then(res => res.json())
    .then(data => alert(data.message))
    .catch(err => alert("Error: " + err));
  }
  function updateDataBase() {
    fetch("/update-database", { method: "POST" })
      .then(response => response.json())
      .then(data => {
        const container = document.getElementById("dbStructureResult");
        if (data.success) {
          let html = `<table class="table table-bordered table-sm"><thead><tr>
            <th>T√™n b·∫£ng</th><th>T√™n c√°c c·ªôt</th><th>S·ªë l∆∞·ª£ng c·ªôt</th><th>S·ªë l∆∞·ª£ng d√≤ng</th></tr></thead><tbody>`;
          data.tables.forEach(row => {
            html += `<tr>
              <td>${row.table_name}</td>
              <td>${row.column_names}</td>
              <td>${row.column_count}</td>
              <td>${row.row_count}</td>
            </tr>`;
          });
          html += "</tbody></table>";
          container.innerHTML = html;
        } else {
          container.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
        }
      })
      .catch(error => {
        document.getElementById("dbStructureResult").innerHTML = `<div class="alert alert-danger">L·ªói k·∫øt n·ªëi m√°y ch·ªß.</div>`;
        console.error("‚ùå Update DB error:", error);
      });
  }
</script>
<script>
  function formatDateForInput(dateStr) {
    if (!dateStr) return "";
    const date = new Date(dateStr);
    return date.toISOString().split("T")[0]; // yyyy-mm-dd
  }

  function openEditGVModal(row) {
    document.getElementById("edit_ten_tk").value = row.ten_tk;
    document.getElementById("edit_ma_gv").value = row.ma_gv || "";
    document.getElementById("edit_ho_va_ten").value = row.ho_va_ten || "";
    document.getElementById("edit_chuc_vu").value = row.chuc_vu || "";
    document.getElementById("edit_ngay_sinh").value = formatDateForInput(row.ngay_sinh);
    document.getElementById("edit_que_quan").value = row.que_quan || "";
    document.getElementById("edit_cccd").value = row.cccd || "";
    document.getElementById("edit_ngay_cap").value = formatDateForInput(row.ngay_cap);
    document.getElementById("edit_mst").value = row.mst || "";
    document.getElementById("edit_cmnd").value = row.cmnd || "";
    document.getElementById("edit_so_bh").value = row.so_bh || "";
    document.getElementById("edit_sdt").value = row.sdt || "";
    document.getElementById("edit_tk_nh").value = row.tk_nh || "";
    document.getElementById("edit_email").value = row.email || "";
    document.getElementById("edit_nhom_mau").value = row.nhom_mau || "";
    document.getElementById("edit_dia_chi").value = row.dia_chi || "";

    new bootstrap.Modal(document.getElementById("editGVModal")).show();
  }

  async function submitGVUpdate() {
    const data = {
      ten_tk: document.getElementById("edit_ten_tk").value,
      ma_gv: document.getElementById("edit_ma_gv").value,
      ho_va_ten: document.getElementById("edit_ho_va_ten").value,
      chuc_vu: document.getElementById("edit_chuc_vu").value,
      ngay_sinh: document.getElementById("edit_ngay_sinh").value,
      que_quan: document.getElementById("edit_que_quan").value,
      cccd: document.getElementById("edit_cccd").value,
      ngay_cap: document.getElementById("edit_ngay_cap").value,
      mst: document.getElementById("edit_mst").value,
      cmnd: document.getElementById("edit_cmnd").value,
      so_bh: document.getElementById("edit_so_bh").value,
      sdt: document.getElementById("edit_sdt").value,
      tk_nh: document.getElementById("edit_tk_nh").value,
      email: document.getElementById("edit_email").value,
      nhom_mau: document.getElementById("edit_nhom_mau").value,
      dia_chi: document.getElementById("edit_dia_chi").value
    };

    try {
      const res = await fetch("/api/update_gv", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await res.json();

      if (result.status === "success") {
        alert("‚úÖ D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!");

        // ƒê√≥ng modal
        const modal = bootstrap.Modal.getInstance(document.getElementById("editGVModal"));
        if (modal) modal.hide();

        // ‚úÖ Refresh b·∫£ng GV
        if (typeof loadGVData === "function") {
          loadGVData(); // G·ªçi l·∫°i API n·∫øu c√≥ h√†m loadGVData()
        } else {
          location.reload(); // N·∫øu kh√¥ng c√≥ th√¨ reload to√†n trang
        }
      } else {
        alert("‚ùå C·∫≠p nh·∫≠t th·∫•t b·∫°i: " + (result.error || "Kh√¥ng r√µ l·ªói"));
      }
    } catch (err) {
      console.error("L·ªói khi g·ª≠i request:", err);
      alert("‚ùå L·ªói k·∫øt n·ªëi ho·∫∑c x·ª≠ l√Ω d·ªØ li·ªáu!");
    }
  }

  function openEditHSModal(row) {
    document.getElementById("edit_ma_hs").value = row.ma_hs || "";
    document.getElementById("edit_ho_va_ten_hs").value = row.ho_va_ten || "";
    document.getElementById("edit_ngay_sinh").value = formatDateForInput(row.ngay_sinh);
    document.getElementById("edit_gioi_tinh").value = row.gioi_tinh || "";
    document.getElementById("edit_dan_toc").value = row.dan_toc || "";
    document.getElementById("edit_ma_dinh_danh").value = row.ma_dinh_danh || "";
    document.getElementById("edit_ho_ten_bo").value = row.ho_ten_bo || "";
    document.getElementById("edit_nghe_nghiep_bo").value = row.nghe_nghiep_bo || "";
    document.getElementById("edit_ho_ten_me").value = row.ho_ten_me || "";
    document.getElementById("edit_nghe_nghiep_me").value = row.nghe_nghiep_me || "";
    document.getElementById("edit_ho_khau").value = row.ho_khau || "";
    document.getElementById("edit_cccd_bo_me").value = row.cccd_bo_me || "";
    document.getElementById("edit_sdt_hs").value = row.sdt || "";

    new bootstrap.Modal(document.getElementById("editHSModal")).show();
  }

  async function submitHSUpdate() {
    const data = {
      ma_hs: document.getElementById("edit_ma_hs").value,
      ho_va_ten: document.getElementById("edit_ho_va_ten_hs").value,
      ngay_sinh: document.getElementById("edit_ngay_sinh").value,
      gioi_tinh: document.getElementById("edit_gioi_tinh").value,
      dan_toc: document.getElementById("edit_dan_toc").value,
      ma_dinh_danh: document.getElementById("edit_ma_dinh_danh").value,
      ho_ten_bo: document.getElementById("edit_ho_ten_bo").value,
      nghe_nghiep_bo: document.getElementById("edit_nghe_nghiep_bo").value,
      ho_ten_me: document.getElementById("edit_ho_ten_me").value,
      nghe_nghiep_me: document.getElementById("edit_nghe_nghiep_me").value,
      ho_khau: document.getElementById("edit_ho_khau").value,
      cccd_bo_me: document.getElementById("edit_cccd_bo_me").value,
      sdt: document.getElementById("edit_sdt_hs").value
    };

    const res = await fetch("/api/update_hs", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    const result = await res.json();
    if (result.status === "success") {
      alert("‚úÖ ƒê√£ c·∫≠p nh·∫≠t h·ªçc sinh!");
      const modal = bootstrap.Modal.getInstance(document.getElementById("editHSModal"));
      if (modal) modal.hide();
      if (typeof loadHSData === "function") loadHSData(); else location.reload();
    } else {
      alert("‚ùå L·ªói c·∫≠p nh·∫≠t: " + (result.error || "Kh√¥ng r√µ l·ªói"));
    }
  }
</script>
