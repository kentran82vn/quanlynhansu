<!DOCTYPE html>
<head>
<meta charset="utf-8"/>
<title>- TRƯỜNG MẦM NON HOA HƯỚNG DƯƠNG -</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        colors: {
          primary: '#0d6efd',
          secondary: '#6c757d'
        }
      }
    }
  }
</script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen p-6 transition-colors duration-300">
  
  <div class="mb-6">
    <h3 class="text-2xl font-bold text-center text-gray-900 dark:text-white">
        - 🏫 - TRƯỜNG MẦM NON HOA HƯỚNG DƯƠNG - 🏫-
    </h3>
  </div>

{% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6">
  <div class="flex flex-wrap gap-3 justify-center">
    <a class="px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" href="/users">👥 Tài Khoản</a>
    <a class="px-4 py-2 text-sm border border-blue-300 dark:border-blue-600 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors" href="/data_epa">📝 Bảng Đánh Giá</a>
    <a class="px-4 py-2 text-sm border border-cyan-300 dark:border-cyan-600 text-cyan-700 dark:text-cyan-300 rounded-lg hover:bg-cyan-50 dark:hover:bg-cyan-900/20 transition-colors" href="/epa_summary">📊 Bảng xếp hạng</a>
    <a class="px-4 py-2 text-sm border border-green-300 dark:border-green-600 text-green-700 dark:text-green-300 rounded-lg hover:bg-green-50 dark:hover:bg-green-900/20 transition-colors" href="/export-data">📤 Xuất Dữ Liệu</a>
    
    <button class="px-4 py-2 text-sm border border-blue-300 dark:border-blue-600 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors" onclick="document.getElementById('excelFileInput').click()">
      📚 Nhập Dữ Liệu
    </button>
    <input accept=".xlsx" hidden id="excelFileInput" onchange="importExcel()" type="file"/>

    {% if session['role'] == 'admin' %}
    <button class="px-4 py-2 text-sm border border-blue-300 dark:border-blue-600 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors" onclick="updateDataBase()">⏳ Cập Nhật Dữ Liệu</button>
    <button class="px-4 py-2 text-sm border border-yellow-300 dark:border-yellow-600 text-yellow-700 dark:text-yellow-300 rounded-lg hover:bg-yellow-50 dark:hover:bg-yellow-900/20 transition-colors" onclick="removeDeptData()">🗑 Xóa Dữ Liệu</button>
    {% endif %}
    
    <a class="px-4 py-2 text-sm border border-yellow-300 dark:border-yellow-600 text-yellow-700 dark:text-yellow-300 rounded-lg hover:bg-yellow-50 dark:hover:bg-yellow-900/20 transition-colors" href="/admin/questions">📝 Câu Hỏi Đánh Giá</a>
    <a class="px-4 py-2 text-sm border border-yellow-300 dark:border-yellow-600 text-yellow-700 dark:text-yellow-300 rounded-lg hover:bg-yellow-50 dark:hover:bg-yellow-900/20 transition-colors" href="/thoigianmoepa">📆 Đặt Thời Gian Đánh Giá</a>
    <a class="px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" href="/stats">📊 Thông tin</a>
    <a class="px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" href="/logs">📜 Nhật Ký</a>
  </div>
  <div class="mt-4" id="dbStructureResult"></div>
</div>

<!-- Dept select -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 mb-6">
  <div class="flex flex-wrap gap-4 items-end">
    <div>
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="deptSelect">Thông Tin</label>
      <select class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" id="deptSelect" onchange="switchDept()">
        <option value="">-- Chọn --</option>
        <option value="HS">👧 Học Sinh</option>
        <option value="GV">👩‍🏫 Giáo Viên</option>
      </select>
    </div>
    <div>
      <label class="sr-only" for="searchInput">Tìm kiếm</label>
      <input class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" id="searchInput" placeholder="🔍 Tìm kiếm..." type="text"/>
    </div>
  </div>
  
  <!-- Dynamic input fields -->
  <div class="mt-4" id="dynamicInputRow"></div>
</div>
{% endif %}

<!-- Tables -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
  <!-- Student Table -->
  <div id="table_hs" style="display: none;">
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-center">
        <thead class="bg-gray-900 text-white dark:bg-gray-700">
          <tr>
            <th class="px-4 py-3">STT</th>
            <th class="px-4 py-3">Mã HS</th>
            <th class="px-4 py-3">Họ và Tên</th>
            <th class="px-4 py-3">Ngày Sinh</th>
            <th class="px-4 py-3">Giới Tính</th>
            <th class="px-4 py-3">Dân Tộc</th>
            <th class="px-4 py-3">Mã Định Danh</th>
            <th class="px-4 py-3">Họ Tên Bố</th>
            <th class="px-4 py-3">Nghề Nghiệp Bố</th>
            <th class="px-4 py-3">Họ Tên Mẹ</th>
            <th class="px-4 py-3">Nghề Nghiệp Mẹ</th>
            <th class="px-4 py-3">Hộ Khẩu</th>
            <th class="px-4 py-3">CCCD Bố/Mẹ</th>
            <th class="px-4 py-3">SĐT</th>
            {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
            <th class="px-4 py-3">Action</th>
            {% endif %}
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
          {% for row in data_hs %}
          <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
            <td class="px-4 py-3 text-gray-900 dark:text-gray-300">{{ loop.index }}</td>
            <td class="px-4 py-3 text-gray-900 dark:text-gray-300">{{ row['ma_hs'] }}</td>
            <td class="px-4 py-3">
              {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
                <input class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded focus:ring-1 focus:ring-blue-500 dark:bg-gray-600 dark:text-white" onkeypress="saveEdit(event, this, 'Ho Va Ten', '{{ row['ma_hs'] }}', 'HS')" type="text" value="{{ row['ho_va_ten'] }}"/>
              {% else %}
                <span class="text-gray-900 dark:text-gray-300">{{ row['ho_va_ten'] }}</span>
              {% endif %}
            </td>
            <td class="px-4 py-3">
              {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
                <input class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded focus:ring-1 focus:ring-blue-500 dark:bg-gray-600 dark:text-white" onkeypress="saveEdit(event, this, 'Ngay Sinh', '{{ row['ma_hs'] }}', 'HS')" type="text" value="{{ row['ngay_sinh'].strftime('%d/%m/%Y') if row['ngay_sinh'] else '' }}"/>
              {% else %}
                <span class="text-gray-900 dark:text-gray-300">{{ row['ngay_sinh'].strftime('%d/%m/%Y') if row['ngay_sinh'] else '' }}</span>
              {% endif %}
            </td>
            <td class="px-4 py-3">
              {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
                <input class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded focus:ring-1 focus:ring-blue-500 dark:bg-gray-600 dark:text-white" onkeypress="saveEdit(event, this, 'Gioi Tinh', '{{ row['ma_hs'] }}', 'HS')" type="text" value="{{ row['gioi_tinh'] }}"/>
              {% else %}
                <span class="text-gray-900 dark:text-gray-300">{{ row['gioi_tinh'] }}</span>
              {% endif %}
            </td>
            <td class="px-4 py-3">
              {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
                <input class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded focus:ring-1 focus:ring-blue-500 dark:bg-gray-600 dark:text-white" onkeypress="saveEdit(event, this, 'Dan Toc', '{{ row['ma_hs'] }}', 'HS')" type="text" value="{{ row['dan_toc'] }}"/>
              {% else %}
                <span class="text-gray-900 dark:text-gray-300">{{ row['dan_toc'] }}</span>
              {% endif %}
            </td>
            <td class="px-4 py-3">
              {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
                <input class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded focus:ring-1 focus:ring-blue-500 dark:bg-gray-600 dark:text-white" onkeypress="saveEdit(event, this, 'Ma Dinh Danh', '{{ row['ma_hs'] }}', 'HS')" type="text" value="{{ row['ma_dinh_danh'] }}"/>
              {% else %}
                <span class="text-gray-900 dark:text-gray-300">{{ row['ma_dinh_danh'] }}</span>
              {% endif %}
            </td>
            <td class="px-4 py-3">
              {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
                <input class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded focus:ring-1 focus:ring-blue-500 dark:bg-gray-600 dark:text-white" onkeypress="saveEdit(event, this, 'Ho Ten Bo', '{{ row['ma_hs'] }}', 'HS')" type="text" value="{{ row['ho_ten_bo'] }}"/>
              {% else %}
                <span class="text-gray-900 dark:text-gray-300">{{ row['ho_ten_bo'] }}</span>
              {% endif %}
            </td>
            <td class="px-4 py-3">
              {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
                <input class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded focus:ring-1 focus:ring-blue-500 dark:bg-gray-600 dark:text-white" onkeypress="saveEdit(event, this, 'Nghe Nghiep Bo', '{{ row['ma_hs'] }}', 'HS')" type="text" value="{{ row['nghe_nghiep_bo'] }}"/>
              {% else %}
                <span class="text-gray-900 dark:text-gray-300">{{ row['nghe_nghiep_bo'] }}</span>
              {% endif %}
            </td>
            <td class="px-4 py-3">
              {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
                <input class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded focus:ring-1 focus:ring-blue-500 dark:bg-gray-600 dark:text-white" onkeypress="saveEdit(event, this, 'Ho Ten Me', '{{ row['ma_hs'] }}', 'HS')" type="text" value="{{ row['ho_ten_me'] }}"/>
              {% else %}
                <span class="text-gray-900 dark:text-gray-300">{{ row['ho_ten_me'] }}</span>
              {% endif %}
            </td>
            <td class="px-4 py-3">
              {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
                <input class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded focus:ring-1 focus:ring-blue-500 dark:bg-gray-600 dark:text-white" onkeypress="saveEdit(event, this, 'Nghe Nghiep Me', '{{ row['ma_hs'] }}', 'HS')" type="text" value="{{ row['nghe_nghiep_me'] }}"/>
              {% else %}
                <span class="text-gray-900 dark:text-gray-300">{{ row['nghe_nghiep_me'] }}</span>
              {% endif %}
            </td>
            <td class="px-4 py-3">
              {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
                <input class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded focus:ring-1 focus:ring-blue-500 dark:bg-gray-600 dark:text-white" onkeypress="saveEdit(event, this, 'Ho Khau', '{{ row['ma_hs'] }}', 'HS')" type="text" value="{{ row['ho_khau'] }}"/>
              {% else %}
                <span class="text-gray-900 dark:text-gray-300">{{ row['ho_khau'] }}</span>
              {% endif %}
            </td>
            <td class="px-4 py-3">
              {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
                <input class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded focus:ring-1 focus:ring-blue-500 dark:bg-gray-600 dark:text-white" onkeypress="saveEdit(event, this, 'Cccd Bo Me', '{{ row['ma_hs'] }}', 'HS')" type="text" value="{{ row['cccd_bo_me'] }}"/>
              {% else %}
                <span class="text-gray-900 dark:text-gray-300">{{ row['cccd_bo_me'] }}</span>
              {% endif %}
            </td>
            <td class="px-4 py-3">
              {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
                <input class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded focus:ring-1 focus:ring-blue-500 dark:bg-gray-600 dark:text-white" onkeypress="saveEdit(event, this, 'Sdt', '{{ row['ma_hs'] }}', 'HS')" type="text" value="{{ row['sdt'] }}"/>
              {% else %}
                <span class="text-gray-900 dark:text-gray-300">{{ row['sdt'] }}</span>
              {% endif %}
            </td>
            {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
            <td class="px-4 py-3">
              <div class="flex gap-2">
                <button class="px-2 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors" onclick="populateModalHS('{{ row['ma_hs'] }}', '{{ row['ho_va_ten'] }}', '{{ row['ngay_sinh'].strftime('%d/%m/%Y') if row['ngay_sinh'] else '' }}', '{{ row['gioi_tinh'] }}')">Edit</button>
                <button class="px-2 py-1 text-xs bg-red-600 hover:bg-red-700 text-white rounded transition-colors" onclick="deleteRow('HS', '{{ row['ma_hs'] }}')">Delete</button>
              </div>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Teacher Table -->
  <div id="table_gv" style="display: none;">
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-center">
        <thead class="bg-gray-900 text-white dark:bg-gray-700">
          <tr>
            <th class="px-4 py-3">STT</th>
            <th class="px-4 py-3">Mã GV</th>
            <th class="px-4 py-3">Họ và Tên</th>
            <th class="px-4 py-3">Tên TK</th>
            <th class="px-4 py-3">Chức vụ</th>
            <th class="px-4 py-3">Ngày Sinh</th>
            <th class="px-4 py-3">Quê Quán</th>
            <th class="px-4 py-3">CCCD</th>
            <th class="px-4 py-3">Ngày Cấp</th>
            <th class="px-4 py-3">MST</th>
            <th class="px-4 py-3">CMND</th>
            <th class="px-4 py-3">Số BH</th>
            <th class="px-4 py-3">SĐT</th>
            <th class="px-4 py-3">Số TK</th>
            <th class="px-4 py-3">Email</th>
            <th class="px-4 py-3">Nhóm Máu</th>
            <th class="px-4 py-3">Địa Chỉ</th>
            {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
            <th class="px-4 py-3">Action</th>
            {% endif %}
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
          {% for row in data_gv %}
          <tr class="hover:bg-gray-50 dark:hover:bg-gray-700" data-staff-id="{{ row['ma_gv'] }}">
            <td class="px-4 py-3 text-gray-900 dark:text-gray-300">{{ loop.index }}</td>
            <td class="px-4 py-3 text-gray-900 dark:text-gray-300">{{ row['ma_gv'] }}</td>
            <td class="px-4 py-3 text-gray-900 dark:text-gray-300">{{ row['ho_va_ten'] }}</td>
            <td class="px-4 py-3 text-gray-900 dark:text-gray-300">{{ row['ten_tk'] }}</td>
            <td class="px-4 py-3 text-gray-900 dark:text-gray-300">{{ row['chuc_vu'] }}</td>
            <td class="px-4 py-3 text-gray-900 dark:text-gray-300">{{ row['ngay_sinh'].strftime('%d/%m/%Y') if row['ngay_sinh'] else '' }}</td>
            <td class="px-4 py-3 text-gray-900 dark:text-gray-300">{{ row['que_quan'] }}</td>
            <td class="px-4 py-3 text-gray-900 dark:text-gray-300">{{ row['cccd'] }}</td>
            <td class="px-4 py-3 text-gray-900 dark:text-gray-300">{{ row['ngay_cap'].strftime('%d/%m/%Y') if row['ngay_cap'] else '' }}</td>
            <td class="px-4 py-3 text-gray-900 dark:text-gray-300">{{ row['mst'] }}</td>
            <td class="px-4 py-3 text-gray-900 dark:text-gray-300">{{ row['cmnd'] }}</td>
            <td class="px-4 py-3 text-gray-900 dark:text-gray-300">{{ row['so_bh'] }}</td>
            <td class="px-4 py-3 text-gray-900 dark:text-gray-300">{{ row['sdt'] }}</td>
            <td class="px-4 py-3 text-gray-900 dark:text-gray-300">{{ row['tk_nh'] }}</td>
            <td class="px-4 py-3 text-gray-900 dark:text-gray-300">{{ row['email'] }}</td>
            <td class="px-4 py-3 text-gray-900 dark:text-gray-300">{{ row['nhom_mau'] }}</td>
            <td class="px-4 py-3 text-gray-900 dark:text-gray-300">{{ row['dia_chi'] }}</td>
            {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
            <td class="px-4 py-3">
              <button class="px-2 py-1 text-xs bg-red-600 hover:bg-red-700 text-white rounded transition-colors" onclick="deleteRowGV('{{ row['ma_gv'] }}')">Delete</button>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
// Initialize dark mode
window.addEventListener('message', (event) => {
  if (event.data.type === 'darkModeToggle') {
    if (event.data.isDark) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }
});

// Initialize dark mode based on localStorage
const isDarkMode = localStorage.getItem('darkMode') === 'true';
if (isDarkMode) {
  document.documentElement.classList.add('dark');
}

// Existing JavaScript functions remain the same
let schemaByDept = {};

async function fetchSchema() {
  const res = await fetch("/api/table-schema");
  schemaByDept = await res.json();
  switchDept();
}

async function switchDept() {
  console.log("DEBUG: switchDept started");
  const dept = document.getElementById("deptSelect").value;
  const container = document.getElementById("dynamicInputRow");
  console.log(`DEBUG: Selected dept: ${dept}`);
  
  container.innerHTML = "";
  console.log("DEBUG: Container content reset");
  
  document.getElementById("table_hs").style.display = (dept === "HS") ? "block" : "none";
  document.getElementById("table_gv").style.display = (dept === "GV") ? "block" : "none";
  console.log(`DEBUG: Table HS display: ${document.getElementById("table_hs").style.display}, Table GV display: ${document.getElementById("table_gv").style.display}`);
  
  if (!dept || !schemaByDept[dept]) {
    console.log(`DEBUG: Invalid dept or schema not found for ${dept}, exiting`);
    return;
  }
  
  console.log(`DEBUG: Rendering inputs for schema: ${schemaByDept[dept]}`);
  let rowDiv = document.createElement("div");
  rowDiv.className = "flex flex-wrap gap-3 mb-4";
  
  for (let index = 0; index < schemaByDept[dept].length; index++) {
    const field = schemaByDept[dept][index];
    const label = field.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
    const colDiv = document.createElement("div");
    colDiv.className = "flex-1 min-w-0";

    colDiv.innerHTML = `
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">${label}</label>
      <input type="text" id="${field}" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="${label}">
    `;

    rowDiv.appendChild(colDiv);

    if ((index + 1) % 4 === 0) {
      container.appendChild(rowDiv);
      rowDiv = document.createElement("div");
      rowDiv.className = "flex flex-wrap gap-3 mb-4";
    }
  }

  if (rowDiv.childElementCount > 0) {
    container.appendChild(rowDiv);
  }

  const buttonRow = document.createElement("div");
  buttonRow.className = "mt-4";
  buttonRow.innerHTML = `
    <button class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors" onclick="addEmployee()">➕ Add</button>
  `;
  container.appendChild(buttonRow);
  console.log("DEBUG: Added 'Add' button row");

  console.log(`DEBUG: Fetching data for dept: ${dept}`);
  await fetchAndRenderDept(dept);
  console.log("DEBUG: switchDept completed");
}

async function fetchAndRenderDept(dept) {
  console.log(`DEBUG: fetchAndRenderDept started for dept: ${dept}`);
  try {
    const res = await fetch(`/api/employees?dept=${dept}`);
    console.log(`DEBUG: Fetch response status: ${res.status}`);
    const result = await res.json();
    const rows = result.rows || [];
    console.log(`DEBUG: Fetched ${rows.length} rows for dept: ${dept}`);
    if (dept === "HS") {
      console.log("DEBUG: Rendering HS table");
      renderTable("table_hs", rows);
    } else if (dept === "GV") {
      console.log("DEBUG: Rendering GV table");
      renderTable("table_gv", rows);
    }
  } catch (err) {
    console.error(`❌ DEBUG: Fetch failed for dept ${dept}:`, err);
  }
  console.log("DEBUG: fetchAndRenderDept completed");
}

function renderTable(tableId, rows) {
  console.log(`DEBUG: renderTable started for table: ${tableId}, rows: ${rows.length}`);
  const table = document.getElementById(tableId).querySelector("tbody");
  table.innerHTML = "";
  console.log(`DEBUG: Cleared tbody for table: ${tableId}`);
  rows.forEach((row, idx) => {
    console.log(`DEBUG: Generating row ${idx + 1} for table: ${tableId}`);
    const tr = document.createElement("tr");
    tr.className = "hover:bg-gray-50 dark:hover:bg-gray-700";
    tr.innerHTML = generateRowHtml(tableId, row, idx + 1);
    table.appendChild(tr);
  });
  console.log(`DEBUG: renderTable completed for table: ${tableId}`);
}

function generateRowHtml(tableId, row, index) {
  console.log(`DEBUG: generateRowHtml for table: ${tableId}, row index: ${index}`);
  if (tableId === "table_hs") {
    console.log(`DEBUG: Generating HS row with data: ${JSON.stringify(row)}`);
    return `
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${index}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.ma_hs || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.ho_va_ten || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${formatDate(row.ngay_sinh)}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.gioi_tinh || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.dan_toc || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.ma_dinh_danh || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.ho_ten_bo || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.nghe_nghiep_bo || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.ho_ten_me || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.nghe_nghiep_me || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.ho_khau || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.cccd_bo_me || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.sdt || ""}</td>
      <td class="px-4 py-3">
        <button class="px-2 py-1 text-xs bg-red-600 hover:bg-red-700 text-white rounded transition-colors" onclick="deleteRowHS('${row.ma_hs}')">Delete</button>
      </td>
    `;
  }
  if (tableId === "table_gv") {
    console.log(`DEBUG: Generating GV row with data: ${JSON.stringify(row)}`);
    return `
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${index}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.ma_gv || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.ho_va_ten || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.ten_tk || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.chuc_vu || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${formatDate(row.ngay_sinh)}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.que_quan || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.cccd || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${formatDate(row.ngay_cap)}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.mst || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.cmnd || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.so_bh || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.sdt || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.tk_nh || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.email || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.nhom_mau || ""}</td>
      <td class="px-4 py-3 text-gray-900 dark:text-gray-300">${row.dia_chi || ""}</td>
      <td class="px-4 py-3">
        <button class="px-2 py-1 text-xs bg-red-600 hover:bg-red-700 text-white rounded transition-colors" onclick="deleteRowGV('${row.ma_gv}')">Delete</button>
      </td>
    `;
  }
  console.log(`DEBUG: No matching tableId: ${tableId}, returning empty string`);
  return "";
}

function formatDate(dateStr) {
  if (!dateStr || isNaN(new Date(dateStr))) return "";
  const d = new Date(dateStr);
  return d.getDate().toString().padStart(2, '0') + "/" +
         (d.getMonth() + 1).toString().padStart(2, '0') + "/" +
         d.getFullYear();
}

async function addEmployee() {
  const dept = document.getElementById("deptSelect").value;
  if (!dept || !schemaByDept[dept]) {
    alert("Please select a department.");
    return;
  }
  const data = { "Dept": dept };
  schemaByDept[dept].forEach(field => {
    const key = field.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
    let value = document.getElementById(field)?.value?.trim() || "";
    data[key] = value;
  });

  if (dept === "HS" && (!data["Ma Hs"] || !data["Ho Va Ten"])) {
    alert("Mã HS và Họ và Tên là bắt buộc.");
    return;
  }
  const res = await fetch("/add", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
  const result = await res.json();
  if (result.status === "ok") {
    window.location.href = "/employees";
  } else {
    alert("❌ Failed to add employee: " + (result.message || ""));
  }
}

async function deleteRowHS(identifier_code) {
  if (!confirm(`Xóa học sinh Mã Định Danh: ${identifier_code}?`)) return;
  await deleteRow("HS", identifier_code);
}

async function deleteRowGV(staff_id) {
  if (!confirm(`Xóa giáo viên Staff ID: ${staff_id}?`)) return;
  await deleteRow("GV", staff_id);
}

async function deleteRow(dept, id) {
  const res = await fetch("/delete", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ staff_id: id, dept: dept })
  });
  const result = await res.json();
  if (result.status === "ok") {
    alert("✅ Xóa thành công!");
    await fetchAndRenderDept(dept);
  } else {
    alert("❌ Xóa thất bại: " + (result.reason || ""));
  }
}

async function importExcel() {
  console.log("importExcel() called");
  const dept = document.getElementById("deptSelect").value;
  const input = document.getElementById('excelFileInput');
  const file = input.files[0];
  if (!file) {
    console.log("⚠️ No file selected");
    return;
  }
  if (!dept) {
    alert("⚠️ Bạn chưa chọn Dept.");
    return;
  }
  const formData = new FormData();
  formData.append('file', file);
  let endpoint = "";
  switch (dept) {
    case "HS":
      endpoint = "/import_hs";
      break;
    case "GV":
      endpoint = "/import_gv";
      break;
    default:
      alert(`⚠️ Dept ${dept} chưa hỗ trợ import.`);
      return;
  }
  console.log(`Uploading file to: ${endpoint}`);
  try {
    const res = await fetch(endpoint, {
      method: "POST",
      body: formData
    });
    const result = await res.json();
    if (result.status === "success") {
      alert("✅ Import thành công!");
      window.location.reload();
    } else {
      alert("❌ Import lỗi: " + (result.error || ""));
    }
  } catch (err) {
    console.error(err);
    alert("❌ Có lỗi xảy ra khi upload file.");
  }
}

function removeDeptData() {
  const deptSelect = document.getElementById("deptSelect");
  const dept = deptSelect.value;

  if (!dept) return alert("Please select a Dept first.");
  if (!confirm(`Are you sure to remove all data from ${dept}?`)) return;
  if (!confirm(`This action cannot be undone. Are you really sure?`)) return;

  fetch(`/remove-dept-data`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ dept }),
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    const currentDept = dept;
    window.location.reload();
  })
  .catch(err => alert("Error: " + err));
}

function updateDataBase() {
  fetch("/update-database", { method: "POST" })
    .then(response => response.json())
    .then(data => {
      const container = document.getElementById("dbStructureResult");
      if (data.success) {
        let html = `<div class="mt-4 overflow-x-auto"><table class="w-full text-sm border border-gray-300 dark:border-gray-600"><thead class="bg-gray-100 dark:bg-gray-700"><tr>
          <th class="px-4 py-2 text-left border-b border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white">Tên bảng</th>
          <th class="px-4 py-2 text-left border-b border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white">Tên các cột</th>
          <th class="px-4 py-2 text-left border-b border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white">Số lượng cột</th>
          <th class="px-4 py-2 text-left border-b border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white">Số lượng dòng</th>
        </tr></thead><tbody>`;
        data.tables.forEach(row => {
          html += `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
            <td class="px-4 py-2 border-b border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-300">${row.table_name}</td>
            <td class="px-4 py-2 border-b border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-300">${row.column_names}</td>
            <td class="px-4 py-2 border-b border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-300">${row.column_count}</td>
            <td class="px-4 py-2 border-b border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-300">${row.row_count}</td>
          </tr>`;
        });
        html += "</tbody></table></div>";
        container.innerHTML = html;
      } else {
        container.innerHTML = `<div class="mt-4 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-red-800 dark:text-red-200">${data.message}</div>`;
      }
    })
    .catch(error => {
      document.getElementById("dbStructureResult").innerHTML = `<div class="mt-4 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-red-800 dark:text-red-200">Lỗi kết nối máy chủ.</div>`;
      console.error("❌ Update DB error:", error);
    });
}

// Search functionality
document.getElementById('searchInput').addEventListener('input', function() {
  const q = this.value.trim().toLowerCase();
  const tbody = document.getElementById('table_hs').style.display === 'block'
    ? document.querySelector('#table_hs tbody')
    : document.getElementById('table_gv').style.display === 'block'
      ? document.querySelector('#table_gv tbody')
      : null;
  if (!tbody) return;

  tbody.querySelectorAll('tr').forEach(tr => {
    const nameTd = tr.querySelector('td:nth-child(3)');
    const name = nameTd ? nameTd.innerText.toLowerCase() : '';
    tr.style.display = name.includes(q) ? '' : 'none';
  });
});

window.addEventListener("DOMContentLoaded", async () => {
  await fetchSchema();
  const lastFile = localStorage.getItem('lastImportedFile');
  if (lastFile) {
    if (lastFile.includes("hocsinh")) {
      document.getElementById("deptSelect").value = "HS";
    } else if (lastFile.includes("giaovien")) {
      document.getElementById("deptSelect").value = "GV";
    }
    await switchDept();
    localStorage.removeItem('lastImportedFile');
  }
});
</script>

</body>
</html>