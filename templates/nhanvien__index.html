<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üë• Qu·∫£n L√Ω Nh√¢n S·ª± - Tr∆∞·ªùng M·∫ßm Non Hoa H∆∞·ªõng D∆∞∆°ng</title>
  
  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link href="{{ url_for('static_files', filename='css/modern.css') }}" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Inter', var(--font-family-sans);
      background: var(--bg-secondary);
      padding: var(--spacing-lg);
    }
    
    .page-header {
      background: var(--bg-primary);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200);
    }
    
    .page-title {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }
    
    .page-title h1 {
      font-size: var(--text-3xl);
      font-weight: var(--font-bold);
      color: var(--text-primary);
      margin: 0;
    }
    
    .page-title .icon {
      font-size: var(--text-4xl);
      color: var(--primary-color);
    }
    
    .action-bar {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-md);
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--spacing-lg);
    }
    
    .action-group {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
    }
    
    .controls-section {
      background: var(--bg-primary);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200);
    }
    
    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--spacing-lg);
      align-items: end;
    }
    
    .form-group {
      margin-bottom: 0;
    }
    
    .data-section {
      background: var(--bg-primary);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200);
      overflow: hidden;
    }
    
    .section-header {
      padding: var(--spacing-lg);
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .section-title {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--text-primary);
      margin: 0;
    }
    
    .table-wrapper {
      overflow-x: auto;
      max-height: 70vh;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--text-sm);
      margin: 0;
      table-layout: auto;
    }
    
    .data-table th {
      background: var(--primary-color);
      color: white;
      padding: var(--spacing-md);
      text-align: left;
      font-weight: var(--font-semibold);
      border-bottom: 1px solid var(--primary-dark);
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
      min-width: 150px;
    }
    
    .data-table td {
      padding: var(--spacing-md);
      border-bottom: 1px solid var(--gray-200);
      vertical-align: middle;
      word-wrap: break-word;
      white-space: normal;
      min-width: 150px;
      max-width: none;
      overflow: visible;
      text-overflow: clip;
      text-align: left !important;
    }
    
    .data-table tbody tr:hover {
      background: var(--gray-50);
    }
    
    .data-table tbody tr:nth-child(even) {
      background: var(--gray-25, #fafafa);
    }
    
    .data-table tbody tr:nth-child(even):hover {
      background: var(--gray-50);
    }
    
    .inline-edit {
      border: none;
      background: transparent;
      width: 100%;
      padding: 0;
      font-size: inherit;
      border-radius: var(--border-radius-sm);
      transition: all var(--transition-fast);
    }
    
    .inline-edit:focus {
      background: var(--bg-primary);
      border: 1px solid var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }
    
    .action-buttons {
      display: flex;
      gap: var(--spacing-xs);
    }
    
    .btn-action {
      padding: var(--spacing-xs) var(--spacing-sm);
      font-size: var(--text-xs);
      border-radius: var(--border-radius-sm);
      border: none;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
    }
    
    .btn-edit {
      background: var(--warning-color);
      color: white;
    }
    
    .btn-edit:hover {
      background: #c2410c;
    }
    
    .btn-delete {
      background: var(--error-color);
      color: white;
    }
    
    .btn-delete:hover {
      background: #b91c1c;
    }
    
    .empty-state {
      text-align: center;
      padding: var(--spacing-2xl);
      color: var(--text-tertiary);
    }
    
    .empty-state i {
      font-size: 4rem;
      margin-bottom: var(--spacing-lg);
      color: var(--gray-300);
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-xs) var(--spacing-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      border-radius: var(--border-radius-sm);
      line-height: 1;
    }
    
    .badge-department {
      background: var(--info-color);
      color: white;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
    }
    
    .stat-card {
      background: var(--bg-primary);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-lg);
      border: 1px solid var(--gray-200);
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-normal);
    }
    
    .stat-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    
    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--border-radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xl);
      margin-bottom: var(--spacing-md);
    }
    
    .stat-icon.students {
      background: #dbeafe;
      color: var(--primary-color);
    }
    
    .stat-icon.teachers {
      background: #d1fae5;
      color: var(--success-color);
    }
    
    .stat-value {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
    }
    
    .stat-label {
      font-size: var(--text-sm);
      color: var(--text-tertiary);
    }
    
    /* Loading States */
    .loading {
      position: relative;
      pointer-events: none;
      opacity: 0.6;
    }
    
    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 20px;
      border: 2px solid var(--gray-300);
      border-top: 2px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      body {
        padding: var(--spacing-md);
      }
      
      .page-header {
        padding: var(--spacing-lg);
      }
      
      .action-bar {
        flex-direction: column;
        align-items: stretch;
      }
      
      .controls-grid {
        grid-template-columns: 1fr;
      }
      
      .data-table th,
      .data-table td {
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: var(--text-xs);
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
    
    /* Hide sections initially */
    .department-section {
      display: none;
    }
    
    .department-section.active {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* TƒÉng ƒë·ªô r·ªông cho c√°c c·ªôt c·ª• th·ªÉ */
    .data-table td:nth-child(3), /* H·ªç v√† t√™n */
    .data-table td:nth-child(8), /* H·ªç t√™n b·ªë */
    .data-table td:nth-child(10), /* H·ªç t√™n m·∫π */
    .data-table td:nth-child(12), /* H·ªô kh·∫©u */
    .data-table td:nth-child(13) { /* CCCD B·ªë/M·∫π */
      min-width: 200px;
      max-width: none;
      white-space: normal;
      word-wrap: break-word;
    }

    .data-table td:nth-child(14) { /* SƒêT */
      min-width: 120px;
      max-width: none;
    }
  </style>
</head>

<body>
  <!-- Page Header -->
  <div class="page-header">
    <div class="page-title">
      <i class="fas fa-users icon"></i>
      <div>
        <h1>Qu·∫£n L√Ω Nh√¢n S·ª±</h1>
        <p style="margin: 0; color: var(--text-tertiary); font-size: var(--text-sm);">
          Tr∆∞·ªùng M·∫ßm Non Hoa H∆∞·ªõng D∆∞∆°ng
        </p>
      </div>
    </div>
    
    <!-- Action Bar -->
    {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
    <div class="action-bar">
      <div class="action-group">
        <a href="/users" class="btn btn-outline-primary">
          <i class="fas fa-users-cog"></i>
          T√†i Kho·∫£n
        </a>
        <a href="/data_epa" class="btn btn-outline-success">
          <i class="fas fa-chart-line"></i>
          ƒê√°nh Gi√° EPA
        </a>
        <a href="/epa_summary" class="btn btn-outline-info">
          <i class="fas fa-trophy"></i>
          X·∫øp H·∫°ng
        </a>
        <a href="/export-data" class="btn btn-outline-secondary">
          <i class="fas fa-download"></i>
          Xu·∫•t D·ªØ Li·ªáu
        </a>
      </div>
      
      <div class="action-group">
        <button class="btn btn-primary" onclick="document.getElementById('excelFileInput').click()">
          <i class="fas fa-upload"></i>
          Nh·∫≠p Excel
        </button>
        <input accept=".xlsx" hidden id="excelFileInput" onchange="importExcel()" type="file"/>
        
        {% if session['role'] == 'admin' %}
        <button class="btn btn-secondary" onclick="updateDataBase()">
          <i class="fas fa-sync"></i>
          C·∫≠p Nh·∫≠t DB
        </button>
        <button class="btn btn-danger" onclick="removeDeptData()">
          <i class="fas fa-trash"></i>
          X√≥a D·ªØ Li·ªáu
        </button>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon students">
        <i class="fas fa-graduation-cap"></i>
      </div>
      <div class="stat-value" id="studentCount">-</div>
      <div class="stat-label">H·ªçc Sinh</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon teachers">
        <i class="fas fa-chalkboard-teacher"></i>
      </div>
      <div class="stat-value" id="teacherCount">-</div>
      <div class="stat-label">Gi√°o Vi√™n</div>
    </div>
  </div>

  {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
  <!-- Controls Section -->
  <div class="controls-section">
    <div class="controls-grid">
      <div class="form-group">
        <label class="form-label" for="deptSelect">
          <i class="fas fa-filter"></i>
          Lo·∫°i D·ªØ Li·ªáu
        </label>
        <select class="form-control" id="deptSelect" onchange="switchDept()">
          <option value="">-- Ch·ªçn lo·∫°i d·ªØ li·ªáu --</option>
          <option value="HS">üëß H·ªçc Sinh</option>
          <option value="GV">üë©‚Äçüè´ Gi√°o Vi√™n</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="searchInput">
          <i class="fas fa-search"></i>
          T√¨m Ki·∫øm
        </label>
        <input 
          class="form-control" 
          id="searchInput" 
          placeholder="T√¨m ki·∫øm theo h·ªç v√† t√™n..." 
          type="text"
          oninput="performSearch()"
        />
      </div>
      
      <div class="form-group">
        <label class="form-label">&nbsp;</label>
        <button class="btn btn-success w-full" onclick="showAddForm()">
          <i class="fas fa-plus"></i>
          Th√™m M·ªõi
        </button>
      </div>
    </div>
    
    <!-- Dynamic Input Row -->
    <div id="dynamicInputRow" style="margin-top: var(--spacing-lg); display: none;">
      <!-- S·∫Ω ƒë∆∞·ª£c render ƒë·ªông b·∫±ng JavaScript -->
    </div>
  </div>
  {% endif %}

  <!-- Students Section -->
  <div class="department-section" id="section_hs">
    <div class="data-section">
      <div class="section-header">
        <h3 class="section-title">
          <i class="fas fa-graduation-cap"></i>
          Danh S√°ch H·ªçc Sinh
        </h3>
        <span class="badge badge-department">
          <i class="fas fa-users"></i>
          <span id="hsCount">0</span> h·ªçc sinh
        </span>
      </div>
      
      <div class="table-wrapper">
        <table class="data-table" id="table_hs">
          <thead>
            <tr>
              <th>STT</th>
              <th>M√£ HS</th>
              <th>H·ªç v√† T√™n</th>
              <th>Ng√†y Sinh</th>
              <th>Gi·ªõi T√≠nh</th>
              <th>D√¢n T·ªôc</th>
              <th>M√£ ƒê·ªãnh Danh</th>
              <th>H·ªç T√™n B·ªë</th>
              <th>Ngh·ªÅ Nghi·ªáp B·ªë</th>
              <th>H·ªç T√™n M·∫π</th>
              <th>Ngh·ªÅ Nghi·ªáp M·∫π</th>
              <th>H·ªô Kh·∫©u</th>
              <th>CCCD B·ªë/M·∫π</th>
              <th>SƒêT</th>
              {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
              <th>H√†nh ƒê·ªông</th>
              {% endif %}
            </tr>
          </thead>
          <tbody id="hsTableBody">
            <tr>
              <td colspan="15" class="empty-state">
                <i class="fas fa-search"></i>
                <div>Ch·ªçn "H·ªçc Sinh" ƒë·ªÉ xem d·ªØ li·ªáu</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Teachers Section -->
  <div class="department-section" id="section_gv">
    <div class="data-section">
      <div class="section-header">
        <h3 class="section-title">
          <i class="fas fa-chalkboard-teacher"></i>
          Danh S√°ch Gi√°o Vi√™n
        </h3>
        <span class="badge badge-department">
          <i class="fas fa-users"></i>
          <span id="gvCount">0</span> gi√°o vi√™n
        </span>
      </div>
      
      <div class="table-wrapper">
        <table class="data-table" id="table_gv">
          <thead>
            <tr>
              <th>STT</th>
              <th>M√£ GV</th>
              <th>H·ªç v√† T√™n</th>
              <th>T√™n TK</th>
              <th>Ch·ª©c V·ª•</th>
              <th>Ng√†y Sinh</th>
              <th>Qu√™ Qu√°n</th>
              <th>CCCD</th>
              <th>Ng√†y C·∫•p</th>
              <th>MST</th>
              <th>CMND</th>
              <th>S·ªë BH</th>
              <th>SƒêT</th>
              <th>TK NH</th>
              <th>Email</th>
              <th>Nh√≥m M√°u</th>
              <th>ƒê·ªãa Ch·ªâ</th>
              {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
              <th>H√†nh ƒê·ªông</th>
              {% endif %}
            </tr>
          </thead>
          <tbody id="gvTableBody">
            <tr>
              <td colspan="18" class="empty-state">
                <i class="fas fa-search"></i>
                <div>Ch·ªçn "Gi√°o Vi√™n" ƒë·ªÉ xem d·ªØ li·ªáu</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Database Structure Result -->
  <div id="dbStructureResult" style="margin-top: var(--spacing-lg);"></div>

  <script>
    // Global variables
    let currentDept = '';
    let allData = {};
    let filteredData = {};
    
    // Department switching
    function switchDept() {
      const deptSelect = document.getElementById('deptSelect');
      const selectedDept = deptSelect.value;
      
      // Hide all sections
      document.querySelectorAll('.department-section').forEach(section => {
        section.classList.remove('active');
      });
      
      if (selectedDept) {
        currentDept = selectedDept;
        
        // Show selected section
        const targetSection = document.getElementById(`section_${selectedDept.toLowerCase()}`);
        if (targetSection) {
          targetSection.classList.add('active');
        }
        
        // Load data for selected department
        loadDepartmentData(selectedDept);
        
        // Show dynamic input row for adding new records
        {% if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' %}
        showDynamicInputs(selectedDept);
        {% endif %}
      } else {
        currentDept = '';
        document.getElementById('dynamicInputRow').style.display = 'none';
      }
    }
    
    // Load department data
    async function loadDepartmentData(dept) {
      try {
        const tableBody = document.getElementById(`${dept.toLowerCase()}TableBody`);
        tableBody.innerHTML = '<tr><td colspan="20" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
        
        const endpoint = dept === 'HS' ? '/fetch_hs' : '/fetch_gv';
        const response = await fetch(endpoint);
        const data = await response.json();
        
        if (data.rows && data.rows.length > 0) {
          allData[dept] = data.rows;
          filteredData[dept] = data.rows;
          renderTable(dept, data.rows);
          updateStats();
        } else {
          tableBody.innerHTML = `
            <tr>
              <td colspan="20" class="empty-state">
                <i class="fas fa-inbox"></i>
                <div>Kh√¥ng c√≥ d·ªØ li·ªáu ${dept === 'HS' ? 'h·ªçc sinh' : 'gi√°o vi√™n'}</div>
              </td>
            </tr>
          `;
        }
      } catch (error) {
        console.error('Error loading data:', error);
        const tableBody = document.getElementById(`${dept.toLowerCase()}TableBody`);
        tableBody.innerHTML = `
          <tr>
            <td colspan="20" class="empty-state" style="color: var(--error-color);">
              <i class="fas fa-exclamation-triangle"></i>
              <div>L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}</div>
            </td>
          </tr>
        `;
      }
    }
    
    // Render table with data
    function renderTable(dept, data) {
      const tableBody = document.getElementById(`${dept.toLowerCase()}TableBody`);
      const canEdit = {{ 'true' if session['role'] == 'admin' or session['user'] == 'kimnhung' or session['user'] == 'ngocquy' else 'false' }};
      
      // Format date - remove GMT timezone info
      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleDateString('vi-VN');
      };
      
      if (!data || data.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="20" class="empty-state">
              <i class="fas fa-search"></i>
              <div>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>
            </td>
          </tr>
        `;
        return;
      }
      
      let html = '';
      data.forEach((row, index) => {
        html += '<tr>';
        html += `<td>${index + 1}</td>`;
        
        if (dept === 'HS') {
          html += `<td>${row.ma_hs || ''}</td>`;
          html += `<td title="${row.ho_va_ten || ''}">${canEdit ? `<input class="inline-edit" value="${row.ho_va_ten || ''}" onkeypress="saveEdit(event, this, 'Ho Va Ten', '${row.ma_hs}', 'HS')" />` : (row.ho_va_ten || '')}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${formatDate(row.ngay_sinh)}" onkeypress="saveEdit(event, this, 'Ngay Sinh', '${row.ma_hs}', 'HS')" />` : formatDate(row.ngay_sinh)}</td>`;
          html += `<td>${canEdit ? `<select class="inline-edit" onchange="saveEdit(null, this, 'Gioi Tinh', '${row.ma_hs}', 'HS')"><option value="Nam" ${row.gioi_tinh === 'Nam' ? 'selected' : ''}>Nam</option><option value="Nu" ${row.gioi_tinh === 'Nu' ? 'selected' : ''}>N·ªØ</option></select>` : (row.gioi_tinh === 'Nu' ? 'N·ªØ' : row.gioi_tinh || '')}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${row.dan_toc || ''}" onkeypress="saveEdit(event, this, 'Dan Toc', '${row.ma_hs}', 'HS')" />` : (row.dan_toc || '')}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${row.ma_dinh_danh || ''}" onkeypress="saveEdit(event, this, 'Ma Dinh Danh', '${row.ma_hs}', 'HS')" />` : (row.ma_dinh_danh || '')}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${row.ho_ten_bo || ''}" onkeypress="saveEdit(event, this, 'Ho Ten Bo', '${row.ma_hs}', 'HS')" />` : (row.ho_ten_bo || '')}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${row.nghe_nghiep_bo || ''}" onkeypress="saveEdit(event, this, 'Nghe Nghiep Bo', '${row.ma_hs}', 'HS')" />` : (row.nghe_nghiep_bo || '')}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${row.ho_ten_me || ''}" onkeypress="saveEdit(event, this, 'Ho Ten Me', '${row.ma_hs}', 'HS')" />` : (row.ho_ten_me || '')}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${row.nghe_nghiep_me || ''}" onkeypress="saveEdit(event, this, 'Nghe Nghiep Me', '${row.ma_hs}', 'HS')" />` : (row.nghe_nghiep_me || '')}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${row.ho_khau || ''}" onkeypress="saveEdit(event, this, 'Ho Khau', '${row.ma_hs}', 'HS')" />` : (row.ho_khau || '')}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${row.cccd_bo_me || ''}" onkeypress="saveEdit(event, this, 'Cccd Bo Me', '${row.ma_hs}', 'HS')" />` : (row.cccd_bo_me || '')}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${row.sdt || ''}" onkeypress="saveEdit(event, this, 'Sdt', '${row.ma_hs}', 'HS')" />` : (row.sdt || '')}</td>`;
        } else {
          // Teacher data
          html += `<td>${row.ma_gv || ''}</td>`;
          html += `<td title="${row.ho_va_ten || ''}">${canEdit ? `<input class="inline-edit" value="${row.ho_va_ten || ''}" onkeypress="saveEdit(event, this, 'Ho Va Ten', '${row.ma_gv}', 'GV')" />` : (row.ho_va_ten || '')}</td>`;
          html += `<td>${row.ten_tk || ''}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${row.chuc_vu || ''}" onkeypress="saveEdit(event, this, 'Chuc Vu', '${row.ma_gv}', 'GV')" />` : (row.chuc_vu || '')}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${formatDate(row.ngay_sinh)}" onkeypress="saveEdit(event, this, 'Ngay Sinh', '${row.ma_gv}', 'GV')" />` : formatDate(row.ngay_sinh)}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${row.que_quan || ''}" onkeypress="saveEdit(event, this, 'Que Quan', '${row.ma_gv}', 'GV')" />` : (row.que_quan || '')}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${row.cccd || ''}" onkeypress="saveEdit(event, this, 'Cccd', '${row.ma_gv}', 'GV')" />` : (row.cccd || '')}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${formatDate(row.ngay_cap)}" onkeypress="saveEdit(event, this, 'Ngay Cap', '${row.ma_gv}', 'GV')" />` : formatDate(row.ngay_cap)}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${row.mst || ''}" onkeypress="saveEdit(event, this, 'Mst', '${row.ma_gv}', 'GV')" />` : (row.mst || '')}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${row.cmnd || ''}" onkeypress="saveEdit(event, this, 'Cmnd', '${row.ma_gv}', 'GV')" />` : (row.cmnd || '')}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${row.so_bh || ''}" onkeypress="saveEdit(event, this, 'So Bh', '${row.ma_gv}', 'GV')" />` : (row.so_bh || '')}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${row.sdt || ''}" onkeypress="saveEdit(event, this, 'Sdt', '${row.ma_gv}', 'GV')" />` : (row.sdt || '')}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${row.tk_nh || ''}" onkeypress="saveEdit(event, this, 'Tk Nh', '${row.ma_gv}', 'GV')" />` : (row.tk_nh || '')}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${row.email || ''}" onkeypress="saveEdit(event, this, 'Email', '${row.ma_gv}', 'GV')" />` : (row.email || '')}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${row.nhom_mau || ''}" onkeypress="saveEdit(event, this, 'Nhom Mau', '${row.ma_gv}', 'GV')" />` : (row.nhom_mau || '')}</td>`;
          html += `<td>${canEdit ? `<input class="inline-edit" value="${row.dia_chi || ''}" onkeypress="saveEdit(event, this, 'Dia Chi', '${row.ma_gv}', 'GV')" />` : (row.dia_chi || '')}</td>`;
        }
        
        if (canEdit) {
          html += `<td>
            <div class="action-buttons">
              <button class="btn-action btn-delete" onclick="deleteRecord('${dept === 'HS' ? row.ma_hs : row.ma_gv}', '${dept}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>`;
        }
        
        html += '</tr>';
      });
      
      tableBody.innerHTML = html;
      
      // Update count badge
      const countElement = document.getElementById(`${dept.toLowerCase()}Count`);
      if (countElement) {
        countElement.textContent = data.length;
      }
    }
    
    // Search functionality - search only in name column
    function performSearch() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      if (!currentDept || !allData[currentDept]) return;
      
      if (!searchTerm) {
        filteredData[currentDept] = allData[currentDept];
      } else {
        filteredData[currentDept] = allData[currentDept].filter(row => {
          // Search only in the name column (ho_va_ten)
          const name = String(row.ho_va_ten || '').toLowerCase();
          return name.includes(searchTerm);
        });
      }
      
      renderTable(currentDept, filteredData[currentDept]);
    }
    
    // Update statistics
    function updateStats() {
      const studentCount = allData.HS ? allData.HS.length : 0;
      const teacherCount = allData.GV ? allData.GV.length : 0;
      
      document.getElementById('studentCount').textContent = studentCount;
      document.getElementById('teacherCount').textContent = teacherCount;
    }
    
    // Save edit functionality
    async function saveEdit(event, element, field, id, dept) {
      if (event && event.key !== 'Enter') return;
      
      const value = element.value;
      
      try {
        const response = await fetch('/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            Dept: dept,
            id: id,
            data: { [field]: value }
          })
        });
        
        const result = await response.json();
        
        if (result.status === 'ok') {
          element.style.background = '#d4edda';
          setTimeout(() => {
            element.style.background = '';
          }, 1000);
          
          // Update local data
          if (allData[dept]) {
            const record = allData[dept].find(r => 
              r[dept === 'HS' ? 'ma_hs' : 'ma_gv'] === id
            );
            if (record) {
              const fieldKey = field.toLowerCase().replace(/ /g, '_');
              record[fieldKey] = value;
            }
          }
        } else {
          element.style.background = '#f8d7da';
          alert('L·ªói c·∫≠p nh·∫≠t: ' + (result.reason || 'Unknown error'));
        }
      } catch (error) {
        element.style.background = '#f8d7da';
        alert('L·ªói k·∫øt n·ªëi: ' + error.message);
      }
    }
    
    // Delete record
    async function deleteRecord(id, dept) {
      if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ${dept === 'HS' ? 'h·ªçc sinh' : 'gi√°o vi√™n'} n√†y?`)) {
        return;
      }
      
      try {
        const response = await fetch('/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            staff_id: id,
            dept: dept
          })
        });
        
        const result = await response.json();
        
        if (result.status === 'ok') {
          // Remove from local data
          if (allData[dept]) {
            allData[dept] = allData[dept].filter(r => 
              r[dept === 'HS' ? 'ma_hs' : 'ma_gv'] !== id
            );
            filteredData[dept] = allData[dept];
          }
          
          // Re-render table
          renderTable(dept, filteredData[dept]);
          updateStats();
          
          alert('X√≥a th√†nh c√¥ng!');
        } else {
          alert('L·ªói x√≥a: ' + (result.reason || 'Unknown error'));
        }
      } catch (error) {
        alert('L·ªói k·∫øt n·ªëi: ' + error.message);
      }
    }
    
    // Show dynamic inputs for adding new records
    function showDynamicInputs(dept) {
      const dynamicRow = document.getElementById('dynamicInputRow');
      
      let html = '<div style="border-top: 1px solid var(--gray-200); padding-top: var(--spacing-lg);"><h5 style="margin-bottom: var(--spacing-md); color: var(--text-primary);">Th√™m m·ªõi ' + (dept === 'HS' ? 'h·ªçc sinh' : 'gi√°o vi√™n') + '</h5>';
      html += '<div class="row g-2">';
      
      if (dept === 'HS') {
        html += `
          <div class="col-md-3"><input class="form-control" id="new_ma_hs" placeholder="M√£ HS" /></div>
          <div class="col-md-3"><input class="form-control" id="new_ho_va_ten" placeholder="H·ªç v√† t√™n" /></div>
          <div class="col-md-3"><input class="form-control" id="new_ngay_sinh" placeholder="Ng√†y sinh (DD/MM/YYYY)" /></div>
          <div class="col-md-3">
            <select class="form-control" id="new_gioi_tinh">
              <option value="">Gi·ªõi t√≠nh</option>
              <option value="Nam">Nam</option>
              <option value="Nu">N·ªØ</option>
            </select>
          </div>
          <div class="col-md-3"><input class="form-control" id="new_dan_toc" placeholder="D√¢n t·ªôc" /></div>
          <div class="col-md-3"><input class="form-control" id="new_ma_dinh_danh" placeholder="M√£ ƒë·ªãnh danh" /></div>
          <div class="col-md-3"><input class="form-control" id="new_ho_ten_bo" placeholder="H·ªç t√™n b·ªë" /></div>
          <div class="col-md-3"><input class="form-control" id="new_nghe_nghiep_bo" placeholder="Ngh·ªÅ nghi·ªáp b·ªë" /></div>
          <div class="col-md-3"><input class="form-control" id="new_ho_ten_me" placeholder="H·ªç t√™n m·∫π" /></div>
          <div class="col-md-3"><input class="form-control" id="new_nghe_nghiep_me" placeholder="Ngh·ªÅ nghi·ªáp m·∫π" /></div>
          <div class="col-md-3"><input class="form-control" id="new_ho_khau" placeholder="H·ªô kh·∫©u" /></div>
          <div class="col-md-3"><input class="form-control" id="new_cccd_bo_me" placeholder="CCCD b·ªë/m·∫π" /></div>
          <div class="col-md-3"><input class="form-control" id="new_sdt" placeholder="SƒêT" /></div>
        `;
      } else {
        html += `
          <div class="col-md-3"><input class="form-control" id="new_ma_gv" placeholder="M√£ GV" /></div>
          <div class="col-md-3"><input class="form-control" id="new_ho_va_ten" placeholder="H·ªç v√† t√™n" /></div>
          <div class="col-md-3"><input class="form-control" id="new_ten_tk" placeholder="T√™n TK" /></div>
          <div class="col-md-3"><input class="form-control" id="new_chuc_vu" placeholder="Ch·ª©c v·ª•" /></div>
          <div class="col-md-3"><input class="form-control" id="new_ngay_sinh" placeholder="Ng√†y sinh (DD/MM/YYYY)" /></div>
          <div class="col-md-3"><input class="form-control" id="new_que_quan" placeholder="Qu√™ qu√°n" /></div>
          <div class="col-md-3"><input class="form-control" id="new_cccd" placeholder="CCCD" /></div>
          <div class="col-md-3"><input class="form-control" id="new_ngay_cap" placeholder="Ng√†y c·∫•p (DD/MM/YYYY)" /></div>
          <div class="col-md-3"><input class="form-control" id="new_mst" placeholder="MST" /></div>
          <div class="col-md-3"><input class="form-control" id="new_cmnd" placeholder="CMND" /></div>
          <div class="col-md-3"><input class="form-control" id="new_so_bh" placeholder="S·ªë BH" /></div>
          <div class="col-md-3"><input class="form-control" id="new_sdt" placeholder="SƒêT" /></div>
          <div class="col-md-3"><input class="form-control" id="new_tk_nh" placeholder="TK NH" /></div>
          <div class="col-md-3"><input class="form-control" id="new_email" placeholder="Email" /></div>
          <div class="col-md-3"><input class="form-control" id="new_nhom_mau" placeholder="Nh√≥m m√°u" /></div>
          <div class="col-md-3"><input class="form-control" id="new_dia_chi" placeholder="ƒê·ªãa ch·ªâ" /></div>
        `;
      }
      
      html += '<div class="col-12" style="margin-top: var(--spacing-md);"><button class="btn btn-success" onclick="addNewRecord(\'' + dept + '\')"><i class="fas fa-plus"></i> Th√™m m·ªõi</button></div>';
      html += '</div></div>';
      
      dynamicRow.innerHTML = html;
      dynamicRow.style.display = 'block';
    }
    
    // Add new record
    async function addNewRecord(dept) {
      const data = {};
      const prefix = 'new_';
      
      // Collect form data
      const inputs = document.querySelectorAll('#dynamicInputRow input, #dynamicInputRow select');
      inputs.forEach(input => {
        const fieldName = input.id.replace(prefix, '');
        const camelCase = fieldName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        data[camelCase] = input.value;
      });
      
      // Set department
      data.Dept = dept;
      
      try {
        const response = await fetch('/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.status === 'ok') {
          alert('Th√™m m·ªõi th√†nh c√¥ng!');
          
          // Clear form
          inputs.forEach(input => input.value = '');
          
          // Reload data
          loadDepartmentData(dept);
        } else {
          alert('L·ªói th√™m m·ªõi: ' + (result.message || 'Unknown error'));
        }
      } catch (error) {
        alert('L·ªói k·∫øt n·ªëi: ' + error.message);
      }
    }
    
    // Other functions (importExcel, updateDataBase, removeDeptData)
    async function importExcel() {
      const fileInput = document.getElementById('excelFileInput');
      if (!fileInput.files[0]) return;
      
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      
      try {
        const response = await fetch('/import-data', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('Import th√†nh c√¥ng!');
          if (currentDept) {
            loadDepartmentData(currentDept);
          }
        } else {
          alert('L·ªói import: ' + (result.message || 'Unknown error'));
        }
      } catch (error) {
        alert('L·ªói k·∫øt n·ªëi: ' + error.message);
      }
      
      fileInput.value = '';
    }
    
    async function updateDataBase() {
      if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën c·∫≠p nh·∫≠t database?')) return;
      
      try {
        const response = await fetch('/update-database', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('C·∫≠p nh·∫≠t database th√†nh c√¥ng!');
          
          // Show database structure
          let html = '<div class="mt-3"><h5>C·∫•u tr√∫c Database:</h5><div class="table-responsive"><table class="table table-sm table-bordered">';
          html += '<thead><tr><th>B·∫£ng</th><th>S·ªë c·ªôt</th><th>S·ªë d√≤ng</th></tr></thead><tbody>';
          
          result.tables.forEach(table => {
            html += `<tr><td>${table.table_name}</td><td>${table.column_count}</td><td>${table.row_count}</td></tr>`;
          });
          
          html += '</tbody></table></div></div>';
          
          document.getElementById('dbStructureResult').innerHTML = html;
        } else {
          alert('L·ªói c·∫≠p nh·∫≠t: ' + (result.message || 'Unknown error'));
        }
      } catch (error) {
        alert('L·ªói k·∫øt n·ªëi: ' + error.message);
      }
    }
    
    async function removeDeptData() {
      const dept = prompt('Nh·∫≠p lo·∫°i d·ªØ li·ªáu c·∫ßn x√≥a (GV ho·∫∑c HS):');
      if (!dept || !['GV', 'HS'].includes(dept.toUpperCase())) {
        alert('Lo·∫°i d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá!');
        return;
      }
      
      if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a T·∫§T C·∫¢ d·ªØ li·ªáu ${dept}? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) {
        return;
      }
      
      try {
        const response = await fetch('/remove-dept-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dept: dept.toUpperCase() })
        });
        
        const result = await response.json();
        alert(result.message);
        
        if (currentDept) {
          loadDepartmentData(currentDept);
        }
      } catch (error) {
        alert('L·ªói k·∫øt n·ªëi: ' + error.message);
      }
    }
    
    // Show add form
    function showAddForm() {
      if (!currentDept) {
        alert('Vui l√≤ng ch·ªçn lo·∫°i d·ªØ li·ªáu tr∆∞·ªõc!');
        return;
      }
      
      // Scroll to dynamic input row
      document.getElementById('dynamicInputRow').scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
      });
    }
    
    // Import Excel function
    async function importExcel() {
      const fileInput = document.getElementById('excelFileInput');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('Vui l√≤ng ch·ªçn file Excel!');
        return;
      }
      
      if (!currentDept) {
        alert('Vui l√≤ng ch·ªçn lo·∫°i d·ªØ li·ªáu (HS ho·∫∑c GV) tr∆∞·ªõc khi import!');
        return;
      }
      
      // Validate file type
      const allowedTypes = [
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.ms-excel'
      ];
      
      if (!allowedTypes.includes(file.type)) {
        alert('Ch·ªâ ch·∫•p nh·∫≠n file Excel (.xlsx, .xls)!');
        return;
      }
      
      // Create FormData
      const formData = new FormData();
      formData.append('file', file);
      
      // Determine endpoint based on department
      const endpoint = currentDept === 'HS' ? '/import_hs' : '/import_gv';
      
      try {
        // Show loading state
        const importBtn = document.querySelector('button[onclick="document.getElementById(\'excelFileInput\').click()"]');
        const originalText = importBtn.innerHTML;
        importBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang import...';
        importBtn.disabled = true;
        
        const response = await fetch(endpoint, {
          method: 'POST',
          body: formData
        });
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          // If not JSON, try to get text content for error diagnosis
          const text = await response.text();
          console.error('Non-JSON response:', text);
          throw new Error('Server tr·∫£ v·ªÅ ƒë·ªãnh d·∫°ng kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra log server.');
        }
        
        const result = await response.json();
        
        if (response.ok && result.status === 'success') {
          alert('Import th√†nh c√¥ng!');
          
          // Reset file input
          fileInput.value = '';
          
          // Reload data for current department
          if (currentDept) {
            await loadDepartmentData(currentDept);
          }
          
          // Update stats
          updateStats();
        } else {
          throw new Error(result.error || result.message || 'Import th·∫•t b·∫°i');
        }
        
      } catch (error) {
        console.error('Import error:', error);
        
        // More specific error messages
        if (error.message.includes('fetch')) {
          alert('L·ªói k·∫øt n·ªëi server. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.');
        } else if (error.message.includes('JSON')) {
          alert('L·ªói ƒë·ªãnh d·∫°ng d·ªØ li·ªáu t·ª´ server. Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã vi√™n.');
        } else {
          alert('L·ªói import: ' + error.message);
        }
      } finally {
        // Restore button state
        const importBtn = document.querySelector('button[onclick="document.getElementById(\'excelFileInput\').click()"]');
        importBtn.innerHTML = '<i class="fas fa-upload"></i> Nh·∫≠p Excel';
        importBtn.disabled = false;
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      // Load initial stats
      updateStats();
    });
  </script>
</body>
</html>