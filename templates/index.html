<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>- üè´ TR∆Ø·ªúNG M·∫¶M NON HOA H∆Ø·ªöNG D∆Ø∆†NG üéà-</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        colors: {
          primary: '#0d6efd',
          secondary: '#6c757d'
        }
      }
    }
  }
</script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
<div class="min-h-screen flex">
  <!-- Sidebar -->
  <nav class="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 hidden md:block">
    <div class="p-4">
      <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">üè´ TR∆Ø·ªúNG M·∫¶M NON HOA H∆Ø·ªöNG D∆Ø∆†NG üéà</h2>
      <!-- Dark Mode Toggle -->
      <button id="darkModeToggle" class="mb-4 px-3 py-2 text-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
        <i class="fas fa-moon dark:hidden"></i>
        <i class="fas fa-sun hidden dark:inline"></i>
        <span class="ml-2 dark:hidden">Dark Mode</span>
        <span class="ml-2 hidden dark:inline">Light Mode</span>
      </button>
    </div>
    <div class="px-2">
      <ul class="space-y-1">
        <li>
          <a class="nav-link flex items-center gap-3 px-3 py-2 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" data-page="/employees" href="#">
            <i class="fas fa-users w-5"></i>
            <span>Trang Ch√≠nh</span>
          </a>
        </li>
        {% if session['role'] == 'user' or session['role'] == 'supervisor' %}
        <li>
          <a class="nav-link flex items-center gap-3 px-3 py-2 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" data-page="/user-epa-score" href="#">
            <i class="fas fa-chart-line w-5"></i>
            <span>ƒê√°nh Gi√° EPA</span>
          </a>
        </li>
        {% endif %}
        {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
        <li>
          <a class="nav-link flex items-center gap-3 px-3 py-2 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" data-page="/users" href="#">
            <i class="fas fa-user-shield w-5"></i>
            <span>Qu·∫£n L√Ω T√†i Kho·∫£n</span>
          </a>
        </li>
        <li>
          <a class="nav-link flex items-center gap-3 px-3 py-2 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" data-page="/classes" href="#">
            <i class="fas fa-school w-5"></i>
            <span>Danh S√°ch L·ªõp</span>
          </a>
        </li>
        <li>
          <a class="nav-link flex items-center gap-3 px-3 py-2 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" data-page="/assign-classes" href="#">
            <i class="fas fa-user-plus w-5"></i>
            <span>Ph√¢n L·ªõp H·ªçc Sinh</span>
          </a>
        </li>
        <li>
          <a class="nav-link flex items-center gap-3 px-3 py-2 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" data-page="/assign-teachers" href="#">
            <i class="fas fa-chalkboard-teacher w-5"></i>
            <span>Ph√¢n C√¥ng Gi√°o Vi√™n</span>
          </a>
        </li>
        <li>
          <a class="nav-link flex items-center gap-3 px-3 py-2 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" data-page="/data_epa" href="#">
            <i class="fas fa-chart-line w-5"></i>
            <span>ƒê√°nh Gi√° Gi√°o Vi√™n</span>
          </a>
        </li>
        <li>
          <a class="nav-link flex items-center gap-3 px-3 py-2 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" data-page="/epa_summary" href="#">
            <i class="fas fa-chart-line w-5"></i>
            <span>X·∫øp H·∫°ng ƒê√°nh Gi√°</span>
          </a>
        </li>
        <li>
          <a class="nav-link flex items-center gap-3 px-3 py-2 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" data-page="/thoigianmoepa" href="#">
            <i class="fas fa-scroll w-5"></i>
            <span>ƒê·∫∑t Th·ªùi Gian ƒê√°nh Gi√°</span>
          </a>
        </li>
        <li>
          <a class="nav-link flex items-center gap-3 px-3 py-2 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" data-page="/admin/questions" href="#">
            <i class="fas fa-scroll w-5"></i>
            <span>C√¢u H·ªèi ƒê√°nh Gi√°</span>
          </a>
        </li>
        <li>
          <a class="nav-link flex items-center gap-3 px-3 py-2 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" data-page="/logs" href="#">
            <i class="fas fa-scroll w-5"></i>
            <span>Nh·∫≠t K√Ω Thay ƒê·ªïi</span>
          </a>
        </li>
        <li>
          <a class="nav-link flex items-center gap-3 px-3 py-2 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" data-page="/stats" href="#">
            <i class="fas fa-chart-bar w-5"></i>
            <span>Th√¥ng Tin Th·ªëng K√™</span>
          </a>
        </li>
        {% endif %}

        <li class="mt-8">
          <a class="flex items-center gap-3 px-3 py-2 text-red-600 dark:text-red-400 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors" href="/logout">
            <i class="fas fa-sign-out-alt w-5"></i>
            <span>ƒêƒÉng Xu·∫•t</span>
          </a>
        </li>
      </ul>
    </div>
  </nav>
  <!-- Main Content -->
  <main class="flex-1 flex flex-col">
    <!-- Top Bar -->
    <div class="h-14 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 flex items-center justify-between">
      <h5 class="text-lg font-semibold text-gray-800 dark:text-white">- TR∆Ø·ªúNG M·∫¶M NON HOA H∆Ø·ªöNG D∆Ø∆†NG -</h5>
      <div class="flex items-center gap-3">
        <a class="px-3 py-1 text-sm border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" href="/dashboard">
          üè† Trang Ch·ªß
        </a>
        <button class="px-3 py-1 text-sm border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" onclick="openChangePassModal()">
          üîê ƒê·ªïi M·∫≠t Kh·∫©u
        </button>
        <div class="text-sm font-medium text-gray-700 dark:text-gray-300">
          üë§ <span id="currentUser">{{ user }} ({{ role }})</span>
        </div>
      </div>
    </div>
    <!-- Content Frame -->
    <iframe id="mainFrame" src="/employees" class="flex-1 w-full border-0"></iframe>
  </main>
</div>
</div>
<!-- Modal ƒë·ªïi m·∫≠t kh·∫©u -->
<div id="changePassModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
    <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
      <h5 class="text-lg font-semibold text-gray-900 dark:text-white">ƒê·ªïi M·∫≠t Kh·∫©u</h5>
      <button onclick="closeChangePassModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="p-4">
      <form id="changePassForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
          <input class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" id="oldPassword" required type="password"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">M·∫≠t kh·∫©u m·ªõi</label>
          <input class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" id="newPassword" required type="password"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
          <input class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" id="confirmNewPassword" required type="password"/>
        </div>
      </form>
    </div>
    <div class="flex gap-3 p-4 border-t border-gray-200 dark:border-gray-700">
      <button onclick="closeChangePassModal()" class="px-4 py-2 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">H·ªßy</button>
      <button onclick="submitChangePassword()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">ƒê·ªïi M·∫≠t Kh·∫©u</button>
    </div>
  </div>
</div>
<script>
    // ‚úÖ L·∫•y URL parameter ƒë·ªÉ x√°c ƒë·ªãnh trang hi·ªán t·∫°i
    function getPageFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get('page') || '/employees'; // M·∫∑c ƒë·ªãnh l√† employees
    }

    // ‚úÖ C·∫≠p nh·∫≠t URL khi chuy·ªÉn trang
    function updateURL(page) {
        const newURL = `/dashboard?page=${encodeURIComponent(page)}`;
        window.history.pushState({page: page}, '', newURL);
    }

    // ‚úÖ T·∫°o URL an to√†n cho iframe - s·ª≠ d·ª•ng relative URL ƒë·ªÉ tr√°nh mixed content
    function createSafeURL(page) {
        // Remove trailing slash n·∫øu c√≥
        const cleanPage = page.endsWith('/') ? page.slice(0, -1) : page;
        
        // S·ª≠ d·ª•ng relative URL thay v√¨ absolute URL ƒë·ªÉ tr√°nh mixed content issues
        console.log('üîó Creating relative URL:', cleanPage); // Debug log
        return cleanPage;
    }

    // ‚úÖ Load trang v√† c·∫≠p nh·∫≠t active state  
    function loadPage(page) {
        const safeURL = createSafeURL(page);
        
        // C·∫≠p nh·∫≠t iframe
        document.getElementById('mainFrame').src = safeURL;
        
        // C·∫≠p nh·∫≠t active state cho sidebar
        document.querySelectorAll('.nav-link').forEach(l => {
            l.classList.remove('bg-blue-600', 'text-white', 'dark:bg-blue-700');
            l.classList.add('text-gray-700', 'dark:text-gray-300', 'hover:bg-blue-50', 'dark:hover:bg-gray-700', 'hover:text-blue-600', 'dark:hover:text-blue-400');
        });
        const activeLink = document.querySelector(`[data-page="${page}"]`);
        if (activeLink) {
            activeLink.classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:bg-blue-50', 'dark:hover:bg-gray-700', 'hover:text-blue-600', 'dark:hover:text-blue-400');
            activeLink.classList.add('bg-blue-600', 'text-white', 'dark:bg-blue-700');
        }
        
        // C·∫≠p nh·∫≠t URL
        updateURL(page);
    }

    // ‚úÖ X·ª≠ l√Ω click navigation
    document.querySelectorAll('.nav-link[data-page]').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const page = this.getAttribute('data-page');
            console.log('üñ±Ô∏è Navigation click:', page); // Debug log
            loadPage(page);
        });
    });

    // ‚úÖ X·ª≠ l√Ω browser back/forward
    window.addEventListener('popstate', function(e) {
        const page = e.state?.page || getPageFromURL();
        console.log('‚¨ÖÔ∏è Browser back/forward:', page); // Debug log
        
        const safeURL = createSafeURL(page);
        document.getElementById('mainFrame').src = safeURL;
        
        // C·∫≠p nh·∫≠t active state
        document.querySelectorAll('.nav-link').forEach(l => {
            l.classList.remove('bg-blue-600', 'text-white', 'dark:bg-blue-700');
            l.classList.add('text-gray-700', 'dark:text-gray-300', 'hover:bg-blue-50', 'dark:hover:bg-gray-700', 'hover:text-blue-600', 'dark:hover:text-blue-400');
        });
        const activeLink = document.querySelector(`[data-page="${page}"]`);
        if (activeLink) {
            activeLink.classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:bg-blue-50', 'dark:hover:bg-gray-700', 'hover:text-blue-600', 'dark:hover:text-blue-400');
            activeLink.classList.add('bg-blue-600', 'text-white', 'dark:bg-blue-700');
        }
    });

    // ‚úÖ Kh·ªüi t·∫°o khi trang load
    document.addEventListener('DOMContentLoaded', function() {
        initDarkMode();
        
        const currentPage = getPageFromURL();
        console.log('üöÄ Initial page load:', currentPage); // Debug log
        
        // Set iframe src v·ªõi URL an to√†n
        const safeURL = createSafeURL(currentPage);
        document.getElementById('mainFrame').src = safeURL;
        
        // Set active state
        const activeLink = document.querySelector(`[data-page="${currentPage}"]`);
        if (activeLink) {
            activeLink.classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:bg-blue-50', 'dark:hover:bg-gray-700', 'hover:text-blue-600', 'dark:hover:text-blue-400');
            activeLink.classList.add('bg-blue-600', 'text-white', 'dark:bg-blue-700');
        }
        
        // Ensure URL is correct
        if (!window.location.search) {
            updateURL(currentPage);
        }
    });

    // ‚úÖ Handle iframe load errors
    document.getElementById('mainFrame').addEventListener('error', function(e) {
        console.error('‚ùå Iframe load error:', e);
        // Fallback to employees page
        if (this.src !== '/employees') {
            console.log('üîÑ Fallback to employees page');
            this.src = '/employees';
        }
    });

    // Dark mode functionality
    function initDarkMode() {
        const darkModeToggle = document.getElementById('darkModeToggle');
        const isDarkMode = localStorage.getItem('darkMode') === 'true';
        
        if (isDarkMode) {
            document.documentElement.classList.add('dark');
        }
        
        darkModeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('darkMode', isDark);
            
            // Send message to iframe to sync dark mode
            const iframe = document.getElementById('mainFrame');
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({ type: 'darkModeToggle', isDark }, '*');
            }
        });
    }
    
    function openChangePassModal() {
        document.getElementById('changePassForm').reset();
        document.getElementById('changePassModal').classList.remove('hidden');
    }
    
    function closeChangePassModal() {
        document.getElementById('changePassModal').classList.add('hidden');
    }

    async function submitChangePassword() {
        const oldPass = document.getElementById('oldPassword').value.trim();
        const newPass = document.getElementById('newPassword').value.trim();
        const confirmPass = document.getElementById('confirmNewPassword').value.trim();

        if (!oldPass || !newPass || !confirmPass) {
            alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
            return;
        }

        if (newPass !== confirmPass) {
            alert("M·∫≠t kh·∫©u m·ªõi kh√¥ng tr√πng kh·ªõp!");
            return;
        }

        const payload = { old_password: oldPass, new_password: newPass };

        try {
            const res = await fetch('/change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            if (result.status === 'success') {
                alert("‚úÖ ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!");
                bootstrap.Modal.getInstance(document.getElementById('changePassModal')).hide();
            } else {
                alert("‚ùå ƒê·ªïi m·∫≠t kh·∫©u th·∫•t b·∫°i: " + (result.message || "Kh√¥ng r√µ l·ªói"));
            }
        } catch (err) {
            console.error(err);
            alert("‚ùå L·ªói k·∫øt n·ªëi server!");
        }
    }
</script>
</body>
</html>