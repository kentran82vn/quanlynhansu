<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>- üè´ TR∆Ø·ªúNG M·∫¶M NON HOA H∆Ø·ªöNG D∆Ø∆†NG üéà-</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<style>
    body {
      background-color: #f5f7fa;
    }
    .sidebar {
      background-color: #f8f9fa;
      border-right: 1px solid #dee2e6;
      min-height: 100vh;
      padding: 1rem 0;
      font-family: "Segoe UI", Arial, sans-serif;
    }
    .sidebar .nav-link {
      color: #495057;
      font-size: 14px;
      font-weight: 500;
      padding: 10px 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
    }
    .sidebar .nav-link i {
      font-size: 16px;
    }
    .sidebar .nav-link:hover {
      background-color: #e9ecef;
      color: #0d6efd;
      border-left: 3px solid #0d6efd;
      text-decoration: none;
    }
    .sidebar .nav-link.active {
      background-color: #0d6efd;
      color: white;
      border-left: 3px solid #0b5ed7;
      font-weight: 600;
    }
    .sidebar .nav-link.active i {
      color: white;
    }
    .sidebar .nav-link.text-danger {
      color: #dc3545;
    }
    .sidebar .nav-link.text-danger:hover {
      background-color: #f8d7da;
      color: #c82333;
    }
    iframe {
      width: 100%;
      height: calc(100vh - 56px);
      border: none;
    }
    .topbar {
      height: 56px;
      background: #fff;
      border-bottom: 1px solid #dee2e6;
      padding: 0 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .topbar .user-info {
      font-weight: 500;
      color: #495057;
    }
</style>
</head>
<body><div class="container-fluid mt-4"><div class="card"><div class="card-body">
<div class="container-fluid">
<div class="row">
  <nav class="col-md-2 d-none d-md-block sidebar">
      <div class="position-sticky">
        <ul class="nav flex-column">
              <li class="nav-item">
                <a class="nav-link" data-page="/employees" href="#">
                  <i class="fas fa-users"></i> Trang Ch√≠nh
                </a>
              </li>
              {% if session['role'] == 'user' or session['role'] == 'supervisor' %}
              <li class="nav-item">
                <a class="nav-link" data-page="/user-epa-score" href="#">
                  <i class="fas fa-chart-line"></i> ƒê√°nh Gi√° EPA
                </a>
              </li>
              {% endif %}
              {% if session['role'] == 'admin' or session['user'] == 'kimnhung' %}
              <li class="nav-item">
                <a class="nav-link" data-page="/users" href="#">
                  <i class="fas fa-user-shield"></i> Qu·∫£n L√Ω T√†i Kho·∫£n
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-page="/classes" href="#">
                  <i class="fas fa-school"></i> Danh S√°ch L·ªõp
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-page="/assign-classes" href="#">
                  <i class="fas fa-user-plus"></i> Ph√¢n L·ªõp H·ªçc Sinh
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-page="/assign-teachers" href="#">
                  <i class="fas fa-chalkboard-teacher"></i> Ph√¢n C√¥ng Gi√°o Vi√™n
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-page="/data_epa" href="#">
                  <i class="fas fa-chart-line"></i> ƒê√°nh Gi√° Gi√°o Vi√™n
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-page="/epa_summary" href="#">
                  <i class="fas fa-chart-line"></i> X·∫øp H·∫°ng ƒê√°nh Gi√°
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-page="/thoigianmoepa" href="#">
                  <i class="fas fa-scroll"></i> ƒê·∫∑t Th·ªùi Gian ƒê√°nh Gi√°
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-page="/admin/questions" href="#">
                  <i class="fas fa-scroll"></i> C√¢u H·ªèi ƒê√°nh Gi√°
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-page="/logs" href="#">
                  <i class="fas fa-scroll"></i> Nh·∫≠t K√Ω Thay ƒê·ªïi
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-page="/stats" href="#">
                  <i class="fas fa-chart-bar"></i> Th√¥ng Tin Th·ªëng K√™
                </a>
              </li>
              {% endif %}

              <li class="nav-item mt-4">
                <a class="nav-link text-danger" href="/logout">
                  <i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t
                </a>
              </li>
      </ul>
    </div>
  </nav>
<main class="col-md-10 ms-sm-auto px-0">
<div class="topbar">
<h5 class="mb-3">- TR∆Ø·ªúNG M·∫¶M NON HOA H∆Ø·ªöNG D∆Ø∆†NG -</h5>
<div class="user-actions d-flex align-items-center justify-content-end gap-2">
<a class="btn btn-outline-secondary btn-sm" href="/dashboard">
üè† Trang Ch·ªß
</a>
<button class="btn btn-outline-secondary btn-sm" onclick="openChangePassModal()">
üîê ƒê·ªïi M·∫≠t Kh·∫©u
</button>
<div class="user-info">
üë§ <span id="currentUser">{{ user }} ({{ role }})</span>
</div>
</div>
</div>
<iframe id="mainFrame" src="/employees"></iframe>
</main>
</div>
</div>
<!-- üîß Modal ƒë·ªïi m·∫≠t kh·∫©u user -->
<div aria-hidden="true" aria-labelledby="changePassModalLabel" class="modal fade" id="changePassModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="changePassModalLabel">ƒê·ªïi M·∫≠t Kh·∫©u</h5>
<button class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<form id="changePassForm">
<div class="mb-3">
<label>M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
<input class="form-control" id="oldPassword" required="" type="password"/>
</div>
<div class="mb-3">
<label>M·∫≠t kh·∫©u m·ªõi</label>
<input class="form-control" id="newPassword" required="" type="password"/>
</div>
<div class="mb-3">
<label>X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
<input class="form-control" id="confirmNewPassword" required="" type="password"/>
</div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
<button class="btn btn-primary" onclick="submitChangePassword()">ƒê·ªïi M·∫≠t Kh·∫©u</button>
</div>
</div>
</div>
</div>
<script>
    // ‚úÖ L·∫•y URL parameter ƒë·ªÉ x√°c ƒë·ªãnh trang hi·ªán t·∫°i
    function getPageFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get('page') || '/employees'; // M·∫∑c ƒë·ªãnh l√† employees
    }

    // ‚úÖ C·∫≠p nh·∫≠t URL khi chuy·ªÉn trang
    function updateURL(page) {
        const newURL = `/dashboard?page=${encodeURIComponent(page)}`;
        window.history.pushState({page: page}, '', newURL);
    }

    // ‚úÖ Load trang v√† c·∫≠p nh·∫≠t active state
    function loadPage(page) {
        // C·∫≠p nh·∫≠t iframe
        document.getElementById('mainFrame').src = page;
        
        // C·∫≠p nh·∫≠t active state cho sidebar
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`[data-page="${page}"]`);
        if (activeLink) activeLink.classList.add('active');
        
        // C·∫≠p nh·∫≠t URL
        updateURL(page);
    }

    // ‚úÖ X·ª≠ l√Ω click navigation
    document.querySelectorAll('.nav-link[data-page]').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const page = this.getAttribute('data-page');
            loadPage(page);
        });
    });

    // ‚úÖ X·ª≠ l√Ω browser back/forward
    window.addEventListener('popstate', function(e) {
        const page = e.state?.page || getPageFromURL();
        document.getElementById('mainFrame').src = page;
        
        // C·∫≠p nh·∫≠t active state
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`[data-page="${page}"]`);
        if (activeLink) activeLink.classList.add('active');
    });

    // ‚úÖ Kh·ªüi t·∫°o khi trang load
    document.addEventListener('DOMContentLoaded', function() {
        const currentPage = getPageFromURL();
        
        // Set iframe src
        document.getElementById('mainFrame').src = currentPage;
        
        // Set active state
        const activeLink = document.querySelector(`[data-page="${currentPage}"]`);
        if (activeLink) activeLink.classList.add('active');
        
        // Ensure URL is correct
        if (!window.location.search) {
            updateURL(currentPage);
        }
    });

    // ‚úÖ C√°c function kh√°c gi·ªØ nguy√™n
    function openChangePassModal() {
      document.getElementById('changePassForm').reset();
      const modal = new bootstrap.Modal(document.getElementById('changePassModal'));
      modal.show();
    }

    async function submitChangePassword() {
      const oldPass = document.getElementById('oldPassword').value.trim();
      const newPass = document.getElementById('newPassword').value.trim();
      const confirmPass = document.getElementById('confirmNewPassword').value.trim();

      if (!oldPass || !newPass || !confirmPass) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
        return;
      }

      if (newPass !== confirmPass) {
        alert("M·∫≠t kh·∫©u m·ªõi kh√¥ng tr√πng kh·ªõp!");
        return;
      }

      const payload = { old_password: oldPass, new_password: newPass };

      try {
        const res = await fetch('/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        if (result.status === 'success') {
          alert("‚úÖ ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!");
          bootstrap.Modal.getInstance(document.getElementById('changePassModal')).hide();
        } else {
          alert("‚ùå ƒê·ªïi m·∫≠t kh·∫©u th·∫•t b·∫°i: " + (result.message || "Kh√¥ng r√µ l·ªói"));
        }
      } catch (err) {
        console.error(err);
        alert("‚ùå L·ªói k·∫øt n·ªëi server!");
      }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</div></div></div></body>
</html>