<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìù B·∫£ng C√¢u H·ªèi ƒê√°nh Gi√° - Tr∆∞·ªùng M·∫ßm Non Hoa H∆∞·ªõng D∆∞∆°ng</title>
  
  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link href="{{ url_for('static_files', filename='css/modern.css') }}" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Inter', var(--font-family-sans);
      background: var(--bg-secondary);
    }
    
    .page-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: white;
      padding: var(--spacing-xl);
      border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
      margin-bottom: var(--spacing-lg);
    }
    
    .page-title {
      font-size: var(--text-2xl);
      font-weight: var(--font-semibold);
      margin: 0;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .page-subtitle {
      font-size: var(--text-sm);
      opacity: 0.9;
      margin-top: var(--spacing-xs);
    }
    
    .action-bar {
      background: var(--bg-primary);
      padding: var(--spacing-lg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: var(--spacing-lg);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .action-bar h3 {
      margin: 0;
      color: var(--text-primary);
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
    }
    
    .table-container {
      background: var(--bg-primary);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    
    .questions-table {
      margin: 0;
    }
    
    .questions-table th:nth-child(1) { 
      width: 8%; 
      text-align: center; 
    }
    .questions-table th:nth-child(2) { 
      width: 60%; 
    }
    .questions-table th:nth-child(3) { 
      width: 12%; 
      text-align: center; 
    }
    .questions-table th:nth-child(4) { 
      width: 20%; 
      text-align: center; 
    }
    
    .questions-table td:nth-child(1),
    .questions-table td:nth-child(3),
    .questions-table td:nth-child(4) { 
      text-align: center; 
    }
    
    .questions-table td:nth-child(2) {
      white-space: pre-line;
      word-break: break-word;
      text-overflow: initial;
      overflow: visible;
      max-width: none;
    }
    
    .score-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-xs) var(--spacing-sm);
      background: var(--primary-color);
      color: white;
      border-radius: var(--border-radius-sm);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }
    
    .action-buttons {
      display: flex;
      gap: var(--spacing-xs);
      justify-content: center;
    }
    
    .btn-action {
      padding: var(--spacing-xs) var(--spacing-sm);
      font-size: var(--text-xs);
      border-radius: var(--border-radius);
      border: none;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
    }
    
    .btn-edit {
      background: var(--warning-color);
      color: white;
    }
    
    .btn-edit:hover {
      background: #c2410c;
      transform: translateY(-1px);
    }
    
    .btn-delete {
      background: var(--error-color);
      color: white;
    }
    
    .btn-delete:hover {
      background: #b91c1c;
      transform: translateY(-1px);
    }
    
    /* Enhanced Modal Styles */
    .modal-dialog {
      max-width: 600px;
    }
    
    .modal-content {
      border: none;
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-xl);
    }
    
    .modal-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: white;
      border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
      padding: var(--spacing-lg);
    }
    
    .modal-title {
      font-weight: var(--font-semibold);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .modal-body {
      padding: var(--spacing-xl);
    }
    
    .modal-footer {
      padding: var(--spacing-lg) var(--spacing-xl);
      background: var(--bg-tertiary);
      border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
    }
    
    .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .action-bar {
        flex-direction: column;
        gap: var(--spacing-md);
        align-items: stretch;
      }
      
      .action-buttons {
        flex-direction: column;
        gap: var(--spacing-xs);
      }
      
      .btn-action {
        justify-content: center;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <h1 class="page-title">
        <i class="fas fa-question-circle"></i>
        Qu·∫£n L√Ω C√¢u H·ªèi ƒê√°nh Gi√° EPA
      </h1>
      <p class="page-subtitle">H·ªá th·ªëng qu·∫£n l√Ω c√¢u h·ªèi ƒë√°nh gi√° nh√¢n vi√™n</p>
    </div>
    
    <!-- Action Bar -->
    <div class="action-bar">
      <h3>üìù Danh S√°ch C√¢u H·ªèi ƒê√°nh Gi√°</h3>
      <div class="d-none" id="userInfo" data-user="{{ user }}" data-role="{{ role }}"></div>
      <button class="btn btn-primary" onclick="openAddModal()">
        <i class="fas fa-plus"></i>
        Th√™m C√¢u H·ªèi
      </button>
    </div>
    
    <!-- Table Container -->
    <div class="table-container">
      <div class="table-responsive">
        <table class="table questions-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>C√¢u H·ªèi</th>
              <th>ƒêi·ªÉm</th>
              <th>H√†nh ƒê·ªông</th>
            </tr>
          </thead>
          <tbody id="questionsTable"></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- Enhanced Modal -->
  <div class="modal" id="questionModal" tabindex="-1" aria-hidden="true" aria-labelledby="questionModalLabel">
    <div class="modal-dialog">
      <form class="modal-content" id="questionForm">
        <div class="modal-header">
          <h5 class="modal-title" id="questionModalLabel">
            <i class="fas fa-edit"></i>
            Th√™m/Ch·ªânh s·ª≠a C√¢u H·ªèi
          </h5>
          <button class="modal-close" type="button" onclick="closeModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <input id="questionId" type="hidden">
          
          <div class="form-group">
            <label class="form-label" for="question">
              <i class="fas fa-question-circle"></i>
              C√¢u H·ªèi
            </label>
            <textarea class="form-control" id="question" rows="3" placeholder="Nh·∫≠p n·ªôi dung c√¢u h·ªèi..." required></textarea>
          </div>
          
          <div class="form-group" id="scoreField">
            <label class="form-label" for="score">
              <i class="fas fa-star"></i>
              ƒêi·ªÉm s·ªë
            </label>
            <select class="form-control" id="score" required>
              <option value="">-- Ch·ªçn ƒëi·ªÉm s·ªë --</option>
              <option value="20">20 ƒëi·ªÉm</option>
              <option value="10">10 ƒëi·ªÉm</option>
              <option value="5">5 ƒëi·ªÉm</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" onclick="closeModal()">
            <i class="fas fa-times"></i>
            H·ªßy
          </button>
          <button class="btn btn-primary" type="submit">
            <i class="fas fa-save"></i>
            L∆∞u
          </button>
        </div>
      </form>
    </div>
  </div>
  <script>
    // Modal management
    const modal = document.getElementById('questionModal');
    const form = document.getElementById('questionForm');
    const questionTable = document.getElementById('questionsTable');
    
    // Get user info
    const userInfo = document.getElementById('userInfo');
    const currentUser = userInfo ? userInfo.getAttribute('data-user') : '';
    const currentRole = userInfo ? userInfo.getAttribute('data-role') : '';
    const canEditScore = (currentRole === 'admin' || currentUser === 'kimnhung');

    function openModal() {
      modal.classList.add('show');
    }

    function closeModal() {
      modal.classList.remove('show');
    }

    async function loadQuestions() {
      const res = await fetch('/api/cauhoi_epa');
      const data = await res.json();
      questionTable.innerHTML = '';
      data.forEach(q => {
        questionTable.innerHTML += `
          <tr>
            <td><span class="badge badge-secondary">${q.id}</span></td>
            <td>${q.question}</td>
            <td>
              <span class="score-badge">
                <i class="fas fa-star"></i>
                ${q.score ? q.score : 20} ƒëi·ªÉm
              </span>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn-action btn-edit" onclick='editQuestion(${JSON.stringify(q)})'>
                  <i class="fas fa-edit"></i>
                  S·ª≠a
                </button>
                <button class="btn-action btn-delete" onclick='deleteQuestion(${q.id})'>
                  <i class="fas fa-trash"></i>
                  X√≥a
                </button>
              </div>
            </td>
          </tr>`;
      });
    }

    function openAddModal() {
      form.reset();
      document.getElementById('questionId').value = '';
      document.getElementById('questionModalLabel').innerHTML = `
        <i class="fas fa-plus"></i>
        Th√™m C√¢u H·ªèi M·ªõi
      `;
      
      // Show/hide score field based on permissions
      const scoreField = document.getElementById('scoreField');
      if (canEditScore) {
        scoreField.style.display = 'block';
        document.getElementById('score').required = true;
      } else {
        scoreField.style.display = 'none';
        document.getElementById('score').required = false;
      }
      
      openModal();
    }

    function editQuestion(q) {
      document.getElementById('questionId').value = q.id;
      document.getElementById('question').value = q.question;
      document.getElementById('score').value = q.score ? q.score : 20;
      document.getElementById('questionModalLabel').innerHTML = `
        <i class="fas fa-edit"></i>
        Ch·ªânh S·ª≠a C√¢u H·ªèi
      `;
      
      // Show/hide score field based on permissions
      const scoreField = document.getElementById('scoreField');
      if (canEditScore) {
        scoreField.style.display = 'block';
        document.getElementById('score').required = true;
      } else {
        scoreField.style.display = 'none';
        document.getElementById('score').required = false;
      }
      
      openModal();
    }

    form.onsubmit = async (e) => {
      e.preventDefault();
      const payload = {
        id: document.getElementById('questionId').value,
        question: document.getElementById('question').value
      };
      
      // Only send score if user has permission
      if (canEditScore) {
        payload.score = parseInt(document.getElementById('score').value);
      }
      
      try {
        await fetch('/api/cauhoi_epa', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        closeModal();
        loadQuestions();
      } catch (error) {
        alert('C√≥ l·ªói x·∫£y ra khi l∆∞u c√¢u h·ªèi!');
      }
    };

    async function deleteQuestion(id) {
      if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¢u h·ªèi n√†y kh√¥ng?")) return;
      
      try {
        await fetch(`/api/cauhoi_epa/${id}`, { method: 'DELETE' });
        loadQuestions();
      } catch (error) {
        alert('C√≥ l·ªói x·∫£y ra khi x√≥a c√¢u h·ªèi!');
      }
    }

    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeModal();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeModal();
      }
    });

    // Load questions on page load
    loadQuestions();
  </script>
</body>
</html>
